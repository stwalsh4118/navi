# [38-8] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification of all PBI-38 acceptance criteria. This task creates comprehensive tests that verify the complete PR integration enhancement works correctly, from data fetching through display and interaction.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-12 09:18:16 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-12 09:46:58 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-12 09:49:46 | Status Change | InProgress | Review | E2E tests complete, all 13 ACs verified | AI_Agent |
| 2026-02-12 10:01:51 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- Verify all 13 acceptance criteria from the PBI PRD
- Test the full flow: PR data fetch → model update → view render → user interaction
- Test both local and remote session PR integration
- Test edge cases: no PR, no checks, no comments, draft PR, merged PR
- Test interaction flows: open git detail → view checks → open comments → close → return
- Verify no regression in existing git integration functionality

## Implementation Plan

1. Create test file `internal/tui/e2e_cos_38_test.go`
2. Write test helpers to create mock PR detail data with various states
3. Test scenarios:
   - **Check statuses (AC1)**: Model with PRDetail containing checks in various states; verify git detail view renders individual checks with correct icons; verify session list shows aggregate indicator
   - **Review status (AC2)**: Test approved, changes requested, and pending review states with reviewer names
   - **Comment count (AC3)**: Verify count shown in session list indicator and git detail view
   - **Comment viewer (AC4)**: Trigger comment view, verify comments render with author/timestamp/body, verify scroll navigation, verify return to git detail
   - **Mergeable status (AC5)**: Test mergeable, conflicting, and unknown states
   - **Labels (AC6)**: Test with multiple labels, no labels
   - **Draft indicator (AC7)**: Test draft PR display in both views
   - **Changed files stats (AC8)**: Verify file count, additions, deletions display
   - **Auto-refresh (AC9)**: Test ticker starts with pending checks, stops when terminal
   - **Manual refresh (AC10)**: Test `r` key triggers PR data refresh
   - **Remote session support (AC11)**: Test PR detail with remote session context
   - **No performance regression (AC12)**: Verify PR fetch is lazy (not on every poll)
   - **Existing tests pass (AC13)**: Run full test suite
4. Follow existing E2E test patterns (see `e2e_git_test.go`, `e2e_cos_31_test.go`, `e2e_cos_32_test.go`)

## Test Plan

This task IS the test plan. All tests must pass with `go test -race ./...` from the project root.

## Verification

- [ ] All 13 acceptance criteria verified by tests
- [ ] Tests pass with `-race` flag
- [ ] No regression in existing test suite
- [ ] Code quality checks pass (`go vet`, `golangci-lint`)

## Files Modified

- `internal/tui/e2e_cos_38_test.go` — New file with comprehensive E2E tests covering all 13 acceptance criteria
