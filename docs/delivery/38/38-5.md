# [38-5] Implement PR Comment Fetching

[Back to task list](./tasks.md)

## Description

Implement the data fetching logic for PR comments. Comments are fetched on-demand (not during the initial PR detail fetch) when the user opens the comment viewer. This task covers fetching both review comments (inline on code) and general issue comments via the GitHub API using the `gh api` command, and parsing them into a unified displayable format.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-12 09:18:16 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

- Define a `PRComment` struct with fields: Author, Body, CreatedAt, UpdatedAt, Type (review/general), FilePath (for review comments), Line (for review comments)
- Implement `GetPRComments(dir string, prNum int) ([]PRComment, error)` that fetches both comment types
- Implement `GetPRCommentsByRepo(owner, repo string, prNum int) ([]PRComment, error)` for remote sessions
- Fetch review comments via `gh api repos/{owner}/{repo}/pulls/{number}/comments`
- Fetch general comments via `gh api repos/{owner}/{repo}/issues/{number}/comments`
- Merge both comment lists and sort chronologically
- Parse JSON response: extract author login, body text, timestamps, file path, line number
- Handle pagination if the API returns paginated results (use `--paginate` flag)
- Handle error cases: API errors, no comments, rate limiting
- Define a TUI message type `gitPRCommentsMsg` to carry fetched comments
- Implement `fetchPRCommentsCmd` that runs the fetch asynchronously

## Implementation Plan

1. Define `PRComment` struct in `internal/git/pr.go` (or alongside other PR types)
2. Implement `GetPRComments(dir string, prNum int) ([]PRComment, error)`:
   - Extract owner/repo from `GetRemote(dir)` + `ParseGitHubRemote`
   - Call `gh api --paginate repos/{owner}/{repo}/pulls/{prNum}/comments` for review comments
   - Call `gh api --paginate repos/{owner}/{repo}/issues/{prNum}/comments` for general comments
   - Parse both JSON arrays into `[]PRComment`
   - Merge and sort by `CreatedAt`
3. Implement `GetPRCommentsByRepo` for remote sessions (accepts owner/repo directly)
4. Add `gitPRCommentsMsg` to TUI message types in `model.go`
5. Add `fetchPRCommentsCmd` in `sessions.go`
6. Add `fetchRemotePRCommentsCmd` for remote sessions

## Test Plan

- Unit test JSON parsing with sample GitHub API response for review comments
- Unit test JSON parsing with sample GitHub API response for issue comments
- Test merging and chronological sorting of mixed comment types
- Test with empty comment lists (no comments)
- Test error handling: gh api failure, malformed JSON
- Test `PRComment` struct fields are populated correctly (author, body, timestamps, file path, line)
- Verify remote session variant works with owner/repo parameters

## Verification

- [ ] Review comments fetched and parsed correctly
- [ ] General comments fetched and parsed correctly
- [ ] Comments merged and sorted chronologically
- [ ] Remote session support works
- [ ] Error cases handled gracefully
- [ ] Code quality checks pass
- [ ] Tests pass

## Files Modified

<To be filled during implementation>
