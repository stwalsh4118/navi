# [38-7] Add Auto-Refresh for Pending Checks

[Back to task list](./tasks.md)

## Description

Implement automatic periodic refresh of PR detail data when the git detail view is open and CI/CD checks are in a non-terminal state (pending, in_progress, queued). This ensures users see check results update in real-time without manually pressing refresh. The ticker starts when the git detail view is opened with pending checks and stops when all checks reach a terminal state or the view is closed.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-12 09:18:16 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

- Define a constant for the auto-refresh interval (30 seconds)
- When the git detail view opens and `PRDetail` has pending checks, start a ticker
- On each tick, re-fetch PR detail data and update the display
- Stop the ticker when:
  - All checks reach a terminal state (success, failure, cancelled, etc.)
  - The git detail view is closed
  - The user navigates away from the session
- Show a subtle "Auto-refreshing..." indicator in the git detail view when the ticker is active
- Manual refresh (`r` key) should also reset the ticker interval
- Do not interfere with the existing git info polling cycle
- Handle edge cases: PR deleted while viewing, network errors during refresh

## Implementation Plan

1. Define `PRAutoRefreshInterval` constant (30 seconds)
2. Add `prAutoRefreshActive bool` and ticker-related state to the model
3. Define a `prAutoRefreshTickMsg` message type
4. Implement `prAutoRefreshTickCmd()` that returns a tick after the interval
5. In the git detail view open handler:
   - Check if `PRDetail.CheckSummary.Pending > 0`
   - If yes, set `prAutoRefreshActive = true` and start the tick chain
6. In the `prAutoRefreshTickMsg` handler:
   - If view is still open and auto-refresh is active, dispatch `fetchPRCmd`
   - Chain the next tick
7. When PR detail is refreshed (via `gitPRMsg` handler):
   - Check if all checks are now terminal
   - If yes, set `prAutoRefreshActive = false` (stop ticking)
8. When git detail view is closed:
   - Set `prAutoRefreshActive = false`
9. When manual refresh (`r`) is pressed:
   - Fetch immediately
   - Reset the tick chain (so next auto-refresh is 30s from now)
10. Add "Auto-refreshing..." indicator to the git detail view render

## Test Plan

- Test that auto-refresh starts when git detail opens with pending checks
- Test that auto-refresh does not start when all checks are terminal
- Test that auto-refresh stops when all checks become terminal
- Test that auto-refresh stops when git detail view is closed
- Test that manual refresh resets the tick interval
- Test that the auto-refresh indicator appears when active
- Test that the ticker does not fire when auto-refresh is inactive
- Verify no interference with existing git polling

## Verification

- [ ] Auto-refresh activates when checks are pending
- [ ] Auto-refresh deactivates when checks complete
- [ ] Auto-refresh deactivates when view is closed
- [ ] Manual refresh resets the timer
- [ ] "Auto-refreshing..." indicator displayed correctly
- [ ] No interference with existing git polling
- [ ] Code quality checks pass
- [ ] Tests pass

## Files Modified

<To be filled during implementation>
