# [38-2] Implement PR Detail Fetching and JSON Parsing

[Back to task list](./tasks.md)

## Description

Implement the core data fetching logic that retrieves extended PR metadata from the GitHub CLI. This replaces the existing simple `GetPRNumber` call with a richer `GetPRDetail` function that fetches all PR metadata in a single `gh pr view --json` invocation. Support both local directory-based and remote repository-based fetching patterns (matching the existing `GetPRNumber` / `GetPRNumberByRepo` split).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-12 09:18:16 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

- Implement `GetPRDetail(dir string) *PRDetail` that calls `gh pr view --json` with all required fields
- Implement `GetPRDetailByRepo(branch, remoteURL string) *PRDetail` for remote sessions
- Parse the JSON response into the `PRDetail` struct defined in 38-1
- Compute `CheckSummary` from the raw `statusCheckRollup` data
- Determine aggregate `ReviewStatus` from the `reviewDecision` field
- Parse `labels` array into string slice
- Handle error cases gracefully: gh CLI not installed, not authenticated, no PR for branch, API errors
- Maintain backward compatibility: existing `GetPRNumber` callers should continue to work (or be migrated)
- Update the TUI message types to carry `PRDetail` instead of just `prNum`
- Update `fetchPRCmd` and `fetchRemotePRCmd` to use the new functions
- Cache `PRDetail` in the `git.Info` struct with `FetchedAt` timestamp

## Implementation Plan

1. Define the JSON field list constant for the `gh pr view --json` call
2. Implement `GetPRDetail(dir string) *PRDetail`:
   - Execute `gh pr view --json <fields>`
   - Parse JSON into an intermediate map or struct
   - Map `statusCheckRollup` entries to `[]Check` and compute `CheckSummary`
   - Map `reviews` to `[]Reviewer`
   - Map `labels` to `[]string`
   - Set `FetchedAt` timestamp
3. Implement `GetPRDetailByRepo(branch, remoteURL string) *PRDetail`:
   - Same logic but uses `-R owner/repo` flag
   - Reuse `ParseGitHubRemote` for repo extraction
4. Update `gitPRMsg` in `model.go` to carry `*PRDetail` instead of `int`
5. Update `fetchPRCmd` and `fetchRemotePRCmd` in `sessions.go` to call the new functions
6. Update the message handler in `Update` to store `PRDetail` in the git info cache
7. Ensure `PRNum` field in `Info` is still populated from `PRDetail.Number` for backward compat

## Test Plan

- Unit test `GetPRDetail` with mocked `gh` CLI output (test JSON parsing)
- Test parsing of check statuses: all passing, some failing, some pending, no checks
- Test parsing of review states: approved, changes requested, review pending, no reviewers
- Test parsing with labels, without labels
- Test error cases: gh not found, no PR for branch, malformed JSON
- Test `GetPRDetailByRepo` with mocked output
- Test `CheckSummary` computation from raw check data
- Verify backward compatibility: `PRNum` still populated correctly

## Verification

- [ ] `GetPRDetail` returns correct data for a real PR (manual test)
- [ ] `GetPRDetailByRepo` works for remote sessions
- [ ] JSON parsing handles all field types correctly
- [ ] Error cases return nil without panicking
- [ ] Existing PR number display still works
- [ ] Code quality checks pass
- [ ] Tests pass

## Files Modified

<To be filled during implementation>
