# [12-5] Extend hook script for metrics capture

[Back to task list](./tasks.md)

## Description

Update the notify.sh hook script to capture and persist all available metrics data based on the research findings from task 12-4. This includes token counts (if available), tool usage tracking, and enhanced time metrics.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-05 16:25:14 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-05 16:37:56 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-05 16:39:06 | Status Change | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2026-02-05 18:31:18 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- Capture token counts from environment if available (per task 12-4 findings)
- Track tool usage by accumulating counts per tool type
- Maintain a list of recent tools (rolling window)
- Preserve all metrics across status updates (read-modify-write pattern)
- Update hooks/config.json if new hook types are needed

## Implementation Plan

1. Review findings from task 12-4 for available data
2. Implement read-modify-write pattern in notify.sh:
   - Read existing session JSON
   - Extract current metrics
   - Update with new data
   - Write merged result
3. Add token tracking (if environment provides data):
   ```bash
   INPUT_TOKENS="${CLAUDE_INPUT_TOKENS:-0}"
   OUTPUT_TOKENS="${CLAUDE_OUTPUT_TOKENS:-0}"
   # Accumulate with existing totals
   ```
4. Add tool tracking:
   - Parse tool name from environment or arguments
   - Increment count for tool type
   - Add to recent tools list (keep last N)
5. Install jq dependency note in documentation if not already present
6. Update hooks/config.json if adding new hook handlers

**External Packages**: This task requires jq for JSON parsing in bash.

## Test Plan

**Medium complexity - test data accumulation:**

- Verify metrics accumulate correctly across multiple hook calls
- Test read-modify-write doesn't lose data
- Test handling of missing/corrupted session files
- Verify recent tools list maintains correct size

## Verification

- [ ] notify.sh implements read-modify-write for metrics
- [ ] Token tracking implemented (if available per 12-4)
- [ ] Tool counts accumulate correctly
- [ ] Recent tools list maintained
- [ ] Code quality checks pass
- [ ] Manual testing confirms accumulation

## Implementation Notes

Based on task 12-4 research findings:
- **Token tracking**: NOT implemented - token counts are not available through hooks
- **Tool tracking**: Implemented via PostToolUse hook with tool-tracker.sh script
- Tool counts accumulate correctly across multiple tool uses
- Recent tools list maintains rolling window of last 10 tools

## Files Modified

- `hooks/tool-tracker.sh` - Created new script for PostToolUse hook to track tool usage
- `hooks/config.json` - Added PostToolUse hook configuration
