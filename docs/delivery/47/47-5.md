# [47-5] Project Expansion and Responsive Layout

[Back to task list](./tasks.md)

## Description

Implement Space-to-expand for project rows (showing task breakdown, branch details, recent commits) and responsive layout behavior: proportional zone heights adapt to terminal size, briefing collapses to one line on very short terminals, PBI title truncates first on narrow terminals.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-17 10:45:13 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-17 11:10:16 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-17 11:10:16 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-17 23:47:43 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Space on a project row toggles expansion (expand/collapse):
   - Expanded view shows:
     - Task breakdown: list of tasks with status badges (reuse `TaskStatusBadge()`)
     - Branch name and dirty state
     - Recent commits (from PM engine snapshot data: HEAD SHA, commits ahead)
     - PR number if present
   - Second Space press collapses the row back to single-line.
2. Track expanded state: `pmExpandedProjects map[string]bool` keyed by project directory.
3. Responsive zone heights:
   - Normal terminal: briefing ~30%, projects ~30%, events ~40%.
   - Short terminal (< 30 rows content height): briefing collapses to 1 line (just the box border + placeholder text), remaining space split 40/60 between projects and events.
   - Very short terminal (< 15 rows content height): briefing hidden entirely, projects and events split 40/60.
4. Responsive column truncation:
   - PBI title truncates first when terminal width is narrow.
   - Below 100 columns: hide last activity column.
   - Below 80 columns: hide session count, truncate project name.
5. Minimum terminal width: 80 columns. Below 80, show a "Terminal too narrow" message.

## Implementation Plan

1. Add `pmExpandedProjects map[string]bool` to Model struct.
2. Handle Space keybinding in `updatePMView()` when `pmZoneFocus == 0`.
3. In `renderPMProjects()`, check expanded state and render expanded detail below the project row.
4. Extract zone height calculation into a helper: `pmZoneHeights(contentHeight int) (briefingH, projectsH, eventsH int)`.
5. Add column width thresholds as constants.
6. Add terminal-too-narrow guard in `renderPMView()`.

## Test Plan

- Unit test: Space toggles project expansion state.
- Unit test: Expanded project row includes task breakdown and branch info.
- Unit test: `pmZoneHeights()` returns correct proportions for normal, short, and very short terminals.
- Unit test: Columns truncate/hide correctly at width thresholds.
- Unit test: Terminal below 80 columns shows "Terminal too narrow" message.

## Verification

- Implemented project expansion map state and Space toggle behavior with expanded details (task status badges, branch, commits, PR).
- Added responsive zone-height helper for normal/short/very-short terminals and terminal-width guard at 80 columns.
- Implemented responsive column behavior (PBI truncation priority, session/last-activity hiding on narrow widths).
- Added tests for expansion rendering, zone-height behavior, and narrow-terminal message.
- Verification commands:
  - `go test ./internal/tui/... -run TestPMProjectExpansionAndResponsiveLayout`
  - `go test ./...`

## Files Modified

- `internal/tui/model.go` — add `pmExpandedProjects` field
- `internal/tui/pmview.go` — expansion rendering, responsive height/width logic
