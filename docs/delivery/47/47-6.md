# [47-6] E2E CoS Test

[Back to task list](./tasks.md)

## Description

Verify all PBI-47 acceptance criteria with integration tests covering the full PM TUI view: toggle, layout, rendering, navigation, focus, and responsiveness.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-17 10:45:13 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

Verify all 9 acceptance criteria:

1. **AC1**: `P` toggles PM view on/off, mutually exclusive with the session list.
2. **AC2**: Three-zone layout renders with proportional heights (briefing ~30%, projects ~30%, events ~40%).
3. **AC3**: Zone 1 shows "No PM briefing yet" placeholder in dim text.
4. **AC4**: Zone 2 lists one row per project with columns: status icon, name, PBI ID + title, progress, session status, last activity.
5. **AC5**: Zone 2 supports cursor navigation; Enter jumps to session list filtered to that project.
6. **AC6**: Zone 3 renders events in reverse chronological order, color-coded by event type.
7. **AC7**: Zone 3 is scrollable when focused (j/k, arrow keys).
8. **AC8**: Tab moves focus between Zone 2 and Zone 3.
9. **AC9**: Layout degrades gracefully on terminals shorter than normal (briefing collapses, titles truncate).

## Implementation Plan

1. Create `internal/tui/pmview_test.go` with integration tests.
2. Build test fixtures: sample `pm.PMOutput` with realistic snapshots and events.
3. Test PM view toggle lifecycle: off → on → verify render → off.
4. Test project rendering: verify columns, sort order, cursor movement.
5. Test event rendering: verify order, color coding, scroll behavior.
6. Test focus system: Tab switching, keyboard routing.
7. Test responsive behavior: render at different terminal sizes, verify zone height changes and column truncation.

## Test Plan

### Objectives
Validate that the complete PM TUI view meets all acceptance criteria when all components work together.

### Test Scope
Integration tests exercising the full `Model` with PM view enabled, using realistic mock data.

### Environment & Setup
- Create `pm.PMOutput` fixtures with 3-5 project snapshots and 10-15 events of various types.
- Initialize `Model` with `pmEngine` and `pmOutput` set.
- Test at multiple terminal sizes: 120×40 (normal), 80×25 (compact), 80×15 (minimal).

### Key Scenarios

1. **Toggle lifecycle**: Send `P` key → verify `pmViewVisible` true → verify View() output contains zone boxes → send `P` → verify `pmViewVisible` false.
2. **Project rendering**: Verify each snapshot appears as a row with all required columns. Verify attention-priority sort order.
3. **Project navigation**: Send ↑/↓ keys → verify cursor moves. Send Enter → verify PM view closes and session filter applied.
4. **Event rendering**: Verify events appear reverse-chronological. Verify color coding per event type.
5. **Event scrolling**: Send j/k keys when events zone focused → verify scroll offset changes.
6. **Focus switching**: Send Tab → verify `pmZoneFocus` changes. Verify keyboard routing changes.
7. **Responsive layout**: Render at 120×40 → verify 3 zones. Render at 80×15 → verify briefing collapses/hides.
8. **Project expansion**: Send Space on project → verify expanded detail appears.
9. **Empty state**: Set `pmOutput` to nil → verify placeholder messages render correctly.

### Success Criteria
- All 9 acceptance criteria verified.
- `go test -race ./internal/tui/... -run TestPMView` passes.
- `go vet ./...` clean.

## Verification

_To be filled during implementation._

## Files Modified

- `internal/tui/pmview_test.go` (new) — integration tests for PM view
