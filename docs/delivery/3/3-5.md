# [3-5] Implement tick-based polling

[Back to task list](./tasks.md)

## Description

Set up the 500ms polling interval using Bubble Tea commands that trigger session refresh.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-05 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create tick command that fires every 500ms
2. On tick, call poll function and send sessions message
3. Poll function orchestrates: read, list tmux, clean stale, sort
4. Handle errors gracefully

## Implementation Plan

Implement in `sessions.go`:
```go
const pollInterval = 500 * time.Millisecond
const statusDir = "~/.claude-sessions"

func tickCmd() tea.Cmd {
    return tea.Tick(pollInterval, func(t time.Time) tea.Msg {
        return tickMsg(t)
    })
}

func pollSessions() tea.Msg {
    dir := expandPath(statusDir)

    // Get live tmux sessions
    liveSessions, _ := listTmuxSessions()

    // Clean stale sessions
    cleanStaleSessions(dir, liveSessions)

    // Read remaining sessions
    sessions, err := readSessions(dir)
    if err != nil {
        return sessionsMsg(nil)
    }

    // Sort sessions
    sortSessions(sessions)

    return sessionsMsg(sessions)
}

func expandPath(path string) string {
    if strings.HasPrefix(path, "~/") {
        home, _ := os.UserHomeDir()
        return filepath.Join(home, path[2:])
    }
    return path
}
```

Update `model.go` Update to handle tick and sessions messages.

## Test Plan

- **Objective**: Verify polling works at correct interval
- **Test Scenarios**:
  1. Tick command fires at 500ms
  2. Poll function returns sorted sessions
  3. Errors don't crash the application
- **Success Criteria**: Sessions refresh automatically

## Verification

- [ ] Tick interval is 500ms
- [ ] Tick triggers poll
- [ ] Poll orchestrates read, clean, sort
- [ ] Sessions message sent with results
- [ ] Path expansion handles ~/

## Files Modified

- `sessions.go`
- `model.go` (Update method)
