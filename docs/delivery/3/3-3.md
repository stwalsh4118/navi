# [3-3] Implement stale session cleanup

[Back to task list](./tasks.md)

## Description

Implement the logic to delete status files for tmux sessions that no longer exist.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-05 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-05 05:26:58 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-05 05:27:24 | Status Change | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2026-02-05 05:31:36 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Compare status files with live tmux sessions
2. Delete status files for sessions not in tmux list
3. Handle file deletion errors gracefully
4. Only delete if session name doesn't match any live session

## Implementation Plan

Implement in `sessions.go`:
```go
func cleanStaleSessions(dir string, liveSessions []string) error {
    liveSet := make(map[string]bool)
    for _, name := range liveSessions {
        liveSet[name] = true
    }

    entries, err := os.ReadDir(dir)
    if err != nil {
        return nil // directory doesn't exist, nothing to clean
    }

    for _, entry := range entries {
        if !strings.HasSuffix(entry.Name(), ".json") {
            continue
        }

        // Extract session name from filename (remove .json)
        sessionName := strings.TrimSuffix(entry.Name(), ".json")

        if !liveSet[sessionName] {
            path := filepath.Join(dir, entry.Name())
            os.Remove(path) // ignore errors
        }
    }
    return nil
}
```

## Test Plan

- **Objective**: Verify stale sessions are cleaned up
- **Test Scenarios**:
  1. Status file exists, tmux session exists - file kept
  2. Status file exists, tmux session gone - file deleted
  3. File deletion fails - no crash, continues
- **Success Criteria**: Only stale files are deleted

## Verification

- [x] Compares status files to live sessions
- [x] Deletes files for non-existent sessions
- [x] Keeps files for existing sessions
- [x] Handles deletion errors gracefully

## Files Modified

- `sessions.go`
