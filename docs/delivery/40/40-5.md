# [40-5] E2E CoS verification

[Back to task list](./tasks.md)

## Description

Verify all PBI-40 acceptance criteria end-to-end. This task covers comprehensive testing across all implementation tasks to ensure the complete OpenCode status integration pipeline works correctly.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-15 19:24:55 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-15 19:37:39 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-15 20:20:04 | Status Change | InProgress | Review | E2E verification complete, internal AI review passed | AI_Agent |
| 2026-02-15 21:29:29 | Status Change | Review | InProgress | Significant update: add regression tests for Claude/OpenCode coexistence | AI_Agent |
| 2026-02-15 21:32:26 | Status Change | InProgress | Review | Regression tests added, internal AI review passed | AI_Agent |
| 2026-02-15 21:54:22 | Status Change | Review | InProgress | Significant update: address PR review feedback on plugin write efficiency | AI_Agent |
| 2026-02-15 21:57:37 | Status Change | InProgress | Review | PR feedback fixes implemented, internal AI review passed | AI_Agent |

## Requirements

Verify each PBI-40 acceptance criterion:

1. **AC-1**: OpenCode plugin exists and writes status updates on lifecycle events
2. **AC-2**: The `agents` map in status JSON correctly reflects OpenCode's current status
3. **AC-3**: `session.Info` struct includes `Agents map[string]ExternalAgent` and is populated from JSON
4. **AC-4**: `notify.sh` preserves the `agents` field (does not clobber OpenCode data)
5. **AC-5**: Install script deploys the OpenCode plugin to `~/.config/opencode/plugins/`
6. **AC-6**: Existing Claude Code hook behavior is completely unaffected
7. **AC-7**: All existing tests continue to pass
8. **AC-8**: New unit tests cover agent field parsing and multi-agent status file reading

## Implementation Plan

1. Run full test suite: `go test -race ./...` — verify AC-7
2. Review new unit tests cover data model parsing — verify AC-8
3. Create a test status file with both Claude Code and OpenCode data, verify `ReadStatusFiles` populates `Agents` correctly — verify AC-3
4. Write a status file with `agents.opencode`, run `notify.sh`, verify agents preserved — verify AC-4
5. Inspect plugin file at `plugins/opencode/navi.js`, verify event hooks and status mapping — verify AC-1, AC-2
6. Inspect `install.sh`, verify OpenCode plugin deployment section — verify AC-5
7. Run existing Claude Code hook tests/scenarios, verify no regressions — verify AC-6

## Test Plan

### Objectives
Validate the complete pipeline from data model through hook preservation to plugin correctness.

### Key Scenarios

1. **Go test suite green**: `go test -race ./...` passes with zero failures
2. **Data model round-trip**: JSON with `agents` field unmarshals into `session.Info` correctly, and `Agents` is nil when absent
3. **notify.sh preservation**: Simulated hook fire doesn't clobber `agents` field
4. **Plugin structure**: Plugin exports correct hook functions with proper status mappings
5. **Install script**: Plugin deployment section present and correct
6. **No regressions**: `go vet ./...` clean, existing test assertions unchanged

### Success Criteria
- All existing tests pass
- New tests pass
- No `go vet` warnings
- Plugin file is well-formed JavaScript
- Install script deploys plugin correctly

## Verification

- **AC-1 / AC-2 (plugin exists + status mapping)**
  - Command:
    ```bash
    HOME="$(mktemp -d)" node --input-type=module - <<'NODE'
    import assert from 'node:assert/strict'
    import { readFile } from 'node:fs/promises'
    import path from 'node:path'
    import os from 'node:os'

    const { NaviPlugin } = await import('./plugins/opencode/navi.js')
    const plugin = await NaviPlugin({
      $: async () => ({ stdout: 'unknown\n' }),
    })

    await plugin['session.created']()
    await plugin['permission.asked']()

    const statusPath = path.join(os.homedir(), '.claude-sessions', 'unknown.json')
    const parsed = JSON.parse(await readFile(statusPath, 'utf8'))

    assert.equal(parsed.agents.opencode.status, 'permission')
    assert.equal(typeof parsed.agents.opencode.timestamp, 'number')

    console.log('plugin AC check passed')
    NODE
    ```
  - Checks: imports `plugins/opencode/navi.js`, invokes `session.created` and `permission.asked`, validates `~/.claude-sessions/unknown.json` contains `agents.opencode.status == "permission"` and numeric timestamp
  - Result: `plugin AC check passed`
- **AC-3 (session model + JSON population)**
  - Command: `go test ./internal/session -run 'TestExternalAgentJSONBehavior|TestReadStatusFiles/reads_agents_map_from_status_file'`
  - Checks: `Info.Agents` round-trip behavior and `ReadStatusFiles` parsing of multi-agent JSON
  - Result: `ok github.com/stwalsh4118/navi/internal/session`
- **AC-4 (notify.sh preserves agents)**
  - Command:
    ```bash
    python3 - <<'PY'
    import json
    import os
    import subprocess
    import tempfile
    from pathlib import Path

    repo = Path('/home/sean/workspace/navi')
    script = repo / 'hooks' / 'notify.sh'

    with tempfile.TemporaryDirectory() as td:
        home = Path(td)
        status_dir = home / '.claude-sessions'
        status_dir.mkdir(parents=True, exist_ok=True)
        session_file = status_dir / 'unknown.json'
        session_file.write_text(json.dumps({
            'tmux_session': 'unknown',
            'status': 'idle',
            'message': 'claude data',
            'cwd': '/tmp',
            'timestamp': 1,
            'agents': {'opencode': {'status': 'working', 'timestamp': 10}}
        }), encoding='utf-8')

        env = os.environ.copy()
        env['HOME'] = str(home)
        subprocess.run(['bash', str(script), 'working'], cwd=str(repo), env=env, check=True)

        parsed = json.loads(session_file.read_text(encoding='utf-8'))
        assert parsed['message'] == 'claude data'
        assert parsed['agents']['opencode']['status'] == 'working'

    print('notify AC check passed')
    PY
    ```
  - Checks: root Claude fields unchanged and `agents.opencode` preserved after notify write
  - Result: `notify AC check passed`
- **AC-5 (install script deploys plugin)**
  - Command:
    ```bash
    python3 - <<'PY'
    import os
    import subprocess
    import tempfile
    from pathlib import Path

    repo = Path('/home/sean/workspace/navi')

    with tempfile.TemporaryDirectory() as td:
        home = Path(td) / 'home'
        home.mkdir(parents=True)
        env = os.environ.copy()
        env['HOME'] = str(home)

        proc = subprocess.run(
            ['bash', str(repo / 'install.sh')],
            cwd=str(repo),
            env=env,
            input='n\n',
            text=True,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            check=True,
        )

        plugin_path = home / '.config' / 'opencode' / 'plugins' / 'navi.js'
        assert plugin_path.exists()
        assert '✓ Installed OpenCode navi plugin' in proc.stdout

    print('install AC check passed')
    PY
    ```
  - Checks: `~/.config/opencode/plugins/navi.js` exists and installer output contains `✓ Installed OpenCode navi plugin`
  - Result: `install AC check passed`
- **AC-6 / AC-7 (Claude behavior unaffected + suite green)**
  - Commands: `go test -race ./...`, `go vet ./...`
  - Result: both pass with no regressions or vet findings
- **AC-8 (agent parsing and multi-agent read coverage)**
  - Added test: `internal/session/status_test.go` subtest `reads agents map from status file`
  - Previously added in task 40-1 and re-validated here: `internal/session/session_test.go` `TestExternalAgentJSONBehavior`
- **Regression guard (Claude + OpenCode coexistence)**
  - Added tests in `internal/session/notify_hook_test.go`:
    - `TestNotifyHookSessionIDRollover` validates main Claude updates continue when session_id changes
    - `TestNotifyHookSuppressesMismatchedPostToolUse` validates stale teammate/background mismatches are still suppressed
  - Commands: `go test ./internal/session`, `go test ./...`
  - Result: pass
- **PR review follow-up fixes**
  - Reduced OpenCode plugin tmux shelling frequency via timed session-name refresh
  - Added rapid duplicate-status suppression to avoid redundant back-to-back writes
  - Verified transient session-name resolution does not suppress first successful write

## Files Modified

- `internal/session/status_test.go`
- `internal/session/notify_hook_test.go`
- `docs/delivery/40/40-5.md`
