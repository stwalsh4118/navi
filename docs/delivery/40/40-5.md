# [40-5] E2E CoS verification

[Back to task list](./tasks.md)

## Description

Verify all PBI-40 acceptance criteria end-to-end. This task covers comprehensive testing across all implementation tasks to ensure the complete OpenCode status integration pipeline works correctly.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-15 19:24:55 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

Verify each PBI-40 acceptance criterion:

1. **AC-1**: OpenCode plugin exists and writes status updates on lifecycle events
2. **AC-2**: The `agents` map in status JSON correctly reflects OpenCode's current status
3. **AC-3**: `session.Info` struct includes `Agents map[string]ExternalAgent` and is populated from JSON
4. **AC-4**: `notify.sh` preserves the `agents` field (does not clobber OpenCode data)
5. **AC-5**: Install script deploys the OpenCode plugin to `~/.config/opencode/plugins/`
6. **AC-6**: Existing Claude Code hook behavior is completely unaffected
7. **AC-7**: All existing tests continue to pass
8. **AC-8**: New unit tests cover agent field parsing and multi-agent status file reading

## Implementation Plan

1. Run full test suite: `go test -race ./...` — verify AC-7
2. Review new unit tests cover data model parsing — verify AC-8
3. Create a test status file with both Claude Code and OpenCode data, verify `ReadStatusFiles` populates `Agents` correctly — verify AC-3
4. Write a status file with `agents.opencode`, run `notify.sh`, verify agents preserved — verify AC-4
5. Inspect plugin file at `plugins/opencode/navi.js`, verify event hooks and status mapping — verify AC-1, AC-2
6. Inspect `install.sh`, verify OpenCode plugin deployment section — verify AC-5
7. Run existing Claude Code hook tests/scenarios, verify no regressions — verify AC-6

## Test Plan

### Objectives
Validate the complete pipeline from data model through hook preservation to plugin correctness.

### Key Scenarios

1. **Go test suite green**: `go test -race ./...` passes with zero failures
2. **Data model round-trip**: JSON with `agents` field unmarshals into `session.Info` correctly, and `Agents` is nil when absent
3. **notify.sh preservation**: Simulated hook fire doesn't clobber `agents` field
4. **Plugin structure**: Plugin exports correct hook functions with proper status mappings
5. **Install script**: Plugin deployment section present and correct
6. **No regressions**: `go vet ./...` clean, existing test assertions unchanged

### Success Criteria
- All existing tests pass
- New tests pass
- No `go vet` warnings
- Plugin file is well-formed JavaScript
- Install script deploys plugin correctly

## Verification

_To be filled during implementation._

## Files Modified

_To be filled during implementation. Expected:_
- Possibly test files if additional E2E-level tests are needed
