# [40-3] OpenCode navi plugin

[Back to task list](./tasks.md)

## Description

Create the OpenCode plugin that hooks into lifecycle events and writes status updates to the navi session status file. The plugin is written in JavaScript, maps OpenCode events to navi statuses, and performs atomic read-modify-write on the shared JSON file.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-15 19:24:55 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Plugin file lives at `plugins/opencode/navi.js` in the navi repo
2. Plugin exports a function conforming to OpenCode's plugin API: `export const NaviPlugin = async ({ $ }) => { return { ...hooks } }`
3. Event-to-status mapping:
   - `session.created` → `working`
   - `tool.execute.after` → `working`
   - `permission.asked` → `permission`
   - `permission.replied` → `working`
   - `session.idle` → `idle`
   - `session.error` → `error`
4. Plugin determines tmux session name via `tmux display-message -p '#{session_name}'` (using `$` shell API)
5. Plugin reads existing `{SESSION_NAME}.json`, updates `.agents.opencode` with `{ status, timestamp }`, writes back
6. If no status file exists yet, plugin creates one with minimal structure: `{ tmux_session, agents: { opencode: { status, timestamp } } }`
7. Writes must be atomic (write to temp file, rename)
8. Cache the tmux session name at plugin init (avoid repeated shell calls)
9. Gracefully handle: not in tmux (skip), file read errors (create new), status dir doesn't exist (create it)

## Implementation Plan

**External Packages**: None — uses only Node.js/Bun built-in `fs` and the `$` shell API provided by OpenCode.

1. Create `plugins/opencode/navi.js`
2. Implement `getSessionName($)` — runs tmux command, caches result
3. Implement `updateStatus(sessionName, status)`:
   - Determine status dir (`~/.claude-sessions/`)
   - Read existing file if present, or start with empty object
   - Set `.agents.opencode = { status, timestamp: Math.floor(Date.now() / 1000) }`
   - If file was empty/new, also set `.tmux_session`
   - Write to temp file, rename atomically
4. Wire hooks to call `updateStatus` with mapped status strings
5. Handle edge cases per requirement #9

## Test Plan

- **Plugin structure**: Verify the exported function returns an object with the expected hook keys
- **Event mapping**: Verify each hook maps to the correct navi status string
- **File creation**: When no status file exists, plugin creates one with correct structure
- **File preservation**: When status file has existing Claude Code data, plugin only touches `.agents.opencode`
- **No tmux**: When not in tmux, plugin gracefully skips without error
- **Atomic write**: Verify temp-file-then-rename pattern

## Verification

_To be filled during implementation._

## Files Modified

_To be filled during implementation. Expected:_
- `plugins/opencode/navi.js` (new)
