# [40-2] Preserve agents field in notify.sh

[Back to task list](./tasks.md)

## Description

Update `notify.sh` to read and preserve the `agents` field from the existing session JSON during its read-modify-write cycle, so that status updates written by OpenCode's plugin are not clobbered when Claude Code hooks fire.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-15 19:24:55 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. The main session branch of `notify.sh` must read the existing `agents` field from the session JSON (like it reads `EXISTING_TEAM`)
2. The `agents` field must be included in the JSON output template (like the `team` field)
3. When no `agents` field exists, behavior is unchanged (no field emitted)
4. The teammate branch does not need modification (it uses jq read-modify-write which naturally preserves unknown fields)
5. Existing Claude Code hook behavior remains identical

## Implementation Plan

1. In the main session branch (around line 189 where `EXISTING_TEAM` is read), add: `EXISTING_AGENTS=$(jq '.agents // null' "$SESSION_FILE" 2>/dev/null || echo "null")`
2. Handle null: `[ "$EXISTING_AGENTS" = "null" ] && EXISTING_AGENTS=""`
3. Build `AGENTS_FIELD` similarly to `TEAM_FIELD`: if non-empty, append `,"agents": $EXISTING_AGENTS` to JSON output
4. Insert `$AGENTS_FIELD` in the heredoc template alongside `$TEAM_FIELD`

## Test Plan

- **Manual verification**: Write a status file with an `agents` field, run `notify.sh working` for the same tmux session, confirm the `agents` field is preserved in the output
- **No agents**: Run `notify.sh` against a file with no `agents` field, confirm no `agents` key appears in output
- **Both team and agents**: Write a file with both `team` and `agents`, run `notify.sh`, confirm both preserved

## Verification

_To be filled during implementation._

## Files Modified

_To be filled during implementation. Expected:_
- `hooks/notify.sh`
