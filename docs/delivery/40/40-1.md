# [40-1] ExternalAgent data model and JSON parsing

[Back to task list](./tasks.md)

## Description

Add the `ExternalAgent` struct and `Agents` map field to `session.Info` so that non-Claude-Code agents (starting with OpenCode) can store their status in the shared session JSON file. Update the session API spec to document the new types.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-15 19:24:55 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Define `ExternalAgent` struct with `Status string` and `Timestamp int64` fields (JSON-tagged)
2. Add `Agents map[string]ExternalAgent` field to `session.Info` with `json:"agents,omitempty"` tag
3. Existing JSON without `agents` field must unmarshal without error (backward compatible)
4. JSON with `agents` field must round-trip correctly through marshal/unmarshal
5. When `Agents` is nil/empty, it must be omitted from marshaled JSON
6. Update `docs/api-specs/session/session-api.md` to document `ExternalAgent` and the `Agents` field

## Implementation Plan

1. Add `ExternalAgent` struct to `internal/session/session.go` (after `TeamInfo`)
2. Add `Agents map[string]ExternalAgent` field to `Info` struct
3. Update `docs/api-specs/session/session-api.md` â€” add `ExternalAgent` type and `Agents` field to `Info`
4. Write unit tests

## Test Plan

- **JSON round-trip with agents**: Marshal `Info` with `Agents` map containing an "opencode" entry, unmarshal, verify fields preserved
- **Omit when nil**: Marshal `Info` with `Agents` as nil, verify no `"agents"` key in output
- **Backward compatibility**: Unmarshal existing JSON (no `agents` field), verify `Agents` is nil and all other fields intact
- **Multiple agents**: Marshal/unmarshal with multiple agent entries, verify all preserved

## Verification

_To be filled during implementation._

## Files Modified

_To be filled during implementation. Expected:_
- `internal/session/session.go`
- `internal/session/session_test.go`
- `docs/api-specs/session/session-api.md`
