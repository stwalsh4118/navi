# [32-3] Add scrolling to the preview pane

[Back to task list](./tasks.md)

## Description

Replace the current "show last N lines" truncation in the preview pane with offset-based scrolling. Currently, `renderPreview()` in `view.go` (lines 511-515) takes the last `maxLines` of content, so users can only see the most recent output and have no way to scroll up through earlier lines. This task adds a `previewScrollOffset` field, scroll keybindings when the preview pane is focused, and auto-tail behavior (auto-scroll to bottom when new content arrives, unless the user has manually scrolled up).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-09 17:48:01 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-09 18:18:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-09 18:30:00 | Status Change | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2026-02-09 18:49:31 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- Add `previewScrollOffset int` field to the Model struct
- Add `previewAutoScroll bool` field (default true) to track whether to auto-follow new content
- Modify `renderPreview()` to render lines from `[previewScrollOffset, previewScrollOffset + maxLines)` instead of `[len(lines)-maxLines, len(lines))`
- Add scroll keybindings when preview pane has focus (it currently doesn't have a focused state for keybindings):
  - j/k or up/down: scroll line by line
  - PgUp/PgDn: page scroll
  - g/G: jump to top/bottom
- Implement auto-tail: when `previewAutoScroll` is true, new content arriving (via `previewContentMsg`) sets `previewScrollOffset` to max scroll. When user scrolls up manually, set `previewAutoScroll = false`. When user presses G (jump to bottom), set `previewAutoScroll = true`.
- Reset scroll state when switching to a different session (cursor change)
- Clamp `previewScrollOffset` when content changes (new capture may have different line count)

## Implementation Plan

1. Add `previewScrollOffset int` and `previewAutoScroll bool` to Model struct in `model.go`
2. Initialize `previewAutoScroll = true` in the Model constructor
3. Modify `renderPreview()` in `view.go`:
   - After splitting content into lines and applying wrap/truncate, calculate `maxScroll := max(0, len(lines) - maxLines)`
   - Clamp `previewScrollOffset` to `[0, maxScroll]`
   - Slice `lines[previewScrollOffset : previewScrollOffset+maxLines]` instead of `lines[len(lines)-maxLines:]`
4. Add preview focus state: The preview pane currently doesn't have a focused/unfocused concept like the task panel. Need to add `previewFocused bool` and a way to toggle focus (e.g., Tab when preview is visible, similar to task panel).
5. Add keybinding handling for preview-focused state in `Update()`:
   - j/k/up/down for line scroll
   - PgUp/PgDn for page scroll
   - g for top (also set autoScroll = false), G for bottom (set autoScroll = true)
   - Esc/Tab to unfocus
6. In `previewContentMsg` handler: if `previewAutoScroll`, set `previewScrollOffset` to maxScroll after updating content
7. When user scrolls up (j/k/up/PgUp/g), set `previewAutoScroll = false`
8. When user presses G or goes to bottom, set `previewAutoScroll = true`
9. Reset `previewScrollOffset = 0` and `previewAutoScroll = true` when cursor changes session

## Test Plan

- **Auto-tail**: New content arrives and scroll follows to bottom when autoScroll is true
- **Manual scroll**: Scrolling up sets autoScroll to false, new content no longer forces scroll to bottom
- **Re-enable auto-tail**: Pressing G re-enables autoScroll
- **Scroll clamping**: ScrollOffset never exceeds max(0, totalLines - maxLines) and never goes below 0
- **Session switch reset**: Changing cursor resets scroll to 0 and autoScroll to true
- **Keybindings**: j/k/PgUp/PgDn/g/G all work when preview is focused
- **Existing tests pass**

## Verification

- [ ] Preview pane supports scrolling up through content
- [ ] Auto-tail behavior works (follows new content by default)
- [ ] Manual scroll disables auto-tail
- [ ] G (jump to bottom) re-enables auto-tail
- [ ] Session switch resets scroll state
- [ ] Preview keybindings work when focused
- [ ] Existing tests pass
- [ ] New tests cover auto-tail and scroll behavior

## Files Modified

- `internal/tui/model.go` - Added `previewScrollOffset`, `previewAutoScroll`, `previewFocused` fields; `updatePreviewFocus()` handler; preview focus via Tab; reset on cursor change and toggle
- `internal/tui/view.go` - Modified `renderPreview()` for offset-based scrolling with auto-tail; added focused box style; updated footer keybindings for preview focus
- `internal/tui/preview.go` - Added `previewPageScrollAmt` constant
- `internal/tui/styles.go` - Added `previewFocusedBoxStyle`
- `internal/tui/preview_scroll_test.go` - New test file with preview scroll and auto-tail tests
