# [32-1] Add viewport scrolling to the task panel

[Back to task list](./tasks.md)

## Description

Add scroll offset tracking and viewport-aware rendering to the task panel so that when there are more task items (groups + tasks) than fit in the panel's visible area, the viewport scrolls to keep the cursor visible. Currently, `renderTaskPanelList()` in `taskview.go` iterates through items and breaks at `maxLines`, silently truncating everything beyond. The cursor (`taskCursor`) can wrap around but the viewport doesn't follow, making off-screen items invisible and unreachable in practice.

This task adds a `taskScrollOffset` field to the Model, modifies `renderTaskPanelList()` to render only the visible slice of items (from scroll offset to scroll offset + viewport height), and updates `moveTaskCursor()` to auto-adjust the scroll offset when the cursor moves beyond the viewport boundaries.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-09 17:48:01 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

- Add `taskScrollOffset int` field to the Model struct
- Modify `renderTaskPanelList()` to render only items within `[taskScrollOffset, taskScrollOffset + maxLines)` instead of breaking at maxLines
- Update `moveTaskCursor()` to auto-adjust `taskScrollOffset` when cursor moves above or below the visible viewport (cursor-follow behavior)
- Clamp `taskScrollOffset` to `max(0, totalItems - maxLines)` to prevent scrolling past the end
- Reset `taskScrollOffset` to 0 when task data changes (project switch, search clear)
- Add page-scroll keybindings (PgUp/PgDn) when task panel is focused
- Add jump-to-top/bottom keybindings (g/G) when task panel is focused
- Ensure existing cursor navigation (j/k, up/down), group expand/collapse (Space), and search (/) continue to work correctly
- When expanding/collapsing a group, ensure scroll offset stays valid

## Implementation Plan

1. Add `taskScrollOffset int` to Model struct in `model.go`
2. Create helper `taskPanelMaxScroll(totalItems, maxLines int) int` that returns `max(0, totalItems - maxLines)`
3. Create helper `ensureTaskCursorVisible(maxLines int)` that adjusts `taskScrollOffset` so `taskCursor` is within `[taskScrollOffset, taskScrollOffset + maxLines)`
4. Modify `renderTaskPanelList()` in `taskview.go`:
   - After getting `items := m.getVisibleTaskItems()`, slice to `items[scrollOffset:min(scrollOffset+maxLines, len(items))]`
   - Adjust the index `i` used for cursor/match checks to account for the scroll offset
5. Update `moveTaskCursor()` in `model.go` to call `ensureTaskCursorVisible()` after moving the cursor
6. Add PgUp/PgDn and g/G keybindings in the task-panel-focused section of `Update()` in `model.go`
7. Reset `taskScrollOffset = 0` in places where task data changes: project switches, search clear, task refresh
8. When group expand/collapse changes the item count, clamp `taskScrollOffset` to the new max

## Test Plan

- **Scroll offset clamping**: Verify `taskScrollOffset` never exceeds `max(0, totalItems - maxLines)` and never goes below 0
- **Cursor-follow**: When cursor moves below viewport, scroll offset increases to keep cursor visible. When cursor moves above viewport, scroll offset decreases.
- **Page scroll**: PgDn advances scroll by a page amount, PgUp goes back. Both clamp properly.
- **Jump to ends**: g sets scroll to 0 and cursor to 0. G sets cursor to last item and scroll to max.
- **Group expand/collapse**: Expanding a group increases item count and scroll stays valid. Collapsing re-clamps.
- **Existing navigation still works**: j/k move cursor, Space toggles groups, search works

## Verification

- [ ] Task panel scrolls when items exceed viewport height
- [ ] Cursor is always visible (viewport follows cursor)
- [ ] PgUp/PgDn and g/G keybindings work in task panel
- [ ] Group expand/collapse doesn't break scroll state
- [ ] Search mode still works correctly with scrolling
- [ ] Existing tests pass
- [ ] New tests cover scroll offset clamping and cursor-follow

## Files Modified

