# [32-2] Add viewport scrolling to the session list

[Back to task list](./tasks.md)

## Description

Add scroll offset tracking to the session list so that when there are more sessions than fit in the available vertical space, the viewport scrolls to keep the cursor visible. Currently, `renderSessionList()` in `view.go` renders all sessions and the parent `View()` function truncates the output by line count (lines 64-67 for task panel layout, lines 84-87 for preview bottom layout). The cursor wraps around (line 211: `m.cursor = len(filteredSessions) - 1`) but the viewport doesn't follow, so sessions at the bottom of a long list are invisible.

Each session row is multi-line (3-5 lines depending on git info, metrics, and message presence), which makes this more complex than the task panel - the scroll offset must be in terms of session index rather than raw line count, and the viewport must account for variable-height rows.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-09 17:48:01 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-09 18:10:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-09 18:18:00 | Status Change | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2026-02-09 18:49:31 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- Add `sessionScrollOffset int` field to the Model struct to track the first visible session index
- Modify `renderSessionList()` to render only sessions within the viewport range `[sessionScrollOffset, ...]` up to the available line count
- Update session cursor movement (up/down/j/k in `Update()`) to auto-adjust `sessionScrollOffset` when cursor moves outside the viewport
- Handle the variable-height nature of session rows (each session renders 2-5 lines depending on git info, metrics, message)
- Clamp `sessionScrollOffset` when sessions are removed (filtered, dismissed)
- Reset `sessionScrollOffset` to 0 when filters change
- Ensure cursor wrapping behavior still works (wrap from top to bottom scrolls viewport to the end, and vice versa)
- Preview capture debounce and task panel update on cursor change must still work

## Implementation Plan

1. Add `sessionScrollOffset int` to Model struct in `model.go`
2. Modify `renderSessionList()` in `view.go`:
   - Accept a `maxHeight int` parameter (or compute it internally)
   - Start rendering from `m.sessionScrollOffset` instead of index 0
   - Track cumulative line count per session rendered; stop when exceeding available height
   - Render sessions `[sessionScrollOffset, sessionScrollOffset+N]` where N is determined by height
3. Create helper `ensureSessionCursorVisible()` that adjusts `sessionScrollOffset`:
   - If `cursor < sessionScrollOffset`, set `sessionScrollOffset = cursor`
   - If cursor's session would render beyond viewport bottom, increment `sessionScrollOffset` until it's visible
4. Update cursor movement in `Update()` (both normal mode at ~line 204 and search-persisted mode at ~line 1683) to call `ensureSessionCursorVisible()`
5. In `View()`, pass available height to `renderSessionList()` so it can do its own viewport management (replacing the external line-count truncation)
6. Reset `sessionScrollOffset = 0` when filter/sort changes occur
7. Clamp `sessionScrollOffset` after session refresh if total sessions decreased

## Test Plan

- **Scroll offset clamping**: Verify `sessionScrollOffset` never exceeds valid range after filter changes, session dismissal
- **Cursor-follow**: Moving cursor down past viewport bottom scrolls the viewport. Moving up past top scrolls back.
- **Wrap scroll**: Wrapping from first to last session jumps `sessionScrollOffset` to show the last session. Wrapping from last to first resets to 0.
- **Variable-height rows**: Sessions with git info take more lines; viewport correctly accounts for this
- **Filter/sort reset**: Changing filter or sort resets scroll offset to 0
- **Existing functionality**: Preview debounce, task panel update, search matches all still work

## Verification

- [ ] Session list scrolls when sessions exceed the visible area
- [ ] Cursor is always visible after movement
- [ ] Wrapping behavior works correctly with scrolling
- [ ] Filter/sort changes reset scroll position
- [ ] Variable-height session rows are handled
- [ ] Preview pane and task panel still update on cursor change
- [ ] Existing tests pass
- [ ] New tests cover session scroll behavior

## Files Modified

- `internal/tui/model.go` - Added `sessionScrollOffset` field, `ensureSessionCursorVisible()`, `sessionListMaxVisible()`, scroll offset management in cursor movement/search/filter handlers
- `internal/tui/view.go` - Modified `renderSessionList()` to use offset-based viewport rendering
- `internal/tui/session_scroll_test.go` - New test file with session scroll tests
