# [28-2] Implement config discovery and loading

[Back to task list](./tasks.md)

## Description

Implement the hybrid configuration system: discover per-project `.navi.yaml` files by walking up from session working directories, load the global `~/.navi/config.yaml` for defaults and status mapping, and merge them together. This provides the configuration layer that the provider execution engine (28-3) depends on.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 19:24:24 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

- Walk up from a given directory path to find `.navi.yaml` (similar to how git finds `.git`)
- Parse `.navi.yaml` into `ProjectConfig` struct using YAML (follow pattern from `internal/remote/config.go`)
- Load global config from `~/.navi/config.yaml` into `GlobalConfig` struct
- Apply global defaults when per-project config is missing fields (e.g., use `default_provider` if project doesn't specify one)
- Given a list of session working directories, return a deduplicated list of `ProjectConfig` entries (multiple sessions in the same repo should produce one config)
- Gracefully handle missing files (no `.navi.yaml` = skip project, no global config = use built-in defaults)
- Status mapping: resolve free-form status strings to normalized display statuses

## Implementation Plan

1. Create `internal/task/config.go`:
   - `FindProjectConfig(dir string) (*ProjectConfig, error)` - walk up from dir to find `.navi.yaml`
   - `LoadGlobalConfig() (*GlobalConfig, error)` - load from `~/.navi/config.yaml`
   - `MergeConfig(project *ProjectConfig, global *GlobalConfig) *ProjectConfig` - apply defaults
   - `NormalizeStatus(status string, statusMap map[string]string) string` - map provider status to display status
2. Create `internal/task/discover.go`:
   - `DiscoverProjects(cwds []string) []ProjectConfig` - deduplicate CWDs, find configs, merge with global
3. Create `internal/task/config_test.go`:
   - Test walk-up finding `.navi.yaml` at various depths
   - Test missing `.navi.yaml` returns nil without error
   - Test global config loading and defaults
   - Test config merging
   - Test status normalization
   - Test deduplication of CWDs within same project

## Test Plan

- Walk-up correctly finds `.navi.yaml` at project root, parent, or grandparent
- Walk-up stops at filesystem root without error when no config found
- Global config loads with valid YAML and applies defaults for missing fields
- Missing global config file uses built-in defaults
- Config merge correctly fills in project config gaps from global defaults
- Multiple CWDs within the same project root produce a single ProjectConfig
- Status normalization maps configured statuses and passes through unmapped ones

## Verification

- [ ] Walk-up discovery works at various directory depths
- [ ] Global config loading handles missing/malformed files gracefully
- [ ] Config merging applies defaults correctly
- [ ] CWD deduplication works
- [ ] Unit tests pass
- [ ] `go vet ./internal/task/...` clean

## Files Modified

