# [28-4] Integrate task view into TUI model and input handling

[Back to task list](./tasks.md)

## Description

Wire the task system into the Bubble Tea TUI: add task-related state fields to the Model, implement the `T` keybinding to toggle between sessions and task view, add task-mode keybindings (navigation, expand/collapse, open URL, search, refresh), create async commands for provider execution and periodic refresh, and connect config discovery to the session poll cycle.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 19:24:24 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-06 19:39:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-06 19:44:16 | Status Change | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2026-02-06 21:47:53 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- Add task view state to Model: `taskViewMode bool`, `taskGroups []task.TaskGroup`, `taskCursor int`, `expandedGroups map[string]bool`, `taskError error`, `taskProjectConfigs []task.ProjectConfig`, `taskCache *task.ResultCache`, `taskGlobalConfig *task.GlobalConfig`
- `T` key toggles `taskViewMode` on/off from sessions view (and vice versa)
- In task view mode, handle: up/down (navigate), Space (expand/collapse group), Enter (open URL), `/` (search), `r` (refresh), `Esc` (back to sessions)
- Session keybindings are inactive while in task view mode
- Create `taskRefreshCmd()` - runs provider scripts for all discovered projects, returns `tasksMsg`
- Create `taskTickCmd()` - periodic refresh on configurable interval (default 60s)
- On session poll, extract unique CWDs and run config discovery; if configs change, trigger a task refresh
- Load global config once on Init
- Open URLs using `exec.Command("xdg-open", url)` (Linux) or equivalent
- Task cursor navigation must handle collapsible groups (skip collapsed children, navigate between groups)

## Implementation Plan

1. Add task-related fields to `Model` struct in `model.go`
2. Create `internal/tui/tasks.go`:
   - `tasksMsg` - message type carrying refreshed task data or error
   - `taskRefreshCmd(configs []task.ProjectConfig, cache *task.ResultCache, timeout time.Duration) tea.Cmd`
   - `taskTickCmd(interval time.Duration) tea.Cmd`
   - `openURLCmd(url string) tea.Cmd`
3. Update `Init()` in `model.go` to load global task config
4. Update `Update()` in `model.go`:
   - Handle `T` key to toggle task view mode
   - Route to `updateTaskView()` when in task mode
   - Handle `tasksMsg` to update task state
   - On `sessionsMsg`, extract CWDs and trigger config discovery + task refresh if needed
5. Create `updateTaskView(msg tea.KeyMsg)` function:
   - Arrow keys navigate `taskCursor` (accounting for collapsed groups)
   - Space toggles group expansion
   - Enter opens selected task URL
   - `/` activates search mode for tasks
   - `r` invalidates cache and triggers refresh
   - `Esc` exits task view mode
6. Update `Init()` to start task tick command

## Test Plan

- `T` key toggles task view mode on and off
- Session keybindings are inactive during task view mode
- Task cursor navigates correctly through groups and tasks
- Collapsed groups are skipped during navigation
- Space toggles group expanded/collapsed state
- Enter on a task with a URL triggers URL open
- `r` triggers task refresh
- `Esc` returns to sessions view
- Session poll triggers config discovery from CWDs
- Task refresh command returns parsed results or error

## Verification

- [ ] `T` toggles between sessions and task view
- [ ] All task-mode keybindings work
- [ ] Navigation handles collapsed groups correctly
- [ ] Async task refresh works
- [ ] Config discovery triggers on session poll
- [ ] Unit tests pass
- [ ] `go vet` clean

## Files Modified

- `internal/tui/tasks.go` - Task view messages, commands, input handling, search, navigation
- `internal/tui/model.go` - Added task state fields to Model, T toggle, task message handlers, config discovery on session poll
- `internal/tui/input.go` - Added initTaskSearchInput()
