# [28-3] Implement provider execution engine

[Back to task list](./tasks.md)

## Description

Implement the core engine that executes provider scripts, captures their output, parses the standard JSON format, and handles errors and timeouts. This is the bridge between external task sources and Navi's internal data model. Includes built-in provider name resolution (mapping shorthand names like "github-issues" to bundled script paths) and result caching.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 19:24:24 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-06 19:38:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-06 21:47:53 | Status Change | InProgress | Done | Task completed and verified | AI_Agent |

## Requirements

- Execute a provider command (script path or built-in name) as a subprocess
- Pass config `args` as environment variables: `NAVI_TASK_ARG_<KEY>=<value>` (keys uppercased)
- Capture stdout for JSON parsing, stderr for error display
- Enforce configurable timeout (default 30s) - kill the process if it exceeds the limit
- Parse stdout as standard task JSON (`ProviderResult`) using types from 28-1
- Resolve built-in provider names ("github-issues", "markdown-tasks") to their bundled script paths
- Cache results per project with a TTL matching the configured refresh interval
- Return structured errors (timeout, parse failure, non-zero exit, script not found) distinguishable by the TUI

## Implementation Plan

1. Create `internal/task/provider.go`:
   - `type ProviderError struct` - structured error with type (Timeout, ParseError, ExecError, NotFound)
   - `func ResolveProvider(name string) (string, error)` - resolve built-in name to script path, or validate custom path exists
   - `func ExecuteProvider(config ProjectConfig, timeout time.Duration) (*ProviderResult, error)` - run script, capture output, parse JSON
   - `func buildEnvVars(args map[string]string) []string` - convert args to NAVI_TASK_ARG_ env vars
2. Create `internal/task/cache.go`:
   - `type ResultCache struct` - map of project path to cached result with timestamp
   - `func (c *ResultCache) Get(projectPath string, ttl time.Duration) (*ProviderResult, bool)`
   - `func (c *ResultCache) Set(projectPath string, result *ProviderResult)`
   - `func (c *ResultCache) Invalidate(projectPath string)` - for manual refresh
3. Create `internal/task/provider_test.go`:
   - Test with a simple mock script that outputs valid JSON
   - Test timeout handling with a script that sleeps too long
   - Test non-zero exit code handling
   - Test stderr capture
   - Test malformed JSON output
   - Test environment variable passing
   - Test built-in provider name resolution
4. Create `internal/task/cache_test.go`:
   - Test cache hit within TTL
   - Test cache miss after TTL expiry
   - Test cache invalidation

## Test Plan

**Objectives**: Verify provider scripts are executed correctly with proper argument passing, output parsing, error handling, and caching.

**Test Scenarios**:
- Valid provider script produces correct `ProviderResult`
- Timeout kills long-running script and returns `ProviderError` with Timeout type
- Non-zero exit code returns `ProviderError` with stderr content
- Malformed JSON stdout returns `ProviderError` with ParseError type
- Environment variables correctly set from config args
- Built-in name "github-issues" resolves to bundled script path
- Unknown built-in name returns NotFound error
- Cache returns stored result within TTL
- Cache returns miss after TTL expiry
- Cache invalidation forces re-fetch

## Verification

- [ ] Provider scripts execute and produce parsed results
- [ ] Timeout enforcement works
- [ ] Error types are distinguishable (timeout vs parse vs exec vs not found)
- [ ] Environment variable passing works
- [ ] Caching respects TTL
- [ ] Unit tests pass
- [ ] `go vet ./internal/task/...` clean

## Files Modified

- `internal/task/provider.go` (created) - Provider execution engine: ResolveProvider, ExecuteProvider, buildEnvVars, ProviderError types
- `internal/task/cache.go` (created) - ResultCache with TTL-based Get/Set/Invalidate/InvalidateAll
- `internal/task/provider_test.go` (created) - Tests for provider execution, timeout, error handling, env vars, resolution
- `internal/task/cache_test.go` (created) - Tests for cache operations, TTL expiry, concurrent access
