# [5-3] Handle attach/detach return

[Back to task list](./tasks.md)

## Description

Handle the return from tmux attach, refreshing state and preserving cursor position.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-05 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-05 06:01:54 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-05 06:02:54 | Status Change | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2026-02-05 06:08:24 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. On `attachDoneMsg`, trigger immediate refresh
2. Try to preserve cursor on same session if it still exists
3. Adjust cursor if session list changed

## Implementation Plan

Handle attachDoneMsg in Update():
```go
case attachDoneMsg:
    // Remember current session name for cursor preservation
    var currentSession string
    if m.cursor < len(m.sessions) {
        currentSession = m.sessions[m.cursor].TmuxSession
    }

    // Trigger immediate poll
    return m, func() tea.Msg {
        msg := pollSessions()
        // After poll, try to restore cursor position
        if sessions, ok := msg.(sessionsMsg); ok {
            for i, s := range sessions {
                if s.TmuxSession == currentSession {
                    // We'll handle this in sessionsMsg handler
                    break
                }
            }
        }
        return msg
    }
```

Alternative: Store `lastSelectedSession` in Model and restore on sessionsMsg.

## Test Plan

- **Objective**: Verify state refreshes after detach
- **Test Scenarios**:
  1. Return from tmux triggers refresh
  2. Cursor stays on same session if exists
  3. Cursor adjusts if session list changed
- **Success Criteria**: Smooth transition back to TUI

## Verification

- [ ] Immediate refresh on return
- [ ] Cursor preserved when possible
- [ ] Cursor adjusted to valid position
- [ ] No cursor out-of-bounds errors

## Files Modified

- `model.go` - Added lastSelectedSession field, attachDoneMsg handler, cursor restoration in sessionsMsg handler
- `model_test.go` - Added TestAttachDoneMsg and TestCursorRestoration tests
