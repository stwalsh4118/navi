# [27-4] TUI integration for remote git info

[Back to task list](./tasks.md)

## Description

Wire up the `G` keybinding in the TUI to fetch and display git info for remote sessions. Currently, pressing `G` on a remote session does nothing (early return in `model.go`). This task removes that guard and dispatches an on-demand SSH fetch using the `remote.FetchGitInfo()` function from task 27-1. The result populates the same `git.Info` struct and is displayed identically to local git info.

PR info is fetched using the local `gh` CLI after the remote git metadata (remote URL, branch) is available, matching the local flow.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 16:27:44 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-06 16:47:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-06 16:49:00 | Status Change | InProgress | Review | Implementation complete, all tests pass | AI_Agent |

## Requirements

- Remove the `if s.Remote != "" { return m, nil }` early return from the `G` keybinding handler
- When `G` is pressed on a remote session:
  1. Open the `DialogGitDetail` dialog (same as local)
  2. If cached git info exists and is not stale, use it immediately
  3. If no cache or stale, fire an async command that calls `remote.FetchGitInfo()` via SSH
  4. Show a loading state while SSH fetch is in progress
  5. On result, update `m.gitCache` and the session's `Git` field
  6. After remote git info arrives (with remote URL and branch), call local `gh pr view` for PR info (same `fetchPRCmd()` flow) - `gh` uses the remote URL so it works from any machine
- Cache remote git info in `m.gitCache` keyed by CWD (same as local), using `FetchedAt` and `IsStale()` for TTL
- Handle SSH errors gracefully - show error message in the git detail dialog
- Remote git info should also appear in the session list row (the branch/dirty/ahead-behind line) after being fetched

## Implementation Plan

1. In `model.go`, modify the `G` key handler:
   - Remove remote session early return
   - Set dialog mode to `DialogGitDetail`
   - Check `m.gitCache[s.CWD]` - if fresh, use it; if stale or missing, fire async fetch
2. Add a new Bubble Tea command `fetchRemoteGitCmd(pool *SSHPool, remoteName, cwd string) tea.Cmd` in `sessions.go`
3. Add a new message type `remoteGitInfoMsg` with fields for cwd, info, and error
4. Handle `remoteGitInfoMsg` in `Update()`:
   - On success: update `m.gitCache`, update `m.sessionToModify.Git`, trigger `fetchPRCmd()` for PR info
   - On error: set `m.dialogError` with the error message
5. Update the `gitInfoMsg` handler to also merge cached git info into remote sessions (remove the `if m.sessions[i].Remote == ""` guard when there's cached data for that CWD from a remote fetch)
6. Ensure `renderGitInfo()` and `renderGitDetailView()` work unchanged (they operate on `*git.Info` regardless of source)

## Test Plan

- **Unit tests**:
  - `G` key on remote session opens git detail dialog (not early return)
  - Cached git info is used when fresh
  - Async fetch is triggered when cache is stale or missing
  - `remoteGitInfoMsg` success updates cache and session
  - `remoteGitInfoMsg` error sets dialog error
  - PR fetch is triggered after remote git info arrives
- **Integration consideration**: Full E2E flow tested in task 27-7

## Verification

- [ ] `G` key works on remote sessions (no early return)
- [ ] Git info is fetched on-demand via SSH
- [ ] Cached results are reused when fresh
- [ ] PR info is fetched via local `gh` CLI after git metadata arrives
- [ ] Errors are shown in the dialog, not crashes
- [ ] Git info appears in session list row after fetch
- [ ] Code quality checks pass (`make check`)
- [ ] Unit tests pass

## Files Modified

- `internal/tui/model.go` - Added remoteGitInfoMsg type, modified G key handler, added remoteGitInfoMsg handler, updated git cache merging to include remote sessions
- `internal/tui/sessions.go` - Added fetchRemoteGitCmd(), added remote import
