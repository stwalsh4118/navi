# [27-1] Remote git info fetching via SSH

[Back to task list](./tasks.md)

## Description

Add a function to the `internal/remote` package that fetches git repository information from a remote machine via SSH. The function bundles multiple git commands into a single SSH call to minimize round trips, parses the structured output, and returns a `*git.Info` struct compatible with the existing local git info system.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 16:27:44 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

- Add a `FetchGitInfo(pool *SSHPool, remoteName, cwd string) (*git.Info, error)` function to `internal/remote/`
- Bundle git commands into a single SSH call to minimize latency:
  - `git rev-parse --abbrev-ref HEAD` (branch)
  - `git status --porcelain | head -1` (dirty check)
  - `git rev-list --left-right --count @{u}...HEAD` (ahead/behind)
  - `git log -1 --format=%h %s` (last commit)
  - `git remote get-url origin` (remote URL)
- Use structured delimiters in the SSH command output (e.g., `BRANCH:`, `DIRTY:`, etc.) so each field can be parsed reliably
- Handle non-git directories gracefully (return nil, not an error)
- Handle partial failures (e.g., no upstream configured means ahead/behind are 0)
- Set `FetchedAt` on the returned `git.Info` so the existing `IsStale()` mechanism works
- The command must work with the remote's `cwd` path (cd into it first)

## Implementation Plan

1. Create a new file `internal/remote/git.go`
2. Implement `FetchGitInfo()` that:
   - Constructs a shell script string that `cd`s to cwd and runs all git commands with labeled output
   - Calls `pool.Execute(remoteName, script)` to run it via SSH
   - Parses the labeled output lines into a `git.Info` struct
   - Returns nil if the directory is not a git repo (detected by git rev-parse failing)
3. Add a `parseGitOutput(output string) *git.Info` helper for parsing the structured output
4. Write unit tests for output parsing with various scenarios

## Test Plan

- **Unit tests** for `parseGitOutput()`:
  - Normal output with all fields populated
  - Non-git directory (empty/error output) returns nil
  - Missing upstream (no ahead/behind) returns zeros
  - Dirty repo (porcelain output present) returns `Dirty: true`
  - Clean repo (empty porcelain) returns `Dirty: false`
  - Partial output (some commands fail) still returns what's available
- **Integration consideration**: Full SSH integration tested in E2E task (27-7)

## Verification

- [ ] `FetchGitInfo()` function exists and compiles
- [ ] Output parsing handles all edge cases
- [ ] `FetchedAt` is set correctly for cache staleness
- [ ] Code quality checks pass (`make check`)
- [ ] Unit tests pass

## Files Modified

