# [27-7] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification of all PBI-27 acceptance criteria. This task validates that all remote session enhancements work correctly as an integrated whole, covering the full flow from keybinding input through SSH execution to UI display.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 16:27:44 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-06 16:52:00 | Status Change | Proposed | InProgress | Started E2E test implementation | AI_Agent |
| 2026-02-06 16:55:00 | Status Change | InProgress | Review | All 37 test cases pass with race detector, all 9 ACs covered | AI_Agent |

## Requirements

Verify all 9 acceptance criteria from the PBI:

1. Pressing `G` on a remote session fetches and displays git info via SSH
2. Pressing `p` on a remote session fetches and displays tmux preview via SSH
3. Pressing `x` on a remote session kills the remote tmux session via SSH
4. Pressing `R` on a remote session renames the remote tmux session via SSH
5. Pressing `d` on a remote session dismisses it by removing the status file via SSH
6. All SSH operations reuse the existing SSHPool connection pool
7. On-demand fetches (git, preview) are cached with a TTL to avoid redundant SSH calls
8. SSH errors are handled gracefully with user-visible feedback (not crashes)
9. Remote actions provide the same confirmation/feedback as their local equivalents

## Implementation Plan

1. Extend the existing E2E test file (`internal/tui/e2e_remote_test.go`) or create a new test file for PBI-27 tests
2. Use the existing test patterns from PBI-19 E2E tests as a reference
3. Write test cases for each acceptance criterion:
   - **AC1 (Git)**: Simulate `G` key on remote session, verify `FetchGitInfo` is called with correct remote, verify git detail dialog opens with data
   - **AC2 (Preview)**: Simulate `p` key on remote session, verify `CapturePane` is called with correct remote, verify preview content displayed
   - **AC3 (Kill)**: Simulate `x` → `y` on remote session, verify `KillSession` is called via SSH
   - **AC4 (Rename)**: Simulate `R` → type new name → Enter on remote session, verify `RenameSession` is called via SSH
   - **AC5 (Dismiss)**: Simulate `d` on remote session, verify `DismissSession` is called via SSH
   - **AC6 (SSHPool reuse)**: Verify all operations go through the model's `SSHPool`
   - **AC7 (Caching)**: Verify git info cached in `gitCache`, second `G` press uses cache when fresh
   - **AC8 (Error handling)**: Simulate SSH errors, verify error messages appear in UI (dialog or preview pane)
   - **AC9 (Feedback parity)**: Verify same dialogs, confirmation prompts, and result messages as local equivalents
4. Run all tests with race detector (`go test -race`)

## Test Plan

This task IS the test plan. Test scenarios cover:

**Happy Path:**
- Git info fetched and displayed for remote session
- Preview content fetched and displayed for remote session
- Kill remote session with confirmation
- Rename remote session with validation
- Dismiss remote session immediately
- Cached git info reused on subsequent requests

**Error Scenarios:**
- SSH connection failure during git fetch → error in git dialog
- SSH connection failure during preview → error message in preview pane
- SSH connection failure during kill → error in kill dialog
- SSH connection failure during rename → error in rename dialog
- Remote not found in SSHPool → graceful error

**Edge Cases:**
- Git info cache expires → re-fetched on next request
- Preview for session that doesn't exist on remote → error handled
- Rapid key presses → cache prevents redundant SSH calls

**Success Criteria:**
- All tests pass
- No race conditions detected
- All 9 acceptance criteria verified

## Verification

- [ ] All acceptance criteria have corresponding test cases
- [ ] All tests pass with `go test -race`
- [ ] Error scenarios are covered
- [ ] Edge cases are covered
- [ ] Code quality checks pass (`make check`)

## Files Modified

- `internal/tui/e2e_remote_actions_test.go` - Created: 37 E2E test cases covering all 9 acceptance criteria (AC1-AC9), including happy path, error scenarios, and edge cases
