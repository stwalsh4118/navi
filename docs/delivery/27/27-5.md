# [27-5] TUI integration for remote preview

[Back to task list](./tasks.md)

## Description

Wire up the preview pane to fetch and display tmux output for remote sessions. Currently, the preview captures output via local `tmux capture-pane`, which silently fails for remote sessions (the tmux session doesn't exist locally). This task detects remote sessions and dispatches the capture via SSH using the `remote.CapturePane()` function from task 27-2.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 16:27:44 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-06 16:49:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-06 16:50:00 | Status Change | InProgress | Review | Implementation complete, all tests pass | AI_Agent |
| 2026-02-06 17:38:38 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- When the preview pane is visible and the cursor is on a remote session, fetch preview content via SSH instead of local tmux
- The three capture trigger points must all handle remote sessions:
  1. **Toggle on** (`p`/`Tab` key): dispatch remote capture if selected session is remote
  2. **Periodic refresh** (`previewTickMsg`): dispatch remote capture if selected session is remote
  3. **Cursor movement** (`previewDebounceMsg`): dispatch remote capture if cursor moves to a remote session
- The existing `capturePreviewCmd()` should be updated or a new `captureRemotePreviewCmd()` added
- Preview content display remains unchanged - `m.previewContent` is set the same way regardless of source
- Handle SSH errors gracefully - show error in preview pane rather than empty content
- Latency: SSH fetches may be slower than local tmux captures; the UI should remain responsive (async fetch)

## Implementation Plan

1. Add a new Bubble Tea command `captureRemotePreviewCmd(pool *SSHPool, remoteName, sessionName string) tea.Cmd` in `sessions.go`
2. Add a new message type or reuse `previewContentMsg` (it already has content + error fields)
3. Modify the three preview trigger points in `model.go`:
   - At each point, check if the selected session has `Remote != ""` and `m.SSHPool != nil`
   - If remote: dispatch `captureRemotePreviewCmd()` instead of `capturePreviewCmd()`
   - If local: keep existing behavior
4. The remote command calls `remote.CapturePane(pool, remoteName, sessionName, previewDefaultLines)`
5. Result is handled by the existing `previewContentMsg` handler (sets `m.previewContent`)
6. On error, set `m.previewContent` to an error message (e.g., "Failed to fetch remote preview: ...")

## Test Plan

- **Unit tests**:
  - Remote session dispatches remote capture command (not local)
  - Local session still dispatches local capture command
  - Preview content is set correctly from remote fetch result
  - SSH errors produce user-visible error message in preview pane
  - All three trigger points (toggle, tick, debounce) handle remote correctly
- **Integration consideration**: Full E2E flow tested in task 27-7

## Verification

- [ ] Preview works for remote sessions via SSH
- [ ] All three trigger points dispatch correctly for remote vs local
- [ ] Preview display is identical for remote and local content
- [ ] SSH errors shown gracefully in preview pane
- [ ] UI remains responsive during SSH fetch
- [ ] Code quality checks pass (`make check`)
- [ ] Unit tests pass

## Files Modified

- `internal/tui/model.go` - Updated p/tab, previewTickMsg, previewDebounceMsg, WindowSizeMsg handlers to use capturePreviewForSession
- `internal/tui/sessions.go` - Added captureRemotePreviewCmd(), capturePreviewForSession()
