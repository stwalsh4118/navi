# [27-2] Remote preview fetching via SSH

[Back to task list](./tasks.md)

## Description

Add a function to the `internal/remote` package that captures tmux pane output from a remote machine via SSH. This mirrors the local `capturePane()` function in `internal/tui/sessions.go` but executes the tmux command on the remote machine.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 16:27:44 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-06 16:45:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-06 16:46:00 | Status Change | InProgress | Review | Implementation complete, all tests pass | AI_Agent |

## Requirements

- Add a `CapturePane(pool *SSHPool, remoteName, sessionName string, lines int) (string, error)` function to `internal/remote/`
- Execute `tmux capture-pane -t <sessionName> -p -S -<lines>` on the remote via SSH
- Strip ANSI escape codes from the output (reuse existing `tui.StripANSI()` or factor it out to a shared location)
- Return cleaned, trimmed output matching the local preview format
- Handle errors gracefully (session doesn't exist, tmux not running, etc.)

## Implementation Plan

1. Create a new file `internal/remote/preview.go`
2. Implement `CapturePane()` that:
   - Constructs the tmux capture-pane command string
   - Calls `pool.Execute(remoteName, command)` to run it via SSH
   - Strips ANSI codes from the output
   - Trims trailing whitespace
   - Returns the cleaned output
3. Consider whether `StripANSI()` should be moved to a shared package or if the remote package can import from `tui` - if circular dependency, factor ANSI stripping into a shared utility (e.g., `internal/ansi/` or add to `internal/pathutil/`)
4. Write unit tests for output cleaning

## Test Plan

- **Unit tests**:
  - Output with ANSI codes is properly stripped
  - Empty output returns empty string without error
  - Trailing whitespace is trimmed
- **Integration consideration**: Full SSH + tmux integration tested in E2E task (27-7)

## Verification

- [ ] `CapturePane()` function exists and compiles
- [ ] ANSI stripping works correctly (no circular dependencies)
- [ ] Output matches local preview format
- [ ] Code quality checks pass (`make check`)
- [ ] Unit tests pass

## Files Modified

- `internal/remote/preview.go` (created) - CapturePane, stripANSI (local to avoid circular dep)
- `internal/remote/preview_test.go` (created) - Unit tests for ANSI stripping and output cleaning
