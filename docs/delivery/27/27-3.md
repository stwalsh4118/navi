# [27-3] Remote session actions via SSH

[Back to task list](./tasks.md)

## Description

Add functions to the `internal/remote` package for performing session management actions on remote machines via SSH: kill session, rename session, and dismiss session. These mirror the local implementations in `internal/tui/sessions.go` but execute commands on the remote machine.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 16:27:44 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-06 16:45:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-06 16:46:00 | Status Change | InProgress | Review | Implementation complete | AI_Agent |

## Requirements

### Kill Session
- Add `KillSession(pool *SSHPool, remoteName, sessionName, sessionsDir string) error`
- Execute `tmux kill-session -t <sessionName>` on the remote
- Remove the status file: `rm <sessionsDir>/<sessionName>.json`
- Both commands in a single SSH call

### Rename Session
- Add `RenameSession(pool *SSHPool, remoteName, oldName, newName, sessionsDir string) error`
- Execute `tmux rename-session -t <oldName> <newName>` on the remote
- Update the status file on the remote:
  - Read old file, update the `tmux_session` field in the JSON, write to new file, delete old file
  - This can be done with a shell script that uses a tool like `sed` or inline Python/jq, or by reading the file via SSH, modifying in Go, and writing back
- Both tmux rename and file operations in a single SSH call to minimize round trips

### Dismiss Session
- Add `DismissSession(pool *SSHPool, remoteName, sessionName, sessionsDir string) error`
- Update the status file on the remote to set status to "working", clear message, and update timestamp
- This requires reading the JSON, modifying fields, and writing back
- Can be done with a shell script using `jq` or similar, or with a sed-based approach

### General
- All functions must use the existing `SSHPool.Execute()` method
- `sessionsDir` comes from the remote's `Config.SessionsDir` field
- Use `$HOME` expansion (not `~`) in remote commands for shell compatibility
- Handle errors and return meaningful error messages

## Implementation Plan

1. Create a new file `internal/remote/actions.go`
2. Implement `KillSession()`:
   - Single SSH command: `tmux kill-session -t <name> ; rm -f "$HOME/.claude-sessions/<name>.json"`
   - Note: use `;` not `&&` so file cleanup happens even if tmux kill fails (session may already be dead)
3. Implement `RenameSession()`:
   - Construct a multi-line shell script that:
     a. Runs `tmux rename-session -t <old> <new>`
     b. Uses `sed` to update the `tmux_session` field in the JSON file
     c. Moves the old file to the new filename
   - Alternative: use `jq` if available, but `sed` is more universally available
4. Implement `DismissSession()`:
   - Construct a shell command that uses `sed` or similar to:
     a. Set `"status"` to `"working"`
     b. Clear `"message"` to `""`
     c. Update `"timestamp"` to current Unix time
   - Use `date +%s` on the remote to get the timestamp
5. Write unit tests that verify command construction

## Test Plan

- **Unit tests**:
  - Verify generated SSH command strings are correct for each action
  - Kill: command includes both tmux kill and file removal
  - Rename: command includes tmux rename and file update/move
  - Dismiss: command updates status, clears message, updates timestamp
- **Edge cases**:
  - Session names with special characters are properly quoted
  - sessionsDir with spaces is properly quoted
- **Integration consideration**: Full SSH integration tested in E2E task (27-7)

## Verification

- [ ] `KillSession()`, `RenameSession()`, `DismissSession()` functions exist and compile
- [ ] Commands are properly constructed with correct quoting
- [ ] All functions use `SSHPool.Execute()` for SSH operations
- [ ] Code quality checks pass (`make check`)
- [ ] Unit tests pass

## Files Modified

- `internal/remote/actions.go` (created) - KillSession, RenameSession, DismissSession, shellQuote, resolveSessionsDir
