# 42-6 E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification that the full audio notification pipeline satisfies PBI-42's Conditions of Satisfaction. Tests the complete flow from config loading → status-change detection → audio playback + TTS triggering.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-14 08:41:13 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-14 08:52:12 | Status Change | Proposed | Agreed | User requested implementation of PBI 42 | AI_Agent |
| 2026-02-14 08:52:12 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-14 08:57:01 | Status Change | InProgress | Review | Implementation complete | AI_Agent |
| 2026-02-15 11:48:19 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Verify all 8 acceptance criteria from PBI-42's prd.md
2. Test the full pipeline end-to-end with mock system binaries
3. Verify config-driven behavior (enable/disable triggers, file mappings, TTS, cooldown)
4. Verify graceful degradation when no audio backends available
5. All existing tests continue to pass (`go test -race ./...`)

## Implementation Plan

1. Create `internal/audio/audio_e2e_test.go`
2. Use test helper scripts as mock audio players/TTS engines (simple scripts that log calls to a temp file)
3. Test the full Notifier pipeline with real config loading and mock backends
4. Verify the TUI model integration detects status changes correctly in a simulated session update cycle

## Test Plan

### Objective
Verify PBI-42 Conditions of Satisfaction are met end-to-end.

### Test Scope
Full pipeline: config loading → notifier construction → status-change detection → player/TTS invocation.

### Environment & Setup
- Temp directory with test `sounds.yaml` config
- Mock player/TTS scripts that write to a log file instead of playing audio
- Test sound files (empty `.wav` files for path validation)

### Key Test Scenarios

1. **CoS 1 — Sound file playback**: Configure a status with a sound file → trigger status change → verify mock player was invoked with correct file path
2. **CoS 2 — Per-status mapping**: Configure different sound files for `permission`, `done`, `error` → trigger each → verify correct file played for each status
3. **CoS 3 — TTS announcement**: Enable TTS → trigger status change → verify mock TTS engine invoked with correct formatted text including session name
4. **CoS 4 — YAML configuration**: Load config from file → verify all fields parsed and applied correctly
5. **CoS 5 — Auto-detection**: With mock binaries on PATH → verify player and TTS engines detected
6. **CoS 6 — Non-blocking**: Trigger notification in tight loop → verify no goroutine deadlocks or panics (use `-race` flag)
7. **CoS 7 — Per-session cooldown**: Trigger same session twice within cooldown → verify only first fires. Trigger different session → verify it fires independently
8. **CoS 8 — Graceful degradation**: No player or TTS available → verify no panics, `Notify()` is silent no-op

### Success Criteria
- All 8 CoS scenarios pass
- `go test -race ./internal/audio/...` passes with zero failures
- `go test -race ./internal/tui/...` passes (existing tests unbroken)
- `go vet ./...` clean

## Verification

- `go test ./internal/audio` passed
- `go test ./internal/tui` passed
- `go test -race ./internal/audio/...` passed
- `go test -race ./internal/tui/...` passed
- `go vet ./...` passed
- `coderabbit review --base main --plain` completed

## Files Modified

- `internal/audio/audio_e2e_test.go` (new)
- `docs/api-specs/audio/audio-api.md` (new)
- `docs/api-specs/README.md` (updated)
