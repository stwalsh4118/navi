# 42-5 Integrate audio notifications into TUI model

[Back to task list](./tasks.md)

## Description

Hook the audio notification system into the TUI model's session update flow. Add previous-state tracking to detect status transitions and call the `Notifier` when sessions change status.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-14 08:41:13 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Add to `Model` struct:
   - `audioNotifier *audio.Notifier` — the notification manager
   - `lastSessionStates map[string]string` — tracks previous status per session (keyed by tmux session name)
2. Initialize audio notifier during model construction:
   - Load config from `~/.config/navi/sounds.yaml`
   - Create `Notifier` from config
   - Initialize empty `lastSessionStates` map
3. In `sessionsMsg` handler in `Update()`:
   - After merging sessions, compare each session's status against `lastSessionStates`
   - For each session where status changed: call `audioNotifier.Notify(sessionName, newStatus)`
   - Update `lastSessionStates` with current statuses
   - Skip notifications on first poll (when `lastSessionStates` is empty) to avoid startup noise
4. In `remoteSessionsMsg` handler:
   - Same state-change detection and notification logic for remote sessions
5. Audio notifications must not interfere with existing TUI behavior — no new messages or commands needed since playback is fire-and-forget

## Implementation Plan

1. Modify `internal/tui/model.go`:
   - Add `audioNotifier` and `lastSessionStates` fields to `Model`
   - Add initialization in model constructor / `New()` function
   - Add `detectStatusChanges()` helper method that compares sessions against `lastSessionStates`
   - Hook `detectStatusChanges()` into `sessionsMsg` and `remoteSessionsMsg` cases
2. Create `internal/tui/audio_integration_test.go` for testing the integration
3. Config path: use `~/.config/navi/sounds.yaml` (consistent with existing `~/.config/navi/` convention)

## Test Plan

- **Objective**: Verify status-change detection triggers notifications correctly
- **Mocking Strategy**: Inject a mock `Notifier` (or use interface) to record `Notify()` calls
- **Key Scenarios**:
  - **Status change detected**: Session goes from "working" to "permission" → `Notify("session", "permission")` called
  - **No change**: Same status on consecutive polls → no `Notify()` call
  - **New session appears**: Session not in `lastSessionStates` → skip notification (first-seen, not a "change")
  - **Session disappears**: Session removed from poll → cleaned from `lastSessionStates`
  - **Multiple sessions change**: Two sessions change status in same poll → both trigger `Notify()`
  - **Remote sessions**: Remote session status change detected and notified same as local
  - **First poll**: Empty `lastSessionStates` → populate map, no notifications fired
- **Success Criteria**: State-change detection is accurate, notifications fire only on actual transitions

## Verification

_To be completed during implementation._

## Files Modified

- `internal/tui/model.go` (modified — new fields, init logic, detection in Update())
- `internal/tui/audio_integration_test.go` (new)
