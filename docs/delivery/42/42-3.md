# 42-3 Implement TTS engine detection and speech

[Back to task list](./tasks.md)

## Description

Implement system TTS engine detection and non-blocking text-to-speech. The TTS engine auto-detects available system binaries and speaks announcement text via `exec.Command` without blocking the TUI.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-14 08:41:13 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-14 08:48:29 | Status Change | Proposed | Agreed | User requested implementation of PBI 42 | AI_Agent |
| 2026-02-14 08:48:29 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-14 08:49:08 | Status Change | InProgress | Review | Implementation complete | AI_Agent |
| 2026-02-15 11:48:19 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. `TTS` type with methods:
   - `NewTTS(override string) *TTS` — creates TTS, auto-detects if override is "auto"
   - `Speak(text string) error` — speaks text non-blocking (fire-and-forget goroutine)
   - `Available() bool` — returns whether a usable TTS engine was detected
   - `Backend() string` — returns name of detected TTS binary
2. Auto-detection order:
   - macOS: `say`
   - Linux: `espeak-ng`, `espeak`, `spd-say`
   - Detection via `exec.LookPath`
3. Template rendering: `FormatAnnouncement(template, session, status string) string`
   - Replaces `{session}` and `{status}` placeholders in template string
   - Default template: `"{session} — {status}"`
4. Non-blocking: `Speak()` launches in a goroutine, returns immediately
5. Errors logged but never propagated to caller (fire-and-forget)
6. Accept engine override from config to skip auto-detection

## Implementation Plan

1. Create `internal/audio/tts.go`
2. Create `internal/audio/tts_test.go`
3. Use `exec.LookPath` for detection, `exec.Command` for speech
4. Each TTS backend has different CLI flags:
   - `say "text"` (macOS)
   - `espeak-ng "text"` / `espeak "text"` (Linux)
   - `spd-say "text"` (Linux — speech-dispatcher)
5. TTS detection runs once at construction, result cached

## Test Plan

- **Detection with override**: `NewTTS("say")` uses specified binary
- **Detection with "auto"**: Falls through detection list
- **Available()**: Returns `false`/`true` appropriately
- **Backend()**: Returns correct binary name
- **FormatAnnouncement()**: Template substitution works correctly
  - `"{session} — {status}"` with session="navi", status="permission" → `"navi — permission"`
  - Empty template uses default
  - Template with no placeholders returned as-is
- **Speak() non-blocking**: Verify `Speak()` returns immediately

## Verification

- `go test ./internal/audio` passed

## Files Modified

- `internal/audio/tts.go` (new)
- `internal/audio/tts_test.go` (new)
