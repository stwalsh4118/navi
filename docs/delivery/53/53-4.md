# 53-4 E2E CoS Test

[Back to task list](./tasks.md)

## Description

Comprehensive end-to-end tests verifying all PBI-53 acceptance criteria for composite session status. This task validates the complete integration of composite status computation, rendering, and sorting working together.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 12:24:57 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-16 12:45:39 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-16 12:50:00 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-16 13:33:42 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

Verify all acceptance criteria:

1. Main session icon reflects highest-priority status across CC and all external agents.
2. When an external agent is the source, status message includes the agent source annotation.
3. When CC is the source, status message displays as before (no annotation).
4. Per-agent breakdown indicators show individual agent states when external agents are present.
5. Sessions with no external agents render identically to today — zero visual change.
6. Session sorting uses composite status logic consistently.
7. All existing tests pass; new tests cover composite status computation, message formatting, and rendering.

## Implementation Plan

1. Create integration test scenarios that exercise the full pipeline: `Info` struct → `CompositeStatus()` → `renderSession()` → verify output.
2. Test matrix covering multi-agent combinations:
   - CC only (no agents) — all statuses
   - CC + single external agent — all priority permutations
   - CC + multiple external agents — multi-way priority resolution
3. Sorting integration: verify sort order with mixed composite statuses across multiple sessions.
4. Regression: verify single-agent sessions produce byte-identical output to pre-PBI-53 behavior.
5. Run full test suite: `go test -race ./...` and `go vet ./...`.

## Test Plan

### Objectives
Validate that all PBI-53 acceptance criteria are met through integration-level tests.

### Test Scope
End-to-end tests spanning `internal/session` and `internal/tui` packages.

### Key Scenarios

**AC1 — Composite icon reflects highest priority**:
- CC idle + OC permission → main icon is ❓ (permission)
- CC working + OC waiting → main icon is ⏳ (waiting)
- CC idle + OC working → main icon is ⚙️ (working)
- CC error + OC permission → main icon is ❓ (permission)

**AC2 — Source annotation for external agents**:
- CC idle + OC working → message contains "(opencode)"
- CC idle + OC permission → message contains "(opencode)"

**AC3 — No annotation for CC source**:
- CC working + OC idle → message does NOT contain parenthetical annotation
- CC permission (no agents) → message does NOT contain parenthetical annotation

**AC4 — Per-agent breakdown indicators**:
- CC idle + OC working → both `[CC ⏸]` and `[OC ●]` visible
- CC working + OC working → only `[OC ●]` visible (composite matches CC, no CC indicator needed)

**AC5 — Single-agent regression**:
- For each status (working, idle, permission, waiting, stopped, error, done): render output matches pre-PBI-53 behavior exactly.

**AC6 — Sorting consistency**:
- Mixed sessions sort correctly: OC-permission session > OC-working session > CC-only idle session.
- Sorting by composite status matches composite priority order.

**AC7 — Existing tests pass**:
- Full `go test -race ./...` passes.
- `go vet ./...` clean.

### Success Criteria
- All new test cases pass.
- All existing tests pass unchanged.
- `go vet ./...` and `go test -race ./...` clean.

## Verification

- [x] All AC scenarios tested and passing
- [x] Full `go test -race ./...` passes
- [x] `go vet ./...` clean
- [x] No regressions in existing functionality

## Files Modified

- `internal/session/session_test.go` — integration-level composite status tests
- `internal/tui/view_test.go` — integration-level rendering tests with composite status
