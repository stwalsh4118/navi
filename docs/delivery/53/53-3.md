# 53-3 Sorting alignment with shared priority logic

[Back to task list](./tasks.md)

## Description

Verify and refactor `sessionSortTier()` in `internal/session/session.go` to use the shared priority logic from `CompositeStatus()` (Task 53-1), ensuring sorting and composite status use the same priority definitions.

Currently `sessionSortTier()` has hardcoded tier checks for `waiting`/`permission` (tier 0) and active external agents (tier 1). This should be refactored to use `CompositeStatus()` or the shared `StatusPriority` data so the priority semantics are defined once.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 12:24:57 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-16 12:42:44 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-16 12:45:18 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-16 13:33:27 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. `sessionSortTier()` uses `CompositeStatus()` or the shared `StatusPriority` constants — no duplicate priority definitions.
2. Sorting behavior remains functionally equivalent — same sessions sort to the same tiers.
3. Tier 0 (priority): composite status is `permission` or `waiting`.
4. Tier 1 (active): composite status is `working` (or any active status from an external agent).
5. Tier 2 (default): everything else.
6. Existing sorting tests continue to pass without modification (behavioral equivalence).

## Implementation Plan

1. Refactor `sessionSortTier()` to call `CompositeStatus(s)` and derive the tier from the composite status:
   - Composite status `permission` or `waiting` → tier 0.
   - Composite status `working` → tier 1.
   - Everything else → tier 2.
2. Remove `HasPriorityTeammate()`, `HasPriorityExternalAgent()`, and `hasActiveExternalAgent()` if they become unused after refactoring. If they are used elsewhere, keep them but document the relationship.
3. Verify all existing sort tests pass unchanged.

## Test Plan

1. **Existing tests pass**: All `TestSortSessions*` and `TestHasPriority*` tests pass without modification — confirms behavioral equivalence.
2. **Composite-driven tier 0**: Session with CC idle + OC permission sorts to tier 0 (same as before, now via composite).
3. **Composite-driven tier 1**: Session with CC idle + OC working sorts to tier 1.
4. **Team priority still works**: Session with team agent in permission still sorts to tier 0.

## Verification

- [x] All existing sort tests pass with `go test -race ./internal/session/...`
- [x] `go vet ./...` clean
- [x] No duplicate priority definitions remain

## Files Modified

- `internal/session/session.go` — refactor `sessionSortTier()` to use CompositeStatus, potentially remove helper functions
- `internal/session/session_test.go` — add any additional sort tests if gaps found
