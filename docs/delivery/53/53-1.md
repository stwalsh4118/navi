# 53-1 CompositeStatus function and unit tests

[Back to task list](./tasks.md)

## Description

Add a `CompositeStatus(s Info) (status string, source string)` function to `internal/session/session.go` that returns the highest-priority status across Claude Code (the root `Status` field) and all entries in the `Agents` map, along with which agent is the source.

Priority order (highest to lowest):
1. `permission` — any agent needs human input
2. `waiting` — any agent is waiting
3. `working` — any agent is actively working
4. `error` — any agent has errored
5. `idle` — all agents idle
6. `stopped` — all agents stopped
7. `done` — all agents done

When Claude Code is the source, `source` returns `""` (empty string — it's the default, no annotation needed). When an external agent is the source, `source` returns the agent type key (e.g., `"opencode"`).

Define a `statusPriority` map or ordered slice as a named constant/variable so the priority order is defined once and can be shared with sorting logic (Task 53-3).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 12:24:57 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Add `CompositeStatus(s Info) (string, string)` function to `internal/session/session.go`.
2. Define status priority as an exported ordered data structure (e.g., `StatusPriority []string` or `statusPriorityMap map[string]int`) so it can be reused by sorting.
3. When no external agents exist (`Agents` is nil or empty), return `(s.Status, "")` — identical to current behavior.
4. When multiple agents share the highest-priority status, Claude Code takes precedence (source returns `""`).
5. Add `StatusError` and `StatusDone` constants to complement the existing status constants.
6. Handle unknown/unexpected status strings gracefully — treat them as lowest priority.

## Implementation Plan

1. Add missing status constants (`StatusError = "error"`, `StatusDone = "done"`) to `internal/session/session.go`.
2. Define an exported `StatusPriority` slice listing statuses from highest to lowest priority: `[permission, waiting, working, error, idle, stopped, done]`.
3. Add a helper `statusRank(status string) int` that returns the index in the priority slice (lower index = higher priority), returning `len(StatusPriority)` for unknown statuses.
4. Implement `CompositeStatus(s Info) (string, string)`:
   - Start with Claude Code's status and empty source.
   - Iterate over `s.Agents` map entries.
   - If an agent's rank is higher (lower index) than the current best, update status and source.
   - If an agent's rank equals the current best and source is not empty, keep Claude Code (empty source wins ties).
   - Return the winning status and source.
5. Update `docs/api-specs/session/session-api.md` with the new function and constants.

## Test Plan

Unit tests in `internal/session/session_test.go`:

1. **No external agents**: `CompositeStatus` returns `(s.Status, "")` for each possible status value.
2. **Single agent, lower priority**: CC working + OC idle → returns `("working", "")`.
3. **Single agent, higher priority**: CC idle + OC working → returns `("working", "opencode")`.
4. **Single agent, equal priority**: CC working + OC working → returns `("working", "")` (CC wins ties).
5. **Permission trumps all**: CC working + OC permission → returns `("permission", "opencode")`.
6. **Multiple agents**: CC idle + OC working + another agent permission → returns `("permission", <that agent>)`.
7. **Unknown status**: Agent with unknown status string → treated as lowest priority.
8. **Empty agents map**: Behaves same as no external agents.
9. **Error status**: CC idle + OC error → returns `("error", "opencode")` confirming error is in priority order.
10. **Done status**: CC done + OC done → returns `("done", "")`.

## Verification

- [ ] All new unit tests pass with `go test -race ./internal/session/...`
- [ ] `go vet ./...` clean
- [ ] Existing session tests still pass
- [ ] API spec updated

## Files Modified

- `internal/session/session.go` — add constants, priority slice, statusRank helper, CompositeStatus function
- `internal/session/session_test.go` — add TestCompositeStatus test cases
- `docs/api-specs/session/session-api.md` — document new function and constants
