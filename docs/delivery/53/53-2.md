# 53-2 Composite status rendering and per-agent indicator updates

[Back to task list](./tasks.md)

## Description

Update `renderSession()` in `internal/tui/view.go` to use the composite status for the main session icon and message, and update per-agent indicator logic to show Claude Code's indicator when an external agent drives the composite status.

Three rendering changes:
1. **Main icon**: Use `StatusIcon(compositeStatus)` instead of `StatusIcon(s.Status)`.
2. **Status message**: When the composite source is an external agent, append `" (agenttype)"` to the status message — e.g., `"working (opencode)"`. When CC is source, display as today.
3. **Per-agent indicators**: When external agents exist and the composite status differs from CC's raw status, include a `[CC icon]` indicator alongside the external agent indicators so the user sees the full per-agent breakdown. When only CC is present (no external agents), no indicators shown — identical to today.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 12:24:57 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-16 12:39:04 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-16 12:42:22 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-16 13:33:10 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Main session icon reflects composite status, not just CC status.
2. Status message includes agent source annotation when an external agent drives the composite status.
3. CC indicator (`[CC icon]`) appears alongside external agent indicators when composite differs from CC status.
4. Sessions with no external agents render identically to today — zero visual change.
5. Color of main icon matches composite status (e.g., cyan for working even if CC is idle).
6. Preview panel agent detail section (`renderAgentDetail`) should also reflect composite status context.

## Implementation Plan

1. In `renderSession()`, call `session.CompositeStatus(s)` to get `compositeStatus` and `compositeSource`.
2. Replace `StatusIcon(s.Status)` with `StatusIcon(compositeStatus)` for the main icon.
3. When building the status message line, if `compositeSource != ""`, append ` (compositeSource)` to the displayed message.
4. Update `renderAgentIndicators()` to accept additional parameters: CC status and whether composite differs from CC. When composite differs and external agents exist, prepend a `[CC icon]` indicator showing CC's individual status.
5. Ensure that when `len(s.Agents) == 0`, the function returns empty string (no indicators) — unchanged from today.

## Test Plan

Unit tests in `internal/tui/view_test.go`:

1. **No external agents**: `renderSession()` output unchanged from current behavior.
2. **CC drives composite**: CC working + OC idle → main icon is working (⚙️), no source annotation, OC indicator shows idle.
3. **External agent drives composite**: CC idle + OC working → main icon is working (⚙️), message includes "(opencode)", CC indicator `[CC ⏸]` appears alongside `[OC ●]`.
4. **Permission from external agent**: CC working + OC permission → main icon is permission (❓), message includes "(opencode)", CC shows working indicator.
5. **Equal status**: CC working + OC working → main icon is working, no source annotation (CC wins), no CC indicator needed (composite matches CC).

## Verification

- [x] All new unit tests pass with `go test -race ./internal/tui/...`
- [x] `go vet ./...` clean
- [x] Existing view tests still pass
- [x] Visual spot-check: sessions with no agents look identical to before

## Files Modified

- `internal/tui/view.go` — update `renderSession()`, `renderAgentIndicators()`, and `renderAgentDetail()`
- `internal/tui/view_test.go` — add rendering tests for composite status scenarios
