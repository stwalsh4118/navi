# [29-4] Integrate ContentViewer with git diff view

[Back to task list](./tasks.md)

## Description

Replace the existing truncated `DialogGitDiff` view with the new scrollable `ContentViewer` using diff coloring mode. Currently the git diff dialog shows at most 20 lines of diff stat and truncates longer output. This task replaces that with a full, scrollable diff view using the ContentViewer component with diff syntax coloring from task 29-2.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-07 14:10:17 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-07 14:22:54 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-07 14:25:47 | Status Change | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2026-02-07 15:41:24 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- When the user opens the git diff dialog (existing `DialogGitDiff` mode), instead of the old truncated view, open the full diff in the ContentViewer with `ContentModeDiff`
- Use `git.GetDiff(dir)` to fetch the full diff content (currently capped at 100 lines via `DiffMaxLines` constant)
- Consider increasing or removing `DiffMaxLines` since the ContentViewer supports scrolling
- The content viewer title should indicate the git diff context (e.g. "Git Diff: <branch-name>")
- Preserve the ability to open git diffs from the git detail dialog or shortcut key
- The `DialogGitDiff` enum value can either be repurposed to trigger the ContentViewer or a new dialog transition can be added

## Implementation Plan

1. Modify the git diff dialog trigger in `model.go` to call `openContentViewer` with diff mode instead of setting `DialogGitDiff`
2. Pass the full diff from `git.GetDiff(dir)` as content
3. Set content viewer mode to `ContentModeDiff` for diff coloring
4. Set title to include the branch name (available from session's `Git.Branch`)
5. Optionally increase `DiffMaxLines` in `git/git.go` since scrolling is now supported
6. Remove or deprecate the old `renderGitDiffView()` function in `view.go` if fully replaced
7. Remove the `DialogGitDiff` enum value if no longer needed, or repurpose it

## Test Plan

- Unit test: opening git diff triggers the content viewer with diff mode
- Unit test: diff content is displayed with correct diff coloring (green/red)
- Unit test: content viewer title includes branch name
- Unit test: full diff content is scrollable (not truncated to 20 lines)
- Unit test: Esc closes the diff viewer and returns to the previous screen

## Verification

- [ ] Git diff displays in the ContentViewer with full scrolling
- [ ] Diff coloring works (green additions, red deletions, cyan hunk headers)
- [ ] Title shows branch context
- [ ] No content truncation (full diff is accessible via scrolling)
- [ ] Esc returns to previous screen
- [ ] Old truncated diff view is removed or replaced
- [ ] Code quality checks pass (`go vet`, `golangci-lint`)
- [ ] Tests pass

## Files Modified

- `internal/tui/model.go` - Changed "d" key handler in `updateDialog()` to open ContentViewer with diff mode instead of `DialogGitDiff`, added `contentViewerPrevDialog` field to Model, removed old Esc handling for `DialogGitDiff`
- `internal/tui/contentviewer.go` - Added `openContentViewerFrom()` method for return-to-dialog support, updated Esc handler to respect `contentViewerPrevDialog`
- `internal/tui/view.go` - Removed `renderGitDiffView()` function (fully replaced), removed `DialogGitDiff` case from `renderDialog()`
- `internal/git/git.go` - Increased `DiffMaxLines` from 100 to 5000 for scrollable viewer
- `internal/tui/e2e_git_test.go` - Updated `TestE2E_DiffPreview` tests to use ContentViewer
- `internal/tui/view_test.go` - Replaced `TestRenderGitDiffView` with `TestRenderGitDiffViaContentViewer` tests
