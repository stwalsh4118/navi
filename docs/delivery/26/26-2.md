# [26-2] Integrate token parsing with session loader

[Back to task list](./tasks.md)

## Description

Integrate the token parser with the session loading process so token metrics are populated for each session during the poll cycle.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-05 17:35:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-05 17:48:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-05 17:50:00 | Status Change | InProgress | Review | Integration complete | AI_Agent |
| 2026-02-05 18:31:18 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- Call token parser during session loading
- Populate TokenMetrics in session's Metrics struct
- Cache parsed results to avoid re-parsing unchanged files
- Handle sessions without transcript files gracefully

## Implementation Plan

1. Modify session loading in `sessions.go`:
   - After loading session JSON, call token parser
   - Use file modification time to detect changes
   - Cache results keyed by file path + mod time

2. Add caching mechanism:
   - Store last parsed tokens and file mod time
   - Skip re-parse if file unchanged
   - Clear cache entries for removed sessions

## Test Plan

- Test integration with session loader
- Test caching behavior
- Test handling of missing transcripts

## Verification

- [ ] Token metrics populated during session load
- [ ] Caching prevents unnecessary re-parsing
- [ ] Missing transcripts handled gracefully
- [ ] Tests pass

## Files Modified

- `sessions.go` - Added enrichSessionsWithTokens function, integrated into pollSessions
