# [26-1] Implement transcript token parser

[Back to task list](./tasks.md)

## Description

Create functions to parse Claude Code session transcript files (`.jsonl`) and extract token usage data. This includes path conversion utilities and token aggregation logic.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-05 17:35:00 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-05 17:40:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-05 17:45:00 | Status Change | InProgress | Review | Implementation complete | AI_Agent |
| 2026-02-05 18:31:18 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- Convert working directory path to Claude project folder format
- Find the appropriate .jsonl file for a session
- Parse JSONL format and extract token data from assistant messages
- Sum input tokens (including cache read/creation)
- Sum output tokens
- Handle missing or malformed data gracefully

## Implementation Plan

1. Add `tokens.go` file with:
   ```go
   // cwdToProjectPath converts a working directory to Claude's project folder name
   func cwdToProjectPath(cwd string) string

   // findSessionTranscript finds the most recent .jsonl file for a project
   func findSessionTranscript(projectPath string) (string, error)

   // ParseTranscriptTokens parses a .jsonl file and returns token counts
   func ParseTranscriptTokens(transcriptPath string) (*TokenMetrics, error)
   ```

2. JSONL parsing:
   - Read file line by line
   - Parse each line as JSON
   - Filter for `type: "assistant"` messages
   - Extract `message.usage` fields
   - Sum: input_tokens, output_tokens, cache_read_input_tokens, cache_creation_input_tokens

3. Handle edge cases:
   - File not found
   - Empty file
   - Malformed JSON lines
   - Missing usage fields

## Test Plan

**Medium complexity - test parsing logic:**

- Test cwdToProjectPath conversion
- Test token extraction from sample JSONL
- Test handling of missing/malformed data
- Test sum calculations

## Verification

- [ ] cwdToProjectPath converts paths correctly
- [ ] findSessionTranscript finds correct file
- [ ] Token parsing extracts all token types
- [ ] Sums are calculated correctly
- [ ] Edge cases handled gracefully
- [ ] Tests pass

## Files Modified

- `tokens.go` - Created with cwdToProjectPath, findSessionTranscript, ParseTranscriptTokens, GetSessionTokens
- `tokens_test.go` - Created with comprehensive tests
