# [54-1] Extend Type Contracts for Current-PBI Resolution

[Back to task list](./tasks.md)

## Description

Add new fields to the provider, session, and PM snapshot type contracts to support multi-strategy current-PBI resolution. These are purely additive type changes — no logic modifications.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 00:45:39 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 00:57:44 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 01:00:12 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 02:19:42 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. **Provider types** (`internal/task/types.go`):
   - Add `CurrentPBIID string` field to `ProviderResult` with JSON tag `"current_pbi_id,omitempty"` — explicit provider hint for which PBI is current.
   - Add `CurrentPBITitle string` field to `ProviderResult` with JSON tag `"current_pbi_title,omitempty"`.
   - Add `IsCurrent bool` field to `TaskGroup` with JSON tag `"is_current,omitempty"` — per-group current marker.

2. **Session types** (`internal/session/session.go`):
   - Add `CurrentPBI string` field to `Info` with JSON tag `"current_pbi,omitempty"` — session-scoped current PBI ID.
   - Add `CurrentPBITitle string` field to `Info` with JSON tag `"current_pbi_title,omitempty"`.

3. **PM snapshot types** (`internal/pm/types.go`):
   - Add `CurrentPBISource string` field to `ProjectSnapshot` with JSON tag `"current_pbi_source,omitempty"` — provenance of current-PBI selection.

4. All new fields must use `omitempty` to maintain backward compatibility with existing JSON files and provider outputs.

## Implementation Plan

1. Edit `internal/task/types.go` — add 3 fields (`CurrentPBIID`, `CurrentPBITitle` on `ProviderResult`; `IsCurrent` on `TaskGroup`).
2. Edit `internal/session/session.go` — add 2 fields (`CurrentPBI`, `CurrentPBITitle` on `Info`).
3. Edit `internal/pm/types.go` — add 1 field (`CurrentPBISource` on `ProjectSnapshot`).
4. Run `go vet ./...` and `go test -race ./...` to confirm no regressions.

## Test Plan

- TypeScript-style: compilation passes without errors.
- Existing tests continue to pass unchanged (new fields are zero-valued by default).
- Verify JSON round-trip: marshal a struct with new fields set, unmarshal it back, confirm values preserved.

## Verification

- [x] `go vet ./...`
- [x] `go test -race ./...`
- [x] JSON round-trip coverage added for provider, session, and PM snapshot types.
- [x] Internal AI review gate passed (`pass`).
- [ ] Deferred low finding: add explicit assertion for `CurrentPBISource` decode and `omitempty` marshal checks in future test-hardening task.

## Files Modified

- `internal/task/types.go` — add `ProviderResult.CurrentPBIID`, `ProviderResult.CurrentPBITitle`, `TaskGroup.IsCurrent`.
- `internal/task/types_test.go` — extend grouped-format parse test for new provider fields.
- `internal/session/session.go` — add `Info.CurrentPBI` and `Info.CurrentPBITitle`.
- `internal/session/session_test.go` — add `TestCurrentPBIJSONBehavior` round-trip/omitempty coverage.
- `internal/pm/types.go` — add `ProjectSnapshot.CurrentPBISource`.
- `internal/pm/types_test.go` — include `CurrentPBISource` in round-trip fixture.
