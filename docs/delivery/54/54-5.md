# [54-5] Update markdown-tasks Provider with Current-PBI Hint

[Back to task list](./tasks.md)

## Description

Modify the `markdown-tasks.sh` built-in provider to emit a `current_pbi_id` field in its JSON output, identifying the PBI most likely being actively worked on based on backlog status.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 00:45:39 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 01:05:41 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 01:07:24 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 02:19:42 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. After parsing all PBIs, detect the "current" PBI using this logic:
   - Find the first PBI with status `InProgress` (case-insensitive).
   - If no InProgress, find the first with status `Agreed`.
   - If neither, leave `current_pbi_id` unset.

2. Emit the hint in the top-level JSON output:
   ```json
   {
     "current_pbi_id": "PBI-54",
     "current_pbi_title": "Session-Scoped Current PBI Resolution for PM View",
     "groups": [...]
   }
   ```

3. Also mark the matching group with `"is_current": true` in the groups array.

4. If no current PBI is detected, omit `current_pbi_id` and `current_pbi_title` from the output (don't emit null/empty values).

5. Maintain backward compatibility — existing consumers that ignore unknown fields are unaffected.

## Implementation Plan

1. After the backlog parsing loop, scan `pbi_ids` for the first InProgress PBI (then Agreed as fallback).
2. Store the detected current PBI ID in a variable.
3. When building each group's JSON, add `is_current: true` if the group's PBI ID matches.
4. In the final JSON output, add `current_pbi_id` and `current_pbi_title` fields if a current PBI was detected.
5. Use `jq` to conditionally add fields.

## Test Plan

- Run the provider against the actual `docs/delivery/` directory and verify JSON output contains `current_pbi_id` when an InProgress PBI exists.
- Verify `is_current: true` appears on exactly one group.
- Verify output remains valid JSON parseable by `task.ParseProviderOutput`.
- Verify backward compatibility: output still has `groups` array with expected structure.

## Verification

- [x] `providers/markdown-tasks.sh | jq '{has_current: has("current_pbi_id"), current_pbi_id: .current_pbi_id, current_pbi_title: .current_pbi_title, current_groups: ([.groups[] | select(.is_current == true)] | length)}'`
- [x] `NAVI_TASK_ARG_STATUS_FILTER='Done' providers/markdown-tasks.sh | jq '{has_current: has("current_pbi_id"), current_groups: ([.groups[] | select(.is_current == true)] | length)}'` (verifies omission path)
- [x] `go test -race ./internal/task/...`
- [x] `go vet ./...`
- [x] Internal AI review gate passed (`pass`).

## Files Modified

- `providers/markdown-tasks.sh` — add current-PBI detection, top-level current hint emission, and per-group `is_current` annotation.
