# [54-6] Integrate Resolver into PM Snapshot Pipeline

[Back to task list](./tasks.md)

## Description

Replace the existing `getCurrentPBI` call in `CaptureSnapshot` with the new multi-strategy resolver, wiring session data, branch info, and provenance through the PM snapshot pipeline.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 00:45:39 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Modify `CaptureSnapshot` in `internal/pm/snapshot.go` to:
   - Accept sessions (already present) and use them in the resolver input.
   - Build `ResolverInput` with `TaskResult`, `Sessions`, `ProjectDir`, `Branch` (from git info), and nil `BranchPatterns` (use defaults).
   - Call `ResolveCurrentPBI(input)` instead of `getCurrentPBI(taskResult)`.
   - Set `snapshot.CurrentPBIID`, `snapshot.CurrentPBITitle`, and `snapshot.CurrentPBISource` from the result.

2. Remove or deprecate the old `getCurrentPBI` function (it becomes the fallback strategy inside the resolver).

3. Update existing tests in `snapshot_test.go` to account for the new `CurrentPBISource` field.

4. The `Engine.Run` method signature does not change â€” sessions are already available in the pipeline.

## Implementation Plan

1. Edit `internal/pm/snapshot.go`:
   - Replace `getCurrentPBI(taskResult)` call with `ResolveCurrentPBI(...)` call.
   - Remove the standalone `getCurrentPBI` function (its logic is now in the resolver's fallback strategy).
   - Pass `sessions` and `snapshot.Branch` to the resolver.
2. Update `internal/pm/snapshot_test.go`:
   - Adjust `TestCaptureSnapshot` to verify `CurrentPBISource` field.
   - Add test case for resolver integration (e.g., verify branch inference triggers when branch matches).
3. Run full test suite: `go test -race ./internal/pm/...`

## Test Plan

- **Existing tests**: `TestCaptureSnapshot` continues to pass (the test provides a single group, so fallback/heuristic resolves it).
- **Provenance field**: Verify `snapshot.CurrentPBISource` is populated after `CaptureSnapshot`.
- **Integration with branch**: When branch is `feature/pbi-46-pm-engine` and groups contain `PBI-46`, snapshot uses branch inference (or provider hint if it's also set).
- **Nil task result**: Snapshot has empty PBI fields and empty source (no crash).

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
