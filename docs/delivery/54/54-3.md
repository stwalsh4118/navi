# [54-3] Status-Priority Heuristic for Task Groups

[Back to task list](./tasks.md)

## Description

Implement a function that selects the most likely "current" PBI from a list of task groups based on PBI status priority rather than array order. This replaces the naive first-group heuristic with intelligent status-aware selection.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 00:45:39 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 01:03:13 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 01:05:28 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 02:19:42 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Create a function in `internal/pm/resolver.go` (or `heuristic.go`):
   ```go
   func selectGroupByStatus(groups []task.TaskGroup) (id string, title string, ok bool)
   ```
2. Status priority order (highest to lowest confidence):
   - `InProgress` — actively being worked on (highest priority)
   - `Agreed` — approved and ready for work
   - `InReview` — recently completed, still relevant
   - `Proposed` — not yet approved (low priority)
   - `Done` — completed (lowest priority, skip unless nothing else)
3. Case-insensitive status matching (use `strings.EqualFold` or normalize to lowercase).
4. Among groups with the same priority status, prefer the first one in array order (stable selection).
5. Skip groups with empty ID and empty Title (same guard as existing `getCurrentPBI`).
6. If no valid group found, return `("", "", false)`.

## Implementation Plan

1. Define status priority as a map or ordered list in `internal/pm/resolver.go`.
2. Implement `selectGroupByStatus` iterating groups, tracking the best match.
3. Create `internal/pm/resolver_test.go` with test cases.

## Test Plan

- **Single InProgress group**: Returns that group.
- **Mixed statuses**: InProgress wins over Agreed, Done, Proposed.
- **No InProgress, has Agreed**: Returns the Agreed group.
- **All Done**: Returns the first Done group.
- **Empty groups**: Returns `("", "", false)`.
- **Case insensitivity**: `"inprogress"`, `"InProgress"`, `"INPROGRESS"` all match.

## Verification

- [x] `go test -race ./internal/pm/...`
- [x] `go vet ./...`
- [x] Priority selection verified for `InProgress`, `Agreed`, `InReview`/`Review`, `Proposed`, and `Done`.
- [x] Stability verified: first group wins for equal-priority statuses.
- [x] Internal AI review gate passed (`pass`).

## Files Modified

- `internal/pm/resolver.go` — add status-priority heuristic and status normalization helper.
- `internal/pm/resolver_test.go` — add heuristic coverage for mixed-status, tie, empty/unknown, and case-insensitive scenarios.
