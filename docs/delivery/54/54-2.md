# [54-2] Branch-Pattern PBI Inference Utility

[Back to task list](./tasks.md)

## Description

Create a utility function that extracts a PBI ID from a git branch name using configurable regex patterns. This provides the branch-inference resolution strategy for the multi-strategy resolver.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 00:45:39 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 01:00:27 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 01:03:02 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 02:19:42 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Create `internal/pm/branchinfer.go` with a function:
   ```go
   func InferPBIFromBranch(branch string, patterns []string) (pbiID string, ok bool)
   ```
2. Default patterns (used when `patterns` is nil/empty):
   - `feature/pbi-(\d+)` — matches `feature/pbi-54-session-scoped-pbi-resolution`
   - `pbi-(\d+)` — matches `pbi-54/some-description` or `pbi-54`
   - `(\d+)-` — matches `54-session-scoped` (bare numeric prefix)
3. Patterns are tried in order; first match wins.
4. The returned `pbiID` should be the raw numeric string (e.g., `"54"`) without `PBI-` prefix — the caller adds prefix formatting.
5. If no pattern matches, return `("", false)`.
6. Patterns are standard Go `regexp` syntax; each must contain exactly one capture group for the PBI ID.

## Implementation Plan

1. Create `internal/pm/branchinfer.go`:
   - Define `DefaultBranchPatterns` as a package-level `[]string` variable.
   - Implement `InferPBIFromBranch` using `regexp.MustCompile` on first use (compile-once via sync.Once or pre-compiled var).
2. Create `internal/pm/branchinfer_test.go` with comprehensive test cases.

## Test Plan

- **Positive cases**: `feature/pbi-54-desc` → `"54"`, `pbi-12` → `"12"`, `pbi-99/task` → `"99"`.
- **Negative cases**: `main` → `("", false)`, `develop` → `("", false)`, `hotfix/auth-bug` → `("", false)`.
- **Custom patterns**: Verify user-provided patterns override defaults.
- **Edge cases**: Empty branch name, empty pattern list, pattern with no match.

## Verification

- [x] `go test -race ./internal/pm/...`
- [x] `go vet ./...`
- [x] Default pattern positives verified (`feature/pbi-54-*`, `pbi-12`, `54-*`).
- [x] Negative and edge cases verified (`main`, `develop`, `hotfix/*`, empty branch, invalid patterns).
- [x] Internal AI review gate passed after tightening default regex anchoring.

## Files Modified

- `internal/pm/branchinfer.go` — add default branch patterns and `InferPBIFromBranch` implementation with compile-once defaults.
- `internal/pm/branchinfer_test.go` — add coverage for positive, negative, custom-pattern, invalid-pattern, and priority scenarios.
