# [54-8] Provider-Agnostic Branch ID Resolution

[Back to task list](./tasks.md)

## Description

Address PR review feedback that branch-based current-PBI inference in the resolver currently hardcodes the `PBI-` prefix. Make branch inference provider-agnostic so custom provider ID formats can resolve correctly without breaking existing markdown-task behavior.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 06:25:05 | Created | N/A | Proposed | Follow-up task created from PR review feedback on hardcoded task prefix | AI_Agent |
| 2026-02-18 07:17:04 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 07:22:14 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 07:39:37 | Status Change | Review | Done | User approved task completion | AI_Agent |

## Requirements

1. Update resolver branch strategy in `internal/pm/resolver.go` to remove hardcoded `PBI-` ID formatting when handling branch inference results.
2. Add deterministic ID resolution logic for branch-inferred IDs against provider task groups:
   - Prefer exact case-insensitive group ID match when possible.
   - Support provider-specific prefixed IDs (for example `ISSUE-54`, `STORY-42`) when branch patterns capture numeric tokens.
   - Preserve compatibility with existing markdown provider behavior.
3. Ensure inferred ID resolution also drives title lookup so `CurrentPBITitle` remains accurate when a provider uses non-`PBI-` IDs.
4. Keep resolver precedence unchanged (provider hint -> session metadata -> branch pattern -> status heuristic -> first group fallback).
5. Extend tests to cover at least:
   - Existing `PBI-<id>` behavior remains unchanged.
   - Non-`PBI-` provider group IDs resolve correctly from branch inference.
   - No regressions in fallback behavior when no branch/group mapping exists.

## Implementation Plan

1. Add a helper in `internal/pm/resolver.go` to map branch-inferred tokens to provider group IDs without assuming a fixed prefix.
2. Update `resolveFromBranchPattern` to use this helper for both resolved ID and title lookup.
3. Add/adjust unit tests in `internal/pm/resolver_test.go` for resolver behavior with alternate provider ID formats.
4. Add/adjust integration scenarios in `internal/pm/resolver_integration_test.go` for provider-agnostic branch resolution.
5. Run targeted PM package tests, then full verification.

## Test Plan

- `go test -count=1 ./internal/pm/...`
- `go test -race -count=1 ./internal/pm/...`
- `go vet ./...`
- Validate resolver expectations for both `PBI-` and non-`PBI-` group ID schemas.

## Verification

- [x] `go test -count=1 ./internal/pm/...`
- [x] `go test -race -count=1 ./internal/pm/...`
- [x] `go vet ./...`
- [x] Branch inference returns provider-compatible IDs without hardcoded prefix assumptions.
- [x] Existing resolver precedence and fallback behavior remain unchanged.
- [x] Internal AI review gate passed (`pass`) with no unresolved findings.

## Files Modified

- `internal/pm/resolver.go` — remove hardcoded `PBI-` formatting in branch strategy and add provider-compatible ID resolution.
- `internal/pm/resolver_test.go` — add unit tests for non-`PBI-` provider ID branch resolution behavior.
- `internal/pm/resolver_integration_test.go` — add integration coverage for provider-agnostic branch inference path.
- `docs/delivery/54/54-8.md` — track task status transitions, verification outcomes, and implemented file list.
- `docs/delivery/54/tasks.md` — update task 54-8 status from Proposed to InProgress to Review.
- `docs/delivery/backlog.md` — set PBI 54 status to InProgress and append status history for follow-up implementation start.
