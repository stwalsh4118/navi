# [54-7] E2E CoS Test — Current-PBI Resolution

[Back to task list](./tasks.md)

## Description

End-to-end verification that all PBI 54 acceptance criteria are met. This task creates integration tests and runs live verification against the actual project structure.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 00:45:39 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 01:12:20 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 01:15:11 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 02:19:42 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

Verify all 7 acceptance criteria from the PBI PRD:

1. **AC1**: PM no longer relies solely on first provider group for current-PBI detection.
   - Test: Provide multiple groups with Done first, InProgress later — resolver picks InProgress, not first.

2. **AC2**: Provider output can mark a current PBI explicitly; resolver prefers this when present.
   - Test: Set `current_pbi_id` on ProviderResult — resolver uses it over all other strategies.
   - Test: Set `is_current: true` on a non-first group — resolver picks it.

3. **AC3**: Session-scoped current-work metadata can represent multiple concurrent sessions without collisions.
   - Test: Create multiple session Info structs with different `CurrentPBI` values for the same project — each retains its value independently.
   - Test: Resolver picks the freshest session's PBI.

4. **AC4**: Resolver supports configurable branch-pattern inference and falls back cleanly when patterns do not match.
   - Test: Custom patterns match branch names correctly.
   - Test: Non-matching branch falls through to next strategy.

5. **AC5**: Resolver uses stable status-priority heuristics when explicit signals are absent.
   - Test: Groups with InProgress/Agreed/Done statuses — InProgress wins.
   - Test: Multiple groups with same status — first in order wins (stable).

6. **AC6**: PM snapshot includes current-PBI provenance source for diagnostics.
   - Test: After `CaptureSnapshot`, `CurrentPBISource` is non-empty.
   - Test: Source values are one of the documented provenance strings.

7. **AC7**: Unit/integration tests cover provider-hint, session-scoped, branch-inferred, heuristic, and fallback paths.
   - Test: Verify test coverage exists for all 5 resolution strategies.

## Implementation Plan

1. Create `internal/pm/resolver_integration_test.go` with integration-level tests that exercise the full pipeline.
2. Run the markdown-tasks provider against `docs/delivery/` and verify `current_pbi_id` field is present.
3. Run `go test -race -count=1 ./internal/pm/...` and verify all tests pass.
4. Run `go vet ./...` to check for issues.
5. Document results in Verification section.

## Test Plan

### Objectives
Validate that the complete PBI 54 implementation satisfies all acceptance criteria end-to-end.

### Test Scope
- Full resolver pipeline from provider output to PM snapshot
- All 5 resolution strategies in isolation and combination
- Provider script JSON output format
- Backward compatibility with existing snapshot consumers

### Key Scenarios

| Scenario | Input | Expected |
|----------|-------|----------|
| Provider hint wins | `current_pbi_id` set + InProgress group + matching branch | Source = `"provider_hint"` |
| Session metadata wins | No provider hint, session has `CurrentPBI` set, branch matches | Source = `"session_metadata"` |
| Branch inference wins | No hints, branch `feature/pbi-54-desc`, matching group exists | Source = `"branch_pattern"` |
| Status heuristic wins | No hints, no branch match, InProgress group exists | Source = `"status_heuristic"` |
| Fallback wins | No hints, no branch match, all groups Done | Source = `"first_group_fallback"` |
| Multiple sessions | 2 sessions, different PBIs, same project | Freshest session's PBI used |
| Provider script | Run markdown-tasks.sh | JSON has `current_pbi_id` field |

### Success Criteria
- All tests pass with `-race` flag
- `go vet ./...` reports no issues
- Each acceptance criterion has at least one covering test

## Verification

- [x] `go test -race -count=1 ./internal/pm/...`
- [x] `go vet ./...`
- [x] `providers/markdown-tasks.sh | jq '{has_current: has("current_pbi_id"), current_pbi_id: .current_pbi_id, current_groups: ([.groups[] | select(.is_current == true)] | length)}'`
- [x] AC coverage verified in integration/unit tests:
  - AC1: non-first InProgress selected over first Done group.
  - AC2: provider `current_pbi_id` and `is_current` strategies both win at top precedence.
  - AC3: concurrent same-project session metadata resolves by freshest timestamp without collisions.
  - AC4: custom branch patterns supported; non-match falls through to next strategy.
  - AC5: status-priority ordering and same-status stable first-in-order selection covered.
  - AC6: snapshot includes non-empty, documented `current_pbi_source` values.
  - AC7: provider-hint, session-metadata, branch-pattern, status-heuristic, and fallback paths all exercised.
- [x] Internal AI review gate passed (`pass`) after adding AC5 tie-stability scenario.

## Files Modified

- `internal/pm/resolver_integration_test.go` — add integration-level CoS tests covering all resolver strategies, precedence, session concurrency freshness, custom branch patterns, and snapshot provenance.
