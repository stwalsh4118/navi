# [54-4] Current-PBI Multi-Strategy Resolver

[Back to task list](./tasks.md)

## Description

Implement the central resolver that determines the current PBI using a 5-level precedence chain with provenance tracking. This is the core logic that replaces the existing `getCurrentPBI` first-group heuristic.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 00:45:39 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create `ResolveCurrentPBI` function in `internal/pm/resolver.go`:
   ```go
   type ResolverInput struct {
       TaskResult     *task.ProviderResult
       Sessions       []session.Info
       ProjectDir     string
       Branch         string
       BranchPatterns []string // nil = use defaults
   }

   type ResolverResult struct {
       PBIID  string
       Title  string
       Source string // provenance: which strategy produced the result
   }

   func ResolveCurrentPBI(input ResolverInput) ResolverResult
   ```

2. Precedence chain (try in order, return first match):
   1. **`"provider_hint"`** — Check `TaskResult.CurrentPBIID`; if non-empty, use it. Also check groups for `IsCurrent == true`.
   2. **`"session_metadata"`** — Look through `Sessions` for ones matching `ProjectDir` (by CWD); find the freshest `CurrentPBI` value.
   3. **`"branch_pattern"`** — Call `InferPBIFromBranch(Branch, BranchPatterns)`; if matched, look up the group title from TaskResult groups.
   4. **`"status_heuristic"`** — Call `selectGroupByStatus(TaskResult.Groups)`.
   5. **`"first_group_fallback"`** — Use existing first non-empty group logic (legacy compatibility).

3. If no strategy resolves, return zero-value `ResolverResult`.

4. For `"branch_pattern"` strategy: format the returned numeric ID as `"PBI-<N>"` to match group IDs. Look up the matching group's Title for display.

5. For `"session_metadata"` strategy: match sessions by comparing their expanded CWD against `ProjectDir`. Use the session with the most recent `Timestamp` if multiple match.

## Implementation Plan

1. Add `ResolverInput` and `ResolverResult` types to `internal/pm/resolver.go`.
2. Implement `ResolveCurrentPBI` with the 5-level precedence chain.
3. Each strategy is a small helper (provider hint check, session scan, etc.).
4. Create comprehensive unit tests in `internal/pm/resolver_test.go`.

## Test Plan

- **Strategy 1 — Provider hint**: Set `CurrentPBIID` on ProviderResult → returns it with source `"provider_hint"`.
- **Strategy 1 — Group IsCurrent**: Set `IsCurrent: true` on a group → returns it with source `"provider_hint"`.
- **Strategy 2 — Session metadata**: Sessions with matching CWD and `CurrentPBI` set → returns freshest value with source `"session_metadata"`.
- **Strategy 3 — Branch pattern**: Branch `feature/pbi-54-desc` with matching group → returns `"PBI-54"` with source `"branch_pattern"`.
- **Strategy 3 — Branch pattern no group match**: Branch matches but no group has that ID → still returns the ID (title may be empty).
- **Strategy 4 — Status heuristic**: Multiple groups, InProgress wins → source `"status_heuristic"`.
- **Strategy 5 — Fallback**: No hints, no branch match, all groups Done → first group with source `"first_group_fallback"`.
- **Empty input**: Nil TaskResult, no sessions, empty branch → zero-value result.
- **Precedence**: When multiple strategies would match, higher-precedence wins.

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation._
