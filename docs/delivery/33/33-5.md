# [33-5] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification that all PBI-33 acceptance criteria are met. This task validates the full integration of hook changes, session data model updates, and TUI rendering for agent team awareness and permission status fixes.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-09 19:58:48 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

- Verify all 9 acceptance criteria from PBI-33 prd.md
- Test the complete flow from hook firing through JSON status file to TUI rendering
- Cover both the permission fix and agent team features
- Ensure no regressions in existing session display behavior

## Implementation Plan

1. **AC1 - Permission status clearing**: Simulate the hook sequence PermissionRequest â†’ PostToolUse and verify the session status transitions from "permission" to "working" in the JSON file
2. **AC2 - Teammate isolation**: Write a session JSON with teammate hook data and verify the main session status is not overwritten when teammate events fire
3. **AC3 - Team visibility**: Create a session JSON with team data and verify the TUI renders team name and agent count
4. **AC4 - Per-agent status**: Verify each agent in the team is rendered with its correct status icon and name
5. **AC5 - Real-time updates**: Verify that session polling picks up changes to team agent data within the polling interval
6. **AC6 - Team cleanup**: Verify that when all agents are removed or set to offline/done, the team info is cleaned up appropriately
7. **AC7 - No-team backward compatibility**: Verify that sessions without team data render identically to the current behavior
8. **AC8 - Existing test suite**: Run `go test -race ./...` and confirm all existing tests pass
9. **AC9 - New test coverage**: Confirm that tasks 33-1 through 33-4 each have passing tests for their respective features

## Test Plan

### Objective
Validate the full integration of PBI-33 features end-to-end.

### Test Scope
- Hook script behavior (notify.sh with and without teammate data)
- Session JSON file format with team data
- Go session model parsing of team JSON
- TUI rendering of team info inline
- Session sorting with teammate priority statuses
- Backward compatibility with existing sessions

### Key Test Scenarios

1. **Permission clearing flow**
   - Given: A session file with status "permission"
   - When: PostToolUse hook fires (simulated)
   - Then: Session status updates to "working"

2. **Teammate status isolation**
   - Given: A session file with status "working" and no team data
   - When: A hook fires with teammate_name in stdin JSON
   - Then: Main session status remains "working", team.agents[] is populated

3. **Multiple agents rendering**
   - Given: A session JSON with 3 agents (working, idle, permission)
   - When: TUI renders the session
   - Then: Session shows "[3 agents]" badge, each agent shown with correct icon

4. **Priority sorting with teammate permission**
   - Given: Two sessions - one with a teammate needing permission, one working
   - When: Sessions are sorted
   - Then: The session with the teammate permission sorts first

5. **Backward compatibility**
   - Given: A session JSON with no team field
   - When: TUI renders the session
   - Then: Output is identical to pre-PBI-33 rendering

6. **Team cleanup on all agents done**
   - Given: A session with all agents having status "done" or "offline"
   - When: TUI renders
   - Then: Team info shown but visually indicates completion

### Success Criteria
- All 9 acceptance criteria verified
- All existing tests pass with `go test -race ./...`
- No race conditions detected
- Hook scripts handle edge cases (missing jq, concurrent writes, empty stdin)

## Verification

- [ ] AC1: Permission status clearing works
- [ ] AC2: Teammate hooks don't overwrite main session status
- [ ] AC3: Team name and agent count visible
- [ ] AC4: Per-agent status icons rendered correctly
- [ ] AC5: Status updates reflected within polling interval
- [ ] AC6: Team cleanup when agents finish
- [ ] AC7: No visual change for sessions without teams
- [ ] AC8: All existing tests pass
- [ ] AC9: New tests cover all new features
- [ ] Code quality checks pass (go vet, go test -race)

## Files Modified

(empty - to be filled during implementation)
