# [33-1] Fix stale permission status with PostToolUse hook

[Back to task list](./tasks.md)

## Description

When a `PermissionRequest` hook fires, navi sets the session status to "permission" (displayed as a ❓ icon in the TUI). However, once the user approves the permission and the tool executes, the `PostToolUse` hook fires but only calls `tool-tracker.sh` (which tracks tool metrics). This means the "permission" status is never cleared back to "working", leaving a stale ❓ icon in the dashboard.

The fix is to add `notify.sh working` as an additional hook command for the `PostToolUse` event in `hooks/config.json`. Claude Code supports multiple hooks per event via the hooks array, so `notify.sh working` can run alongside the existing `tool-tracker.sh`. The notify script must be called before `tool-tracker.sh` so the status is set before metrics are updated.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-09 19:58:48 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

- Add `notify.sh working` as an additional hook command for the `PostToolUse` event in `hooks/config.json`
- The existing `tool-tracker.sh` must continue to work alongside it in the same event's hooks array
- `notify.sh working` must be listed BEFORE `tool-tracker.sh` in the hooks array so that session status is updated before metrics are written
- Update the install script (`install.sh` or equivalent) if it copies `config.json` to the Claude Code hooks directory
- No changes to `notify.sh` or `tool-tracker.sh` script logic are required

## Implementation Plan

1. Open `hooks/config.json` and locate the `PostToolUse` event configuration
2. Modify the `PostToolUse` entry to include an array of two hooks:
   - First: `notify.sh working` (clears permission status back to working)
   - Second: `tool-tracker.sh` (existing tool metrics tracking)
3. Verify the JSON is valid after editing
4. Check the install script to see if it copies `config.json`; if so, ensure the updated config will be installed correctly

## Test Plan

- **Config validation**: Verify `hooks/config.json` is valid JSON and the `PostToolUse` event has both hooks in the correct order
- **Manual verification**: After a `PermissionRequest` fires (setting status to "permission"), approve the permission and confirm that `PostToolUse` triggers `notify.sh working`, clearing the status back to "working" in the TUI
- **Regression**: Confirm `tool-tracker.sh` still receives stdin JSON and updates tool metrics correctly after the change

## Verification

- [ ] `hooks/config.json` has `PostToolUse` event with two hooks: `notify.sh working` first, `tool-tracker.sh` second
- [ ] JSON is valid and parseable
- [ ] Install script copies updated config correctly (if applicable)
- [ ] After a permission approval, TUI status returns to "working" instead of staying on "permission"
- [ ] Tool metrics tracking continues to function correctly

## Files Modified

(empty - to be filled during implementation)
