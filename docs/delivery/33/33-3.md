# [33-3] Refactor hook scripts for teammate-aware status writing

[Back to task list](./tasks.md)

## Description

Currently, `notify.sh` writes session status based on a positional argument (`$1`) and environment variables, without any awareness of Claude Code's team/agent concepts. When Claude Code operates in a team context, hook events fire for both the lead agent and teammate agents. The hooks need to differentiate between these cases so that teammate status updates are written to a `team.agents[]` array in the session JSON rather than overwriting the main session status.

This task refactors `notify.sh` to read stdin JSON (which all hooks receive from Claude Code) to extract `teammate_name`, `team_name`, and `hook_event_name`. When `teammate_name` is present, the script writes to the `team.agents[]` structure instead of the top-level session fields. When `teammate_name` is absent, the script behaves exactly as before for full backward compatibility.

Additionally, this task registers new hook events in `config.json` (`SubagentStart`, `SubagentStop`, `TeammateIdle`, `TaskCompleted`) and maps them to appropriate status values. `tool-tracker.sh` is also updated to skip processing when `teammate_name` is present (agent-level tool metrics are not tracked).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-09 19:58:48 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-09 20:07:51 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-09 20:10:31 | Status Change | InProgress | Review | Implementation complete, all tests passing | AI_Agent |
| 2026-02-09 21:45:49 | Status Change | Review | Done | Task completed and verified — includes stale event guard, SendMessage inference, SubagentStart/Stop skip, UserPromptSubmit cleanup | AI_Agent |

## Requirements

### notify.sh stdin parsing
- `notify.sh` must read stdin JSON to extract `teammate_name`, `team_name`, and `hook_event_name`
- The `$1` positional argument continues to be the primary status source for non-team events
- Use `jq` for JSON parsing of stdin

### Teammate-aware status writing
- When `teammate_name` is present in stdin JSON: write/update an entry in `team.agents[]` in the session JSON instead of overwriting the main session status
- When `teammate_name` is absent: behave exactly as before (full backward compatibility)
- Preserve existing team data when writing main session updates (do not blow away `team.agents[]`)
- Preserve existing main session data when writing team agent updates

### Session JSON team structure
- The team data must follow this structure in the session JSON:
  ```json
  {
    "team": {
      "name": "my-project",
      "agents": [
        {"name": "researcher", "status": "working", "timestamp": 1707506400},
        {"name": "implementer", "status": "idle", "timestamp": 1707506350}
      ]
    }
  }
  ```
- If an agent already exists in the array, update its entry in place
- If an agent does not exist, append it to the array
- `SessionEnd` from a teammate should remove the agent from the list or set status to "offline"

### New hook event registration
- Register the following new events in `hooks/config.json`:
  - `SubagentStart` → calls `notify.sh working`
  - `SubagentStop` → calls `notify.sh done`
  - `TeammateIdle` → calls `notify.sh idle`
  - `TaskCompleted` → calls `notify.sh done`
- Existing events that may fire for teammates must also work correctly:
  - `UserPromptSubmit` (from teammate) → agent status "working"
  - `PermissionRequest` (from teammate) → agent status "permission"
  - `Stop` (from teammate) → agent status "done"
  - `SessionEnd` (from teammate) → remove agent from list or set "offline"

### Event-to-status mapping
- `SubagentStart` → "working"
- `SubagentStop` → "done"
- `TeammateIdle` → "idle"
- `TaskCompleted` → "done"
- `UserPromptSubmit` (teammate) → "working"
- `PermissionRequest` (teammate) → "permission"
- `Stop` (teammate) → "done"
- `SessionEnd` (teammate) → "offline" / remove from list

### tool-tracker.sh update
- `tool-tracker.sh` must read stdin JSON and check for `teammate_name`
- When `teammate_name` is present, skip all processing and exit cleanly (agent-level tool metrics are not tracked)
- When `teammate_name` is absent, behave exactly as before

### Concurrency handling
- Multiple hooks may fire concurrently for different teammates or for lead + teammate simultaneously
- Use `jq` for atomic-ish JSON manipulation (read-modify-write)
- Consider file locking or temp file patterns to reduce race condition risk

### Install script
- Update the install script if it copies hook files or `config.json` to the Claude Code hooks directory

## Implementation Plan

1. **Modify `notify.sh` to read stdin JSON**:
   - Capture stdin into a variable at the start of the script (stdin is consumed once)
   - Use `jq` to extract `teammate_name`, `team_name`, and `hook_event_name` from the captured stdin
   - Branch logic: if `teammate_name` is non-empty, route to team agent status writing; otherwise, use existing logic

2. **Implement team agent status writing in `notify.sh`**:
   - Read the existing session JSON file
   - Use `jq` to upsert the agent entry in `.team.agents[]` (match by `name`, update `status` and `timestamp`)
   - Set `.team.name` from the stdin `team_name` field
   - Write the updated JSON back to the session file
   - For `SessionEnd` events: either remove the agent from the array or set status to "offline"

3. **Preserve team data in main session writes**:
   - In the existing (non-team) code path of `notify.sh`, read the current session JSON first
   - Preserve the `.team` object when writing the updated main session fields
   - This ensures that a main session status update does not blow away teammate data

4. **Register new hook events in `config.json`**:
   - Add `SubagentStart`, `SubagentStop`, `TeammateIdle`, `TaskCompleted` events
   - Each maps to the appropriate `notify.sh <status>` call

5. **Update `tool-tracker.sh`**:
   - Read stdin JSON and check for `teammate_name`
   - If present, exit 0 immediately without processing
   - If absent, pass the stdin data through to existing processing logic

6. **Handle concurrency**:
   - Use temp files and atomic moves (`mv`) for writes where possible
   - Use `jq` to do read-modify-write in a single pipeline to minimize race windows

7. **Update install script**:
   - Ensure the install script copies updated `config.json` and modified hook scripts

## Test Plan

### Backward compatibility tests
- **Main session status (no team context)**: Verify that `notify.sh working` without `teammate_name` in stdin writes the main session status exactly as before
- **Tool tracker (no team context)**: Verify that `tool-tracker.sh` processes tool metrics as before when no `teammate_name` is present
- **Existing hook events**: Verify `UserPromptSubmit`, `Stop`, `PermissionRequest`, `SessionEnd`, `PostToolUse` all work as before for the lead agent

### Teammate detection tests
- **teammate_name present**: Verify `notify.sh` routes to team agent writing when `teammate_name` is in stdin JSON
- **teammate_name absent**: Verify `notify.sh` uses existing main session logic when `teammate_name` is empty or missing
- **tool-tracker.sh skip**: Verify `tool-tracker.sh` exits cleanly without processing when `teammate_name` is present

### Team JSON structure tests
- **Agent upsert**: Verify that calling with a new `teammate_name` adds an entry to `team.agents[]`
- **Agent update**: Verify that calling with an existing `teammate_name` updates the existing entry (status, timestamp) rather than duplicating
- **Team name**: Verify `team.name` is set correctly from stdin `team_name`
- **Agent removal/offline**: Verify `SessionEnd` for a teammate removes or marks the agent as "offline"

### Data preservation tests
- **Main writes preserve team**: Verify that a main session status update does not remove or corrupt the `team` object
- **Team writes preserve main**: Verify that a team agent update does not remove or corrupt main session fields (status, metrics, etc.)

### Concurrent access tests
- **Simultaneous teammate updates**: Fire two teammate status updates concurrently and verify both are reflected correctly in the final JSON
- **Lead + teammate concurrent**: Fire a main session update and a teammate update concurrently and verify both are reflected correctly

### New hook event tests
- **SubagentStart**: Verify config.json registers the event and `notify.sh` writes agent status "working"
- **SubagentStop**: Verify config.json registers the event and `notify.sh` writes agent status "done"
- **TeammateIdle**: Verify config.json registers the event and `notify.sh` writes agent status "idle"
- **TaskCompleted**: Verify config.json registers the event and `notify.sh` writes agent status "done"

### Config validation
- Verify `hooks/config.json` is valid JSON after all additions
- Verify all new events point to the correct hook scripts

## Verification

- [ ] `notify.sh` reads stdin JSON and extracts `teammate_name`, `team_name`, `hook_event_name`
- [ ] Teammate events write to `team.agents[]` in session JSON with correct structure
- [ ] Non-teammate events write to main session status as before (backward compatible)
- [ ] Main session writes preserve existing `team` data
- [ ] Team agent writes preserve existing main session data
- [ ] `SessionEnd` for a teammate removes agent or sets "offline"
- [ ] Agent upsert works correctly (new agents added, existing agents updated)
- [ ] `tool-tracker.sh` skips processing when `teammate_name` is present
- [ ] `hooks/config.json` includes `SubagentStart`, `SubagentStop`, `TeammateIdle`, `TaskCompleted` events
- [ ] Event-to-status mapping is correct for all registered events
- [ ] Concurrent writes do not corrupt session JSON
- [ ] Install script copies updated files correctly
- [ ] All existing tests continue to pass

## Files Modified

- `hooks/config.json` — Added SubagentStart, SubagentStop, TeammateIdle, TaskCompleted hook events; changed SubagentStop status from "done" to "stopped"
- `hooks/notify.sh` — Refactored to read stdin JSON, detect teammate_name/team_name, branch to team agent upsert logic, preserve team data in main session writes, use atomic temp file writes. Added stale event guard using sidecar file to block teammate events from corrupting main session. Added SubagentStart/SubagentStop skip. Added Task spawn inference (registers new agents as "working"). Added SendMessage inference (message→working, shutdown_request→stopped, broadcast→all working). Added race condition guard preventing idle from overwriting stopped. Added UserPromptSubmit cleanup of stopped agents. Stores session_id on agent records from TeammateIdle events.
- `hooks/tool-tracker.sh` — Added teammate_name detection to skip processing for teammate events, preserve team data in writes, use atomic temp file writes
- `install.sh` — Added new hook types to HOOK_TYPES array
