# [37-7] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification of all PBI 37 acceptance criteria. This task validates that sorting, filtering, progress indicators, summary stats, navigation improvements, and manual refresh all work correctly together in the running TUI.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-12 07:40:26 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-12 07:59:39 | Status Change | Proposed | InProgress | Started E2E verification | AI_Agent |
| 2026-02-12 08:03:19 | Status Change | InProgress | Review | All 13 ACs verified, all tests pass | AI_Agent |
| 2026-02-12 08:49:09 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

Verify all 13 acceptance criteria from the PBI:

1. Groups can be sorted by source order, status priority, name, or progress. `s` cycles through modes. Current mode shown in header.
2. When group sort is `status`, tasks within groups are also sorted by status priority.
3. Groups can be filtered to show all, active-only, or incomplete-only. `f` cycles through modes. Current mode and hidden count shown in header.
4. Group headers show `[done/total]` with a mini progress bar for groups with tasks.
5. Header shows status breakdown across all groups (done/active/review/todo counts).
6. `J`/`K` jump between group headers, skipping tasks.
7. `e` toggles all groups expanded or collapsed.
8. `a` toggles accordion mode where expanding one group collapses others.
9. `r` triggers immediate provider re-execution and cache invalidation.
10. No keybinding conflicts with existing task panel or global keybindings.
11. Search works correctly with active filters (searches within filtered set).
12. Cursor remains on a valid item after sort/filter changes. If current item filtered out, cursor moves to nearest visible item.
13. All existing tests pass; new tests cover sorting, filtering, progress calculation, and navigation.

## Implementation Plan

1. Run full test suite (`cd api && make check`) to verify no regressions
2. Build the binary and run with a test project that has multiple task groups with varied statuses
3. Use Playwright MCP tools to verify TUI behavior if applicable, or manual verification checklist
4. Document verification results for each acceptance criterion

## Test Plan

### Objective
Verify all PBI 37 acceptance criteria are met in an integrated, running system.

### Test Scenarios

**Sorting (AC 1, 2)**:
- Cycle through all sort modes with `s`, verify group order changes correctly
- In status sort, verify tasks within groups are sorted by status priority

**Filtering (AC 3, 11)**:
- Cycle through filter modes with `f`, verify correct groups shown/hidden
- Apply filter, then search — verify search only matches within visible groups
- Clear filter, verify search state preserved; clear search, verify filter preserved

**Progress (AC 4, 5)**:
- Verify group headers show `[done/total]` and progress bars
- Verify header summary shows correct status breakdown

**Navigation (AC 6, 7, 8)**:
- Use `J`/`K` to jump between groups, verify tasks are skipped
- Use `e` to expand/collapse all, verify state
- Toggle accordion with `a`, verify expanding one group collapses others

**Refresh (AC 9)**:
- Press `r`, verify "Refreshing..." indicator, verify data updates

**Stability (AC 10, 12, 13)**:
- Verify no keybinding conflicts (all new keys work, existing keys unaffected)
- Change sort/filter while cursor is on a specific item, verify cursor stays or moves appropriately
- Run `go test -race ./...` — all tests pass

### Success Criteria
- All 13 acceptance criteria verified and passing
- No regressions in existing functionality
- All tests pass with race detector enabled

## Verification

- [x] All 13 acceptance criteria verified
- [x] No regressions in existing functionality
- [x] Full test suite passes with `-race`
- [x] Code quality checks pass (`go vet`, `gofmt`, `go test -race`)

### AC Verification Results

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| 1 | Sort by source/status/name/progress, `s` cycles, mode in header | PASS | `TestSortTaskGroups` (4 modes), `TestSortKeybinding`, `TestNextTaskSortMode`, header render tests |
| 2 | Status sort also sorts tasks within groups by priority | PASS | `TestSortTasksByStatus`, `statusPriority()` verified |
| 3 | Filter all/active/incomplete, `f` cycles, mode+hidden count in header | PASS | `TestFilterTaskGroups` (4 cases), `TestFilterKeybinding`, `TestNextTaskFilterMode`, header render tests |
| 4 | Group headers show `[done/total]` with progress bar | PASS | `TestGroupProgress` (5 cases), `TestGroupHeaderShowsProgress` (2 cases) |
| 5 | Header shows status breakdown (done/active/review/todo) | PASS | `TestGroupStatusCategory` (15 cases), `TestGroupStatusSummary`, `TestRenderStatusSummary` |
| 6 | `J`/`K` jump between group headers | PASS | `TestJumpToNextGroup` (3 cases), `TestJumpToPrevGroup` (2 cases) |
| 7 | `e` toggles expand/collapse all | PASS | `TestExpandCollapseAll` (2 cases) |
| 8 | `a` toggles accordion mode | PASS | `TestAccordionMode` (4 cases: toggle, collapse behavior, header indicator on/off) |
| 9 | `r` triggers refresh with cache invalidation | PASS | `TestManualRefresh` (6 cases: set flag, ignore duplicate, clear on tasksMsg, indicator on/off, cache invalidation) |
| 10 | No keybinding conflicts | PASS | All new keys (`s`, `f`, `J`, `K`, `e`, `a`, `r`) in `updateTaskPanelFocus()` only; no overlap with global/session keybindings |
| 11 | Search works with active filters | PASS | `TestFilterAndSearchIndependence`, search recomputation on filter change |
| 12 | Cursor stable after sort/filter changes | PASS | `TestCursorStabilityAfterSort`, `TestCursorStabilityAfterFilter`, `preserveTaskCursor()` implementation |
| 13 | All existing tests pass; new tests cover features | PASS | `go test -race -count=1 ./...` — all pass, 0 failures, 0 races; 78.5% coverage |

### Test Execution Summary

- **Total packages**: 8 (2 without test files)
- **All tests pass**: Yes, with `-race` flag and `-count=1` (no cache)
- **Race conditions**: None detected
- **Code formatting**: `gofmt` clean on all modified files
- **Static analysis**: `go vet ./...` clean

## Files Modified

(No files modified — this task is verification-only)
