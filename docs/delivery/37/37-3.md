# [37-3] Group and task sorting

[Back to task list](./tasks.md)

## Description

Add the ability to sort task groups by different criteria: source order (default), status priority, name (alphabetical), or progress (lowest completion first). When group sort is `status`, tasks within each group are also sorted by status priority. The `s` key cycles through sort modes and the current mode is shown in the header.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-12 07:40:26 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-12 07:54:11 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-12 07:55:31 | Status Change | InProgress | Review | Implementation complete, ready for review | AI_Agent |
| 2026-02-12 08:49:09 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- Add a `taskSortMode` field to the model with values: `source`, `status`, `name`, `progress`
- Default sort mode is `source` (current behavior)
- **Status sort order**: active > review > blocked > todo > done. Within the same status, preserve source order as a stable secondary sort
- **Name sort**: Alphabetical by group title (case-insensitive)
- **Progress sort**: Groups with lowest completion percentage first. Ties broken by source order
- When sort mode is `status`, tasks within each group are also sorted by status priority
- `s` keybinding cycles: source → status → name → progress → source
- Show current sort mode in header: `sort:<mode>` with dimmed styling (only shown when not `source`, to reduce noise)
- Cursor stability: after sort change, the cursor should remain on the same item (match by group/task ID). If the item is no longer visible, move to nearest valid position

## Implementation Plan

1. Define a `taskSortMode` type with constants for each mode in `model.go`
2. Add `taskSortMode` field to the model, defaulting to `source`
3. Implement sort functions:
   - `sortGroupsByStatus(groups []task.TaskGroup) []task.TaskGroup` — uses status priority ordering with source-order tiebreak
   - `sortGroupsByName(groups []task.TaskGroup) []task.TaskGroup` — case-insensitive alphabetical
   - `sortGroupsByProgress(groups []task.TaskGroup) []task.TaskGroup` — lowest completion % first, uses progress calculation from 37-1
   - `sortTasksByStatus(tasks []task.Task) []task.Task` — for within-group sorting
4. Add an `applySortToGroups()` method on the model that returns a sorted copy based on current sort mode
5. Integrate sorting into `getVisibleTaskItems()` (or the data path that feeds it) so sorted order is reflected
6. Add `s` keybinding in `updateTaskPanelFocus()` to cycle sort mode
7. Update `renderTaskPanelHeader()` to show `sort:<mode>` when mode is not `source`
8. Implement cursor stability: before sort, capture current item's group/task ID; after sort, find and restore cursor position
9. Add unit tests for each sort function and the cycle behavior

## Test Plan

- **Sort by status**: Groups ordered by status priority, source order preserved within same status
- **Sort by name**: Case-insensitive alphabetical ordering
- **Sort by progress**: Lowest completion first, source order tiebreak
- **Task sorting**: Within-group tasks sorted by status when group sort is `status`
- **Cycle behavior**: `s` cycles through all modes correctly and wraps
- **Cursor stability**: Cursor stays on same item after sort mode change
- **Header display**: Sort mode shown correctly, hidden when `source`
- All existing tests continue to pass

## Verification

- [x] All four sort modes produce correct ordering
- [x] Tasks within groups sorted by status when status sort active
- [x] `s` keybinding cycles through modes
- [x] Header shows current sort mode (hidden for `source`)
- [x] Cursor remains on same item after sort change
- [x] No keybinding conflicts with existing bindings
- [x] Code quality checks pass
- [x] Tests pass

## Files Modified

- `internal/tui/taskviewstate.go` — Sort functions: `sortTaskGroups()`, `sortTasksByStatus()`, `statusPriority()`, `nextTaskSortMode()`, `getSortedAndFilteredTaskGroups()`, `reverseTaskGroups()`
- `internal/tui/model.go` — Added `s`/`S` keybindings in `updateTaskPanelFocus()`, added `taskSortReversed` field, added `preserveTaskCursor()` for cursor stability; updated `getVisibleTaskItems()` to use filter/sort pipeline
- `internal/tui/taskview.go` — Sort indicator shows direction arrows (`↑`/`↓`)
- `internal/tui/view.go` — Updated task panel footer to show all new keybindings
- `internal/tui/taskview_sort_test.go` — New test file for sort functions, reverse sort, keybinding, and cursor stability
- `internal/tui/view_test.go` — Added `TestRenderFooterTaskPanel` for task panel footer keybindings
