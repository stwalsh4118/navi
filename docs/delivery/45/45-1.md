# 45-1 Extend TUI status change detection for external agents

[Back to task list](./tasks.md)

## Description

Add a parallel state map for tracking external agent statuses and extend `detectStatusChanges()` to iterate over `session.Info.Agents`, detecting transitions and firing audio notifications with composite keys (e.g., `"session:opencode"`) for independent cooldown tracking.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 09:06:46 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Add `lastAgentStates map[string]map[string]string` field to the TUI `Model` struct, keyed by `[sessionName][agentType]`.
2. Initialize `lastAgentStates` in `NewModel()`.
3. Extend `detectStatusChanges()` to:
   - Build current agent states from `session.Info.Agents` for each session.
   - On first poll, initialize agent states without emitting notifications (same pattern as main session).
   - On subsequent polls, compare against `lastAgentStates` and call notification for any changes.
   - Update `lastAgentStates` at the end of each cycle.
4. Add `notifyAgentStatusChange(sessionName, agentType, newStatus string)` method that calls `audioNotifyFn` or `audioNotifier.Notify()` with composite key `"sessionName:agentType"`.
5. Existing main-session notification behavior must remain unchanged.

## Implementation Plan

1. Add `lastAgentStates` field to `Model` struct in `internal/tui/model.go` near `lastSessionStates`.
2. Initialize the map in `NewModel()`.
3. Extend `detectStatusChanges()`:
   - After the existing main-session loop, iterate over `current` sessions.
   - For each session with non-empty `Agents`, compare each agent's status against `lastAgentStates[sessionName][agentType]`.
   - If changed, call `notifyAgentStatusChange()`.
   - Rebuild `lastAgentStates` from current data.
   - Handle first-poll initialization: if `lastAgentStates` has no entries for a session's agents, treat as initial (no notifications).
4. Add `notifyAgentStatusChange()` method using same pattern as `notifyStatusChange()` but with composite key.
5. Pass `lastAgentStates` through state handoff when starting/stopping attach monitor (update `startAttachMonitor`/`stopAttachMonitor`).

## Test Plan

- **TestDetectAgentStatusChangeFirstPollSkips**: Verify first poll with external agents initializes state without notifications.
- **TestDetectAgentStatusChangeFiresNotification**: Verify that when an external agent's status changes between polls, a notification fires with the composite key `"session:agent"`.
- **TestDetectAgentStatusChangeNoChangeNoNotify**: Verify that unchanged agent status does not fire.
- **TestDetectAgentAndSessionIndependent**: Verify that agent notifications and session notifications fire independently (agent change + session change in same poll = both fire).
- **TestDetectAgentStatusChangeNewAgentAppears**: Verify that a newly-appearing agent does not fire a notification (same as new session behavior).
- **TestSessionsMsgTriggersAgentNotification**: Verify that the `sessionsMsg` Update path triggers agent change detection.

## Verification

- `go vet ./...` clean
- `go test -race ./internal/tui/...` all pass
- All existing audio integration tests still pass

## Files Modified

- `internal/tui/model.go` — Add field, extend `detectStatusChanges()`, add `notifyAgentStatusChange()`
- `internal/tui/audio_integration_test.go` — New test cases for agent status change detection
