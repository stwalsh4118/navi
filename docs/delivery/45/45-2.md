# 45-2 Extend attach monitor for external agents

[Back to task list](./tasks.md)

## Description

Extend `internal/monitor/monitor.go` to track external agent statuses alongside main session statuses, so that agent status changes fire audio notifications while the user is attached to a tmux session.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 09:06:46 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Add `agentStates map[string]map[string]string` field to `AttachMonitor` struct, keyed by `[sessionName][agentType]`.
2. In the polling loop, after reading `currentSessions`, iterate over each session's `Agents` map and compare against stored `agentStates`.
3. On detected change, call `notifyFn` with composite key `"sessionName:agentType"` and the new status.
4. Support agent state handoff: add `AgentStates() map[string]map[string]string` getter and accept initial agent states in `Start()`.
5. Update `internal/tui/model.go` `startAttachMonitor()` and `stopAttachMonitor()` to pass `lastAgentStates` through the monitor.
6. Update monitor API spec.

## Implementation Plan

1. Add `agentStates` field to `AttachMonitor` struct.
2. Add `initialAgentStates` parameter to `Start()` method.
3. In the polling loop, after updating main session states:
   - Build current agent states from `currentSessions[].Agents`.
   - Compare against `m.agentStates` for each session/agent pair.
   - Call `notifyFn("session:agent", newStatus)` for changes.
   - Update `m.agentStates`.
4. Add `AgentStates()` method returning a deep copy.
5. Update `New()` to initialize `agentStates`.
6. Update TUI `startAttachMonitor()` to pass `m.lastAgentStates` as initial agent states.
7. Update TUI `stopAttachMonitor()` to read back `m.attachMonitor.AgentStates()` into `m.lastAgentStates`.
8. Update `docs/api-specs/monitor/monitor-api.md`.

## Test Plan

- **TestAttachMonitorNotifiesOnAgentStatusChange**: Write a status file with an external agent, start monitor, update the agent status, verify notification fires with composite key.
- **TestAttachMonitorAgentStateHandoff**: Verify agent states survive stop/restart via `AgentStates()` handoff without duplicate notifications.
- **TestAttachMonitorAgentAndSessionIndependent**: Verify both main session and agent changes fire independently in the same poll cycle.

## Verification

- `go vet ./...` clean
- `go test -race ./internal/monitor/...` all pass
- `go test -race ./internal/tui/...` all pass (state handoff integration)

## Files Modified

- `internal/monitor/monitor.go` — Add agent state tracking, `AgentStates()`, update `Start()` signature
- `internal/monitor/monitor_e2e_test.go` — New test cases for agent monitoring
- `internal/tui/model.go` — Update `startAttachMonitor()`/`stopAttachMonitor()` for agent state handoff
- `docs/api-specs/monitor/monitor-api.md` — Update API spec with new method and parameter
