# 45-3 E2E CoS verification

[Back to task list](./tasks.md)

## Description

Verify all PBI-45 acceptance criteria end-to-end. Ensure external agent status changes trigger audio notifications in both TUI and attached-monitor contexts, cooldowns are independent, and existing behavior is unchanged.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 09:06:46 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-16 09:36:12 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-16 09:38:43 | Status Change | InProgress | Review | Verification complete, internal AI review passed | AI_Agent |
| 2026-02-16 09:50:10 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Verify AC1: External agent status change → audio notification fires with same config.
2. Verify AC2: Independent cooldown — agent notification does not suppress session notification.
3. Verify AC3: Background attach monitor fires for agent changes.
4. Verify AC4: Existing main-session behavior unchanged.
5. Verify AC5: All tests pass including new coverage.

## Implementation Plan

1. Run full test suite: `go test -race ./...`
2. Run `go vet ./...`
3. Review test coverage for new code paths.
4. If any gaps found, add targeted test cases.
5. Document results.

## Test Plan

### Objectives
Validate all five acceptance criteria from PBI-45.

### Test Scope
- All unit tests in `internal/tui/` covering agent detection
- All unit tests in `internal/monitor/` covering agent monitoring
- All existing audio tests in `internal/audio/` (regression)
- All existing TUI audio integration tests (regression)

### Key Scenarios

1. **AC1 — Agent status change triggers audio**: Session with OpenCode agent, status changes from idle → permission. Verify notification fires with key `"session:opencode"` and status `"permission"`.
2. **AC2 — Independent cooldowns**: Same session, Claude Code changes to `permission` AND OpenCode changes to `permission` in same poll. Verify both notifications fire (different cooldown keys).
3. **AC3 — Attach monitor**: Monitor running, agent status changes in status file. Verify notification fires with composite key.
4. **AC4 — Regression**: Run all existing audio tests. Verify no behavioral changes to main-session notifications.
5. **AC5 — Test pass**: `go test -race ./...` passes cleanly.

### Success Criteria
- Zero test failures
- `go vet` clean
- All five ACs covered by automated tests

## Verification

- `go test -race ./...` — pass
- `go vet ./...` — clean
- Verification run timestamp: `2026-02-16 09:38:43`
- AC1 (agent status change notification): PASS via `TestDetectAgentStatusChangeFiresNotification` and `TestAttachMonitorNotifiesOnAgentStatusChange`
- AC2 (independent cooldown keys): PASS via `TestDetectAgentAndSessionIndependent` and `TestAttachMonitorAgentAndSessionIndependent`
- AC3 (attach monitor agent notifications): PASS via `TestAttachMonitorNotifiesOnAgentStatusChange` and `TestAttachMonitorAgentStateHandoff`
- AC4 (existing main-session behavior unchanged): PASS via existing TUI/audio regression tests in `go test -race ./...`
- AC5 (all tests pass): PASS

## Files Modified

- `docs/delivery/45/45-3.md` — Verification evidence and AC pass/fail results
