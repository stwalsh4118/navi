# [13-3] Implement status filtering and offline session toggle

[Back to task list](./tasks.md)

## Description

Add status filtering via number keys (1-5 to filter by individual status, 0 to clear) and an offline session visibility toggle via the `o` key. These filters compose with the existing Local/Remote filter (`f` key) and should be applied in the `getFilteredSessions()` pipeline.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 18:13:35 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-06 18:27:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-06 18:29:00 | Status Change | InProgress | Review | Implementation complete | AI_Agent |
| 2026-02-06 18:41:08 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- Handle number key presses in `Update()`:
  - `1` → filter to "waiting" sessions only
  - `2` → filter to "permission" sessions only
  - `3` → filter to "working" sessions only
  - `4` → filter to "done" sessions only
  - `5` → filter to "error" sessions only
  - `0` → clear status filter (show all)
- Pressing the same number key again should clear the filter (toggle behavior)
- Handle `o` key to toggle `showOffline` — when false, hide sessions with no recent activity or "done" status
- Integrate status filtering and offline filtering into `getFilteredSessions()`:
  - Apply status filter: only include sessions matching `m.statusFilter` (if non-empty)
  - Apply offline filter: exclude "done" or stale sessions when `m.showOffline` is false
- These filters must compose with the existing Local/Remote `filterMode`
- Reset cursor to 0 when filter changes to avoid out-of-bounds
- Number key handlers must NOT activate when a dialog is open or search mode is active

## Implementation Plan

1. Add `filterByStatus(sessions []session.Info, status string) []session.Info` in `internal/tui/filter.go`
2. Add `filterOffline(sessions []session.Info) []session.Info` in `internal/tui/filter.go`
3. Update `Update()` in `model.go` to handle keys `0`-`5` and `o`:
   - Only when `DialogMode == DialogNone` and `searchMode == false`
   - Set `m.statusFilter` based on key mapping
   - Toggle `m.showOffline` for `o`
   - Reset `m.cursor` to 0 on filter change
4. Update `getFilteredSessions()` to chain: existing Local/Remote filter → status filter → offline filter → sort

## Test Plan

- **Objective**: Verify status filtering and offline toggle work correctly
- **Test Scope**: Filter functions and their composition
- **Key Scenarios**:
  - Filter by each status: only matching sessions returned
  - Clear filter (key 0): all sessions returned
  - Toggle behavior: pressing same key twice clears filter
  - Offline toggle: done sessions hidden when showOffline=false
  - Filter composition: status filter + local/remote filter applied together
  - Empty result after filter: no panic, shows appropriate message
- **Success Criteria**: All filter combinations produce correct results; cursor resets properly

## Verification

- [ ] Number keys 1-5 set correct status filter
- [ ] Key 0 clears status filter
- [ ] Same key toggle clears the filter
- [ ] `o` toggles offline session visibility
- [ ] Filters compose with existing Local/Remote filter
- [ ] Cursor resets on filter change
- [ ] Keys ignored during dialog/search mode
- [ ] Existing tests pass
- [ ] `go build ./...` succeeds

## Files Modified

- `internal/tui/model.go` — Added key handlers for `0`-`5` (status filter), `o` (offline toggle) with cursor clamping
- `internal/tui/filter.go` — filterByStatus/filterOffline functions (added in 13-1)
