# [13-6] E2E CoS Test for Search & Filter

[Back to task list](./tasks.md)

## Description

End-to-end verification that all acceptance criteria from PBI 13 are met. This task creates integration tests that exercise the full search, filter, and sort pipeline, validating the complete user workflow from key press to rendered output.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 18:13:35 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-06 18:41:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-06 18:48:00 | Status Change | InProgress | Review | All E2E tests passing | AI_Agent |

## Requirements

Verify all 9 acceptance criteria from PBI 13:

1. `/` opens search mode with fuzzy matching
2. Search filters session list in real-time
3. Number keys (0-5) toggle status filters
4. `o` toggles offline session visibility
5. `s` cycles through sort modes
6. Current filter/sort state shown in footer
7. Filtered count displayed (e.g., "3/8 shown")
8. `Esc` clears search and filters
9. Cursor position preserved when possible during filtering

## Implementation Plan

1. Create test file `internal/tui/e2e_search_filter_test.go`
2. Write integration tests using the Bubble Tea test pattern (send messages, check model state and view output):
   - **Test search mode**: Send `/` key → verify `searchMode` is true → type query → verify sessions filtered → send `Esc` → verify search cleared
   - **Test status filters**: Send number keys → verify `statusFilter` set → verify filtered sessions → send `0` → verify filter cleared
   - **Test offline toggle**: Send `o` → verify `showOffline` toggled → verify offline sessions hidden/shown
   - **Test sort cycling**: Send `s` repeatedly → verify `sortMode` cycles through all 5 modes → verify session order changes
   - **Test footer display**: Activate filters/sort → verify footer view output contains expected indicators
   - **Test session count**: Apply filter → verify "X/Y shown" in view output
   - **Test Esc behavior**: Activate search → send `Esc` → verify search cleared → verify other state unaffected
   - **Test cursor preservation**: Select a session → apply filter that keeps it → verify cursor stays on same session
   - **Test cursor reset**: Select a session → apply filter that excludes it → verify cursor resets to 0
   - **Test filter composition**: Apply status filter + search + sort → verify all compose correctly
3. Run all tests and verify they pass

## Test Plan

- **Objective**: Verify all PBI 13 acceptance criteria are met end-to-end
- **Test Scope**: Full pipeline from key input through model update to view rendering
- **Environment**: Uses Bubble Tea model testing (construct model, send messages, inspect state and view output)
- **Key Scenarios**: Each of the 9 acceptance criteria mapped to at least one test case, plus composition tests
- **Success Criteria**: All tests pass; all 9 acceptance criteria verified

## Verification

- [ ] Test for AC1: `/` opens search mode with fuzzy matching
- [ ] Test for AC2: Search filters session list in real-time
- [ ] Test for AC3: Number keys (0-5) toggle status filters
- [ ] Test for AC4: `o` toggles offline session visibility
- [ ] Test for AC5: `s` cycles through sort modes
- [ ] Test for AC6: Current filter/sort state shown in footer
- [ ] Test for AC7: Filtered count displayed
- [ ] Test for AC8: `Esc` clears search and filters
- [ ] Test for AC9: Cursor position preserved when possible
- [ ] All tests pass
- [ ] `go test ./...` passes

## Files Modified

- `internal/tui/e2e_search_filter_test.go` (new) — E2E tests for all 9 acceptance criteria plus composition, key routing, and unit tests for filter/sort/fuzzy functions
