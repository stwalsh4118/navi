# [13-2] Implement session sort modes with key handler

[Back to task list](./tasks.md)

## Description

Implement the sorting logic for each of the five sort modes (Priority, Name, Age, Status, Directory) and wire up the `s` key to cycle through them. The sort should be applied as part of the `filteredSessions()` pipeline so that all displayed sessions respect the active sort mode.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 18:13:35 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-06 18:22:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-06 18:26:00 | Status Change | InProgress | Review | Implementation complete | AI_Agent |
| 2026-02-06 18:41:08 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

- Implement a `sortSessions(sessions []session.Info, mode SortMode) []session.Info` function that sorts a copy of the session slice according to the active mode:
  - **Priority** (default): Attention-needed statuses first (waiting, permission), then by timestamp descending — this matches the existing `session.SortSessions()` behavior
  - **Name**: Alphabetical by `TmuxSession` (case-insensitive)
  - **Age**: Most recent `Timestamp` first
  - **Status**: Grouped by status type (e.g., permission → waiting → working → done → other)
  - **Directory**: Grouped by `CWD`, alphabetically, then by name within groups
- Add `s` key handler in `Update()` to cycle sort mode: Priority → Name → Age → Status → Directory → Priority
- Integrate sorting into the `getFilteredSessions()` or equivalent method so the sorted order is used in rendering
- Ensure the existing `session.SortSessions()` remains available for the Priority mode
- Must not sort in-place on `m.sessions` — work on a copy so polling doesn't conflict

## Implementation Plan

1. Add sort functions in `internal/tui/filter.go` (or a new `sort.go` if cleaner):
   - `sortSessions()` function with a `switch` on `SortMode`
   - Individual sort comparators for each mode
2. Update `Update()` in `model.go` to handle `s` key press — cycle `m.sortMode` to the next value
3. Modify `getFilteredSessions()` (currently in `model.go` around line 960) to call `sortSessions()` on the result before returning
4. Ensure cursor position is preserved or reset appropriately when sort mode changes

## Test Plan

- **Objective**: Verify each sort mode produces the correct ordering
- **Test Scope**: `sortSessions()` function with various session slices
- **Key Scenarios**:
  - Priority sort: sessions with "permission" and "waiting" appear first
  - Name sort: alphabetical ordering, case-insensitive
  - Age sort: most recent timestamp first
  - Status sort: sessions grouped by status value
  - Directory sort: sessions grouped by CWD
  - Empty session list: no panic
  - Single session: returned as-is
- **Success Criteria**: All sort modes produce expected ordering; existing tests pass

## Verification

- [ ] `sortSessions()` handles all 5 sort modes correctly
- [ ] `s` key cycles through all sort modes
- [ ] Sort is applied in the rendering pipeline
- [ ] Original `m.sessions` slice is not mutated
- [ ] Existing tests pass
- [ ] `go build ./...` succeeds

## Files Modified

- `internal/tui/model.go` — Added `s` key handler; rewrote `getFilteredSessions()` with full pipeline (local/remote → status → offline → fuzzy → sort)
- `internal/tui/filter.go` — Sort functions already added in 13-1; refined SortPriority to pass-through (data pre-sorted during polling)
