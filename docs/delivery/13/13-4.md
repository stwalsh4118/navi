# [13-4] Implement fuzzy search mode with real-time filtering

[Back to task list](./tasks.md)

## Description

Implement fuzzy search mode activated by pressing `/`. When active, a text input captures the search query and sessions are filtered in real-time using fuzzy subsequence matching against session name, working directory, and message content. `Esc` clears the search and exits search mode. While in search mode, navigation keys (up/down/j/k) and action keys should still work, but other single-character keys are captured by the search input.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-06 18:13:35 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-06 18:30:00 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-06 18:34:00 | Status Change | InProgress | Review | Implementation complete | AI_Agent |

## Requirements

- `/` key enters search mode:
  - `m.searchMode = true`
  - Focus the `searchInput` text input
  - Search bar becomes visible (rendering handled in task 13-5)
- Implement a fuzzy subsequence matching function `fuzzyMatch(query, target string) (bool, int)`:
  - Returns whether the target contains the query as a subsequence, plus a relevance score
  - Case-insensitive matching
  - Score higher for consecutive character matches, start-of-word matches
- Implement `fuzzyFilter(sessions []session.Info, query string) []session.Info`:
  - Match against `TmuxSession`, `CWD`, and `Message` fields
  - A session matches if any field matches
  - Sort results by best match score
- Integrate fuzzy filtering into `getFilteredSessions()` pipeline:
  - Apply after status/offline filters but before sort
- `Esc` behavior when search is active:
  - First press: clear search query and exit search mode
  - If search is already clear, `Esc` proceeds to clear other filters or normal Esc behavior
- While in search mode:
  - Character key presses go to the search input (not treated as hotkeys)
  - `up`/`down`/`enter` still navigate and select sessions
  - Number keys go to search input (not status filter)
- Search persists across poll updates (session list refreshes don't clear search)

## Implementation Plan

1. Implement `fuzzyMatch()` in `internal/tui/filter.go`:
   - Simple subsequence algorithm: iterate through query chars, find each in target
   - Score based on: consecutive matches (+2), start-of-word matches (+3), gap penalty (-1)
   - Case-insensitive via `strings.ToLower()`
2. Implement `fuzzyFilter()` in `internal/tui/filter.go`:
   - For each session, check match against name, CWD, message
   - Take best score across fields
   - Filter to sessions with at least one match
   - Sort by score descending
3. Update `Update()` in `model.go`:
   - `/` key: set `searchMode = true`, focus `searchInput`
   - When `searchMode` is true: forward key events to `searchInput.Update()`, except for navigation keys
   - `Esc` in search mode: clear query + unfocus + set `searchMode = false`
   - After each search input change, update `m.searchQuery` from `searchInput.Value()`
4. Update `getFilteredSessions()` to include fuzzy filtering step when `m.searchQuery != ""`

## Test Plan

- **Objective**: Verify fuzzy matching algorithm and search mode behavior
- **Test Scope**: `fuzzyMatch()`, `fuzzyFilter()`, and search mode key handling
- **Key Scenarios**:
  - Exact substring match: "api" matches "my-api-server"
  - Subsequence match: "msr" matches "my-server" (m...s...r is not right, better: "mas" matches "my-api-server")
  - Case insensitivity: "API" matches "my-api-server"
  - No match: "xyz" does not match "my-api-server"
  - Match against CWD: searching a path fragment finds the session
  - Match against message: searching message content finds the session
  - Empty query: all sessions returned
  - Score ordering: closer matches ranked higher
- **Success Criteria**: Fuzzy matching is accurate, real-time filtering works, Esc handling correct

## Verification

- [ ] `/` enters search mode
- [ ] Characters typed appear in search input
- [ ] Sessions filter in real-time as user types
- [ ] Fuzzy subsequence matching works correctly
- [ ] Match is case-insensitive
- [ ] Matches against session name, CWD, and message
- [ ] `Esc` clears search and exits search mode
- [ ] Navigation keys work during search mode
- [ ] Search persists across poll refreshes
- [ ] Existing tests pass
- [ ] `go build ./...` succeeds

## Files Modified

- `internal/tui/model.go` — Added `/` key handler, `esc` key handler for filter clearing, `updateSearchMode()` method for search input routing
- `internal/tui/filter.go` — fuzzyMatch/fuzzyFilter functions (added in 13-1)
