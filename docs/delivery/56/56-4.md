# 56-4 Notifier Integration — Pack Resolution, Volume, Random Selection, and Mute

[Back to task list](./tasks.md)

## Description

Wire the sound pack scanner (56-2), volume control (56-3), and random sound selection into the Notifier. Update the `Notify()` flow to: (1) check mute state, (2) resolve sound file via pack → files override → fallback, (3) select randomly when multiple files exist, (4) calculate effective volume, (5) play with volume. Add `SetMuted()`/`IsMuted()` methods for mute state control. This is the central integration task that connects all new audio features.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 04:44:42 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Add `packFiles map[string][]string` field to Notifier — loaded at construction from Config.Pack
2. Add `muted bool` and `mu sync.Mutex` protection for mute state
3. `SetMuted(muted bool)` and `IsMuted() bool` methods (thread-safe)
4. Sound resolution order in `Notify()`:
   a. If `cfg.Files[status]` has explicit path → use it (single file, no randomization)
   b. Else if pack loaded and pack has files for status → select from pack files
   c. Else → no sound
5. Random selection: when multiple files exist for an event, pick one using `rand.IntN(len(files))`
6. Volume calculation: call `cfg.Volume.EffectiveVolume(status)` → pass to `Player.Play(file, volume)`
7. Mute check: if `IsMuted()`, skip all sound and TTS (early return after cooldown check)
8. TTS also silenced when muted
9. `NewNotifier()` loads pack files at construction if `cfg.Pack` is set
10. Update audio API spec

## Implementation Plan

1. Add `muted` field and `SetMuted()`/`IsMuted()` to Notifier
2. Add `packFiles` field, populated in `NewNotifier()` via `ResolveSoundFiles(cfg.Pack)` if pack set
3. Add `resolveSound(status string) string` private method implementing resolution order
4. Add random selection logic using `rand.IntN`
5. Update `Notify()` flow: mute check → cooldown → resolve sound → calculate volume → play with volume → TTS
6. Update `NewNotifier()` constructor
7. Write unit tests: mute, pack resolution, files override, random selection, volume passing
8. Update `docs/api-specs/audio/audio-api.md`

## Test Plan

### Objectives
Verify that the Notifier correctly integrates pack resolution, volume, random selection, and mute state.

### Key Scenarios
- **Mute**: When muted, `Notify()` produces no sound and no TTS
- **Unmute**: After `SetMuted(false)`, notifications resume
- **Pack resolution**: With pack loaded, sound resolves from pack files
- **Files override**: When `cfg.Files["done"]` is set and pack also has "done", uses cfg.Files path
- **No pack, no files**: No sound played, TTS still works if enabled
- **Random selection**: With 3 files for an event, multiple calls produce different files (statistical test or mock rand)
- **Volume passing**: Effective volume from config passed through to Player.Play()
- **Thread safety**: Concurrent `SetMuted()`/`Notify()` calls don't race (test with -race flag)

## Verification

_To be completed during implementation._

## Files Modified

_To be completed during implementation. Must include `docs/api-specs/audio/audio-api.md`._
