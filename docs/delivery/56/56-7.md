# 56-7 E2E CoS Test — Full Audio Enhancement Verification

[Back to task list](./tasks.md)

## Description

End-to-end integration tests verifying all 8 acceptance criteria for PBI-56. Tests cover the complete pipeline from config loading through pack resolution, volume calculation, random selection, mute toggle, CLI subcommands, and backwards compatibility. This is the final verification gate before the PBI can be marked Done.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 04:44:42 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 05:31:19 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 05:35:07 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 06:00:26 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

Verify all PBI-56 acceptance criteria:

1. **AC1 — Sound packs**: Directory-based packs in `~/.config/navi/soundpacks/<pack-name>/` with files named by event. Active pack selected via `pack:` in `sounds.yaml`
2. **AC2 — Multi-sound**: Multiple sounds per event via numeric suffix (e.g., `waiting-1.wav`, `waiting-2.wav`). Random selection on each trigger
3. **AC3 — Volume**: Global volume (0-100) and per-event multiplier configured in YAML, passed as CLI flags to system player
4. **AC4 — Mute toggle**: TUI keybind instantly silences/unmutes all audio with visual indicator
5. **AC5 — CLI commands**: `navi sound test <event>` plays configured sound; `navi sound list` shows available packs
6. **AC6 — Backwards compat**: Existing `files:` config works; `pack:` and `files:` coexist with `files:` overriding pack
7. **AC7 — Existing tests**: All PBI-42 audio tests continue to pass; new features have coverage
8. **AC8 — API spec**: Audio API spec updated with new config schema and public interfaces

## Implementation Plan

1. Create `internal/audio/enhanced_e2e_test.go` (or extend `audio_e2e_test.go`)
2. Test AC1: Create temp pack directory with event files, load config with `pack:`, verify resolution
3. Test AC2: Create pack with `waiting-1.wav`, `waiting-2.wav`, verify both files can be selected over multiple calls
4. Test AC3: Create config with `volume.global: 80` and `volume.events.done: 0.7`, verify effective volume = 56, verify volume args generated correctly per backend
5. Test AC4: Toggle mute, verify Notify produces no audio when muted, verify unmute restores
6. Test AC5: Test CLI command functions with temp pack dirs, verify output
7. Test AC6: Config with both `pack:` and `files:` override, verify files takes precedence for overridden event, pack used for others
8. Test AC7: Run full existing test suite, verify no regressions
9. Test AC8: Verify API spec file contains new types (VolumeConfig, PackInfo, SetMuted, etc.)

## Test Plan

### Objectives
Full end-to-end validation of PBI-56 acceptance criteria.

### Environment & Setup
- Temp directories for sound packs with dummy audio files
- Mock player/TTS backends (existing test patterns)
- Config files constructed in test

### Key Scenarios

| Scenario | Description | Expected Result |
|----------|-------------|-----------------|
| Full pipeline | Config with pack, volume, triggers → Notify | Correct file resolved, correct volume, sound played |
| Pack + files coexist | Pack has "done", files overrides "done" | files path used for "done", pack used for others |
| Multi-sound random | Pack has 3 "waiting" variants | Over 10 calls, more than 1 variant selected |
| Mute blocks all | Mute → Notify | No Play(), no Speak() calls |
| Volume calculation | global=60, event=0.5 | effective=30 passed to Play() |
| Zero volume | global=0 | Play() skipped entirely |
| Missing pack | Config references nonexistent pack | Graceful fallback, no crash |
| Backwards compat | Config with only files (no pack, no volume) | Identical behavior to PBI-42 |

### Success Criteria
- All tests pass with `go test -race`
- `go vet` clean
- No regressions in existing audio tests
- API spec contains all new public types and methods

## Verification

- `go build ./...` — clean
- `go vet ./...` — clean
- `go test ./internal/audio/ -race -count=1` — all 76 tests pass (10 new E2E + 66 existing)
- All 8 ACs covered: AC1-AC4, AC6-AC8 via direct E2E tests; AC5 via `internal/cli/sound_test.go` (6 tests)
- Additional scenarios: full pipeline, zero volume, missing pack graceful fallback
- AI review: pass (0 critical, 0 high, 1 medium, 6 low)
  - Medium: AC5 not in E2E file — mitigated by dedicated CLI tests in separate package
  - Low findings: cosmetic/style items, no functional impact

## Files Modified

- `internal/audio/enhanced_e2e_test.go` — new file: 10 E2E tests covering AC1-AC8 plus edge cases
