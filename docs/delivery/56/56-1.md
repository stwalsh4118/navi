# 56-1 Config Schema — Pack and Volume Fields

[Back to task list](./tasks.md)

## Description

Extend the audio `Config` struct with new fields to support sound packs and volume control. Add a `Pack` string field for the active sound pack name, and a `Volume` struct containing a `Global` integer (0-100) and an `Events` map for per-event volume multipliers (0.0-1.0). Update YAML parsing, `DefaultConfig()`, `LoadConfig()`, and `ValidateConfig()` to handle the new fields. This is the foundational schema change that all other PBI-56 tasks depend on.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 04:44:42 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 05:13:33 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 05:18:38 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 06:00:26 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Add `Pack string` field to `Config` with YAML tag `pack`
2. Add `VolumeConfig` struct with:
   - `Global int` (YAML `global`, default 100, range 0-100)
   - `Events map[string]float64` (YAML `events`, per-event multiplier 0.0-1.0)
3. Add `Volume VolumeConfig` field to `Config` with YAML tag `volume`
4. Update `DefaultConfig()` — `Pack` defaults to empty string (no pack), `Volume.Global` defaults to 100
5. Update `LoadConfig()` — parse new YAML fields via existing unmarshal flow
6. Update `ValidateConfig()` — warn if `Volume.Global` outside 0-100, warn if event multipliers outside 0.0-1.0
7. Add `EffectiveVolume(event string) int` method on `VolumeConfig` — returns `Global * multiplier` clamped to 0-100
8. Existing `Files` and `Triggers` fields remain unchanged; full backwards compatibility
9. Update audio API spec (`docs/api-specs/audio/audio-api.md`) with new types

## Implementation Plan

1. Define `VolumeConfig` struct in `config.go`
2. Add `Pack` and `Volume` fields to `Config` struct
3. Update `DefaultConfig()` with sensible defaults
4. Add validation logic in `ValidateConfig()` for range checking with warnings
5. Add `EffectiveVolume(event string) int` method
6. Update `normalizeConfig()` if needed (e.g., clamp out-of-range values)
7. Write unit tests for new config fields, parsing, validation, and volume calculation
8. Update `docs/api-specs/audio/audio-api.md`

## Test Plan

- **Config parsing**: YAML with `pack:` and `volume:` fields parses correctly into struct
- **Defaults**: Missing `pack` and `volume` fields default to empty/100 respectively
- **Validation**: Out-of-range `Global` (e.g., -10, 150) logs warning; out-of-range event multipliers (e.g., -0.5, 2.0) log warning
- **EffectiveVolume**: `Global=80, event multiplier=0.7` → returns 56; no event multiplier → returns 80; `Global=0` → returns 0
- **Backwards compatibility**: Config without new fields loads identically to current behavior

## Verification

- All 27 audio tests pass with `-race`
- `go build ./...` clean
- `go vet ./...` clean
- Backwards compatibility verified: configs without pack/volume fields load identically to PBI-42 behavior
- AI review: pass (0 critical, 0 high, 0 medium, 4 low — all deferred)

## Files Modified

- `internal/audio/config.go` — added VolumeConfig struct, Pack/Volume fields, EffectiveVolume method, validation, normalization
- `internal/audio/config_test.go` — added tests for pack/volume parsing, backwards compat, EffectiveVolume calculations
- `docs/api-specs/audio/audio-api.md` — added VolumeConfig and Pack to spec
