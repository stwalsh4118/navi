# 56-3 Volume Control — Per-Backend CLI Flags

[Back to task list](./tasks.md)

## Description

Extend `Player.Play()` to accept a volume level and translate it into backend-specific CLI flags. Each audio backend has a different volume flag format (paplay uses PulseAudio native range, afplay uses a float multiplier, mpv/ffplay use percentages). The player must map the 0-100 effective volume to the correct flag for the detected backend. `aplay` has no volume flag and volume is ignored for it.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 04:44:42 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 05:23:25 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 05:25:32 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-19 06:00:26 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Change `Player.Play(filePath string) error` signature to `Player.Play(filePath string, volume int) error`
2. Volume parameter range: 0-100 (0 = silent, 100 = full volume)
3. Backend-specific volume flag mapping:
   - `paplay`: `--volume=<0-65536>` (linear scale: volume * 655.36, rounded)
   - `afplay`: `-v <0.0-1.0>` (volume / 100.0)
   - `mpv`: `--volume=<0-100>` (direct passthrough)
   - `ffplay`: `-volume <0-100>` (direct passthrough)
   - `aplay`: no volume flag (volume parameter ignored)
4. Volume of 0 should skip playback entirely (optimization — no need to launch process)
5. Default volume (100) should produce no volume flag (backend default = full volume) for backwards compat
6. Update all existing callers of `Play()` to pass volume parameter
7. Update audio API spec

## Implementation Plan

1. Add `volumeArgs(backend string, volume int) []string` helper function in `player.go`
2. Update `Play()` signature and implementation to prepend/append volume args
3. Add volume=0 early return (skip playback)
4. Add volume=100 optimization (omit flag, use backend default)
5. Update `soundPlayer` interface in `notifier.go` to match new signature
6. Update all callers (Notifier, tests) to pass volume — use 100 as default where needed
7. Write unit tests for `volumeArgs()` across all backends
8. Update `docs/api-specs/audio/audio-api.md`

## Test Plan

- **volumeArgs mapping**: Test each backend with volume=50:
  - paplay → `["--volume=32768"]`
  - afplay → `["-v", "0.50"]`
  - mpv → `["--volume=50"]`
  - ffplay → `["-volume", "50"]`
  - aplay → `[]` (empty)
- **Volume 0**: `Play()` returns immediately without launching process
- **Volume 100**: No volume flag appended (backend default)
- **Boundary values**: volume=1, volume=99 produce correct scaled values
- **Interface compatibility**: Existing tests updated to pass volume=100 and continue passing

## Verification

- All audio tests pass with `-race` (38 tests)
- `go build ./...` and `go vet ./...` clean
- Volume args verified for all 5 backends
- AI review: pass — all requirements met, comprehensive test coverage

## Files Modified

- `internal/audio/player.go` — added volumeArgs(), updated Play() signature with volume param
- `internal/audio/notifier.go` — updated soundPlayer interface, Notify() passes EffectiveVolume
- `internal/audio/notifier_test.go` — updated mockPlayer for volume param
- `internal/audio/player_test.go` — updated callers, added 8 volume tests
- `docs/api-specs/audio/audio-api.md` — updated Play() signature and backend volume docs
