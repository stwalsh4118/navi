# [55-2] Immediate PM Refresh on View Entry

[Back to task list](./tasks.md)

## Description

Trigger an immediate PM engine run when the user opens the PM view by pressing `P`. Currently, PM data only refreshes on a 30-second tick (`pmPollInterval`). This means opening PM view can show stale data for up to 30 seconds. This task ensures the PM pipeline runs immediately upon view entry so the user sees current data as quickly as possible.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 08:00:46 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 08:03:58 | Status Change | Proposed | Agreed | User requested implementation of PBI-55 | User |
| 2026-02-18 08:09:49 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 08:13:31 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 08:33:37 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. When PM view is opened (not closed), trigger an immediate `pmRunCmd` if a PM engine exists.
2. Set `pmRunInFlight = true` so the loading indicator (55-1) shows immediately.
3. Guard against double-execution: if `pmRunInFlight` is already true, skip the trigger.
4. Preserve the existing 30-second tick â€” this adds an immediate trigger, it does not replace periodic polling.
5. PM correctness and snapshot/event output must remain unchanged.

## Implementation Plan

1. The `P` key handler in `model.go` currently calls `m.togglePMView()` and returns `(m, nil)`.
2. Change `togglePMView()` to return a `tea.Cmd` (or return a cmd from the key handler after toggling).
3. When toggling **on** (not off) and `m.pmEngine != nil` and `!m.pmRunInFlight`:
   - Set `m.pmRunInFlight = true`
   - Return `pmRunCmd(m.pmEngine, m.sessions, m.pmTaskResults)` as the command.
4. When toggling off, return `nil` as before.

## Test Plan

- Unit test: pressing `P` to open PM view returns a non-nil command when pmEngine exists and pmRunInFlight is false.
- Unit test: pressing `P` to open PM view returns nil command when pmRunInFlight is already true.
- Unit test: pressing `P` to close PM view returns nil command.
- Unit test: `pmRunInFlight` is set to true after opening PM view.

## Verification

- Updated PM toggle flow so opening PM view via `P` returns an immediate `pmRunCmd` when `pmEngine` exists and no PM run is already in flight.
- `togglePMView()` now returns a `tea.Cmd`; it sets `pmRunInFlight = true` before dispatching the PM run and returns `nil` when closing or when a run is already in flight.
- Main key handler now propagates the returned command (`case "P"` in `Update`).
- Added PM tests for: immediate run on open, skip when already in-flight, and nil command on close.
- Executed: `go test ./internal/tui -run TestPM` (pass).
- Internal AI review gate verdict: pass for task 55-2 scope.

## Files Modified

- `internal/tui/model.go`
- `internal/tui/pmview.go`
- `internal/tui/pmview_test.go`
- `docs/delivery/55/tasks.md`
- `docs/delivery/55/55-2.md`
