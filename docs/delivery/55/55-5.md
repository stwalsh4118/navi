# [55-5] E2E CoS Test

[Back to task list](./tasks.md)

## Description

Verify all PBI-55 acceptance criteria through automated tests. This is the final task that confirms the integrated behavior of PM loading indicators, immediate refresh on view entry, manual refresh, and concurrent provider execution.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 08:00:46 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

Verify each acceptance criterion from the PBI:

1. **AC1**: Opening PM view triggers an immediate PM refresh without waiting for the periodic PM tick.
2. **AC2**: PM view displays a visible loading indicator while PM refresh is in flight.
3. **AC3**: Manual refresh interaction in PM context is explicit and consistent with user expectations.
4. **AC4**: Provider refresh path is optimized so multi-project refresh latency is reduced compared with sequential execution.
5. **AC5**: Existing PM project snapshot correctness and current-PBI resolution behavior remain unchanged.
6. **AC6**: Automated tests cover PM loading-state visibility and refresh behavior regressions.

## Implementation Plan

1. Create a test file `internal/tui/pm_refresh_test.go` (or extend existing PM test files).
2. Write integration-style tests that exercise the full PM refresh flow:
   - Toggle PM view on → verify immediate command dispatched and `pmRunInFlight` set.
   - Render PM view with `pmRunInFlight = true` → verify loading indicator visible.
   - Receive `pmOutputMsg` → verify loading indicator disappears, data updated.
   - Press `r` in PM view → verify cache invalidation and refresh triggered.
   - Verify `pmOutput` snapshots are correct after refresh cycle.
3. Write a concurrent provider test that measures wall-clock time with multiple synthetic providers to confirm concurrency improvement over sequential.
4. Run full test suite with `-race` to verify no data races.
5. Run `go vet` to verify no static analysis issues.

## Test Plan

### Objectives
Validate the complete PBI-55 feature set end-to-end.

### Test Scope
- PM view toggle with immediate refresh (AC1)
- Loading indicator rendering (AC2)
- Manual refresh key behavior (AC3)
- Concurrent provider timing (AC4)
- Snapshot correctness regression (AC5)
- Test coverage existence (AC6)

### Environment & Setup
- Use `newNavTestModel()` helper for TUI model tests.
- Use mock providers (sleep-based) for concurrency timing tests.

### Key Scenarios
1. Open PM view → immediate refresh fires, loading indicator shown.
2. PM output arrives → loading clears, data renders correctly.
3. Press `r` in PM view → cache invalidated, refresh fires.
4. Multiple projects with slow providers → concurrent execution completes faster than sequential.
5. Existing PM snapshot tests continue to pass (no regression).

### Success Criteria
- All new tests pass.
- All existing tests pass (`go test ./... -race`).
- `go vet ./...` clean.
- No data races.

## Verification

_To be filled during implementation._

## Files Modified

_To be filled during implementation._
