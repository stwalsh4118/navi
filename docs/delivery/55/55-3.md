# [55-3] Manual PM Refresh Key

[Back to task list](./tasks.md)

## Description

Add an `r` key handler in the PM view so users can manually trigger a PM refresh. This mirrors the existing `r` key in the task panel (which invalidates the task cache and re-executes providers). In PM context, pressing `r` should invalidate the task cache for all projects, trigger a task refresh, and then run the PM engine to capture fresh snapshots.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 08:00:46 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 08:03:58 | Status Change | Proposed | Agreed | User requested implementation of PBI-55 | User |
| 2026-02-18 08:13:53 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 08:17:00 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 08:33:37 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. In PM view, pressing `r` triggers a manual PM refresh.
2. The refresh must invalidate the task result cache (`InvalidateAll`) so providers re-execute.
3. Set `pmRunInFlight = true` and dispatch a task refresh followed by PM run.
4. Guard against double-refresh: if `pmRunInFlight` is already true, ignore the key press.
5. The refresh behavior must be consistent with user expectations — explicit action, explicit feedback.

## Implementation Plan

1. In `updatePMView()` in `pmview.go`, add a `case "r":` handler at the top level (not zone-specific).
2. Guard: if `m.pmRunInFlight`, return `(m, nil)`.
3. Set `m.pmRunInFlight = true`.
4. Invalidate all cache entries: `m.taskCache.InvalidateAll()`.
5. Return a `tea.Batch` of:
   - `taskRefreshCmd(m.taskProjectConfigs, m.taskCache, m.taskGlobalConfig, task.DefaultProviderTimeout)` — re-execute providers.
   - `pmRunCmd(m.pmEngine, m.sessions, m.pmTaskResults)` — run PM engine.
6. Note: The PM run dispatched here will use the *current* task results; when `tasksMsg` arrives with fresh data, the next periodic PM tick will pick it up. Alternatively, consider chaining: refresh tasks first, then PM run after. The simplest approach is to batch both and accept that the PM run uses slightly stale task data, followed by fresh data on the next cycle.

## Test Plan

- Unit test: pressing `r` in PM view sets `pmRunInFlight` and returns a command.
- Unit test: pressing `r` when `pmRunInFlight` is true returns nil command.
- Unit test: pressing `r` invalidates the task cache.

## Verification

- Added top-level `r` handling in `updatePMView()` so manual refresh works regardless of PM zone focus.
- Implemented guards to ignore `r` when `pmRunInFlight` is already true or when PM engine is unavailable.
- On valid refresh, task cache is invalidated via `InvalidateAll()`, `pmRunInFlight` is set true, and task refresh + PM run commands are dispatched in a `tea.Batch`.
- Added PM refresh key tests for success path, in-flight guard, full cache invalidation semantics, and nil-engine guard.
- Executed: `go test ./internal/tui -run 'TestPMViewManualRefreshKey|TestPMViewImmediateRefreshOnOpen|TestPMBriefingLoadingIndicator'` (pass).
- Internal AI review gate verdict: pass.

## Files Modified

- `internal/tui/pmview.go`
- `internal/tui/pmview_test.go`
- `docs/delivery/55/tasks.md`
- `docs/delivery/55/55-3.md`
