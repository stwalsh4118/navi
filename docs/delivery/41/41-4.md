# 41-4 E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification that all PBI 41 acceptance criteria are met. Run the full test suite, verify agent indicator rendering, status aggregation, and detail area display work correctly together.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 07:44:29 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-16 08:00:08 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-16 08:03:48 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-16 08:11:16 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. All 7 PBI 41 acceptance criteria verified
2. Full test suite passes (`go test -race ./...`)
3. `go vet ./...` clean
4. Integration scenarios covering multi-agent and single-agent sessions

## Implementation Plan

1. Run `go test -race ./...` and verify all tests pass
2. Run `go vet ./...` and verify clean output
3. Review test coverage for each acceptance criterion:
   - AC1: Sessions with OpenCode entry show `[OC ●/○]` indicator — covered by 41-2 tests
   - AC2: Sessions with no agents entries show no indicators — covered by 41-2 tests
   - AC3: Detail area shows per-agent status — covered by 41-3 tests
   - AC4: Sorting accounts for agent statuses — covered by 41-1 tests
   - AC5: Consistent styling — visual review of test output
   - AC6: All existing tests pass — `go test -race ./...`
   - AC7: New tests cover indicator rendering and aggregation — test count verification
4. Add any missing integration test scenarios discovered during review
5. Document results in Verification section

## Test Plan

### Objectives
Verify PBI 41 acceptance criteria are fully satisfied end-to-end.

### Key Scenarios
1. **Multi-agent session rendering**: Session with CC working + OC idle → row shows `[OC ○]`, detail shows both agents
2. **Single-agent session (no agents map)**: Row renders identically to pre-PBI-41 behavior
3. **Permission priority sorting**: Session with OC permission sorts above session with all agents idle
4. **Mixed team + agents**: Session with Team (PBI-33) and Agents (PBI-40) renders both badge and indicators
5. **Empty agents map**: `Agents: map[string]ExternalAgent{}` treated same as nil — no indicators

### Success Criteria
- All tests pass with `-race` flag
- `go vet` clean
- Each acceptance criterion has at least one test covering it

## Verification

- `go test -race ./...` (pass)
- `go vet ./...` (clean)
- Internal AI review subagent verdict: `pass`
- Acceptance criteria coverage:
  - AC1 (`[OC ●/○]` indicator for OpenCode agents): covered by `TestRenderAgentIndicators` and `TestRenderSessionWithExternalAgents` in `internal/tui/view_test.go`
  - AC2 (no indicator when agents empty/nil): covered by `TestRenderAgentIndicators` nil/empty cases and session integration tests
  - AC3 (detail area per-agent status): covered by `TestRenderAgentDetail` and `TestRenderSessionIncludesAgentDetailSection`
  - AC4 (sorting accounts for agent statuses): covered by `TestSortSessionsWithExternalAgentPriority`, including done session with external working
  - AC5 (consistent styling): implemented with existing TUI styles and status icon/color conventions; validated through rendering tests
  - AC6 (existing tests pass): satisfied by full `go test -race ./...`
  - AC7 (new tests for indicators + aggregation logic): satisfied by new session/tui tests added in tasks 41-1 through 41-3

## Files Modified

- `internal/session/session.go` — added active external-agent sorting behavior so sessions with external working/waiting/permission are not treated as fully done
- `internal/session/session_test.go` — added coverage for external working behavior and done-vs-active sorting
- `docs/api-specs/session/session-api.md` — documented `HasPriorityExternalAgent` and updated sorting behavior notes
