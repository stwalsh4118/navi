# 41-1 External Agent Status Aggregation

[Back to task list](./tasks.md)

## Description

Extend the session sorting and priority logic in `internal/session/session.go` to account for external agents in the `Agents` map. Currently, `HasPriorityTeammate()` only checks the `Team.Agents` slice (PBI-33 agent teams). PBI-41 needs equivalent logic for the `Agents map[string]ExternalAgent` field added by PBI-40.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 07:44:29 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-16 07:51:38 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-16 07:53:22 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-16 08:11:16 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Add `HasPriorityExternalAgent(s Info) bool` that returns true if any entry in `s.Agents` has `StatusWaiting` or `StatusPermission`
2. Update `SortSessions()` to include `HasPriorityExternalAgent()` in the priority check alongside `HasPriorityTeammate()`
3. A session with any external agent in `working` or `permission` status should not sort as fully "done"
4. Empty or nil `Agents` map must not affect existing sorting behavior
5. All existing tests must continue to pass

## Implementation Plan

1. Add `HasPriorityExternalAgent(s Info) bool` in `internal/session/session.go`
   - Iterate over `s.Agents` map
   - Return true if any entry has `StatusWaiting` or `StatusPermission`
   - Return false if map is nil or empty
2. Update `SortSessions()` priority check (lines ~88-99) to include `HasPriorityExternalAgent()`
   - Change: `iPriority := ... || HasPriorityTeammate(sessions[i]) || HasPriorityExternalAgent(sessions[i])`
3. Add unit tests in `internal/session/session_test.go`

## Test Plan

- **HasPriorityExternalAgent**: nil map → false; empty map → false; agent with `idle` → false; agent with `permission` → true; agent with `waiting` → true; multiple agents mixed statuses → true if any priority
- **SortSessions**: sessions with external agent `permission` sort before sessions with `idle`; sessions with no agents map unchanged from current behavior; combined Team + Agents priority scenarios

## Verification

- `go test ./...` (pass)
- Internal AI review subagent verdict: `pass` (no findings)
- Completion review rerun verdict: `pass` after tiered sorting update

## Files Modified

- `internal/session/session.go` — added `HasPriorityExternalAgent`; implemented tiered sorting so priority states remain first while external working is treated as active
- `internal/session/session_test.go` — added tests for external-agent priority helper, active external working behavior, and waiting-vs-working tier ordering
