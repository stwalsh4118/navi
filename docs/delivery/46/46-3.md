# [46-3] Snapshot Diffing and Event Generation

[Back to task list](./tasks.md)

## Description

Implement snapshot comparison logic that detects changes between consecutive snapshots and generates typed events. Each event type corresponds to a specific project state change (task completion, new commit, status transition, etc.).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 14:24:46 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-17 07:29:16 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-17 07:30:21 | Status Change | InProgress | Review | Implementation complete, internal checks passed | AI_Agent |
| 2026-02-17 09:44:23 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Create `internal/pm/diff.go`.
2. Implement `DiffSnapshots(old, new ProjectSnapshot) []Event` — compares two snapshots for the same project and returns generated events.
3. Detect and emit the following event types:
   - **`commit`**: HEAD SHA changed. Run `git log --oneline <oldSHA>..<newSHA>` to get commit summaries. Emit one event with commit list in payload.
   - **`task_completed`**: `TaskCounts.Done` increased. Payload includes old and new done count.
   - **`task_started`**: `TaskCounts.InProgress` increased. Payload includes old and new in-progress count.
   - **`session_status_change`**: Composite session status changed. Payload includes old and new status.
   - **`pbi_completed`**: PBI ID is the same but all tasks done (done == total, total > 0, and old done < old total). Payload includes PBI ID and title.
   - **`branch_created`**: Branch name changed (and old branch was non-empty). Payload includes old and new branch.
   - **`pr_created`**: Old snapshot had no PR number, new snapshot has one. Payload includes PR number.
4. Each event includes: type, timestamp (time.Now()), project name, project directory, payload.
5. `git log --oneline <old>..<new>` must only execute when HEAD SHA actually changes (acceptance criteria #7).
6. Handle first snapshot (no old snapshot): no events emitted.

## Implementation Plan

1. Create `internal/pm/diff.go` with `DiffSnapshots` function.
2. Add `GetCommitsBetween(dir, oldSHA, newSHA string) []string` helper that runs `git log --oneline <old>..<new>`.
3. Compare each field pair; emit events only for actual changes.
4. Return all events for a single diff cycle as a slice.

## Test Plan

### Objectives
Verify correct event generation for each detectable change type.

### Key Scenarios
1. **No changes**: Same snapshot → empty event list.
2. **HEAD SHA change**: Different SHAs → commit event with payload.
3. **Task completion**: Done count increased → task_completed event.
4. **Task started**: InProgress count increased → task_started event.
5. **Status change**: Different composite status → session_status_change event.
6. **PBI completed**: Done == Total (was not before) → pbi_completed event.
7. **Branch change**: Different branch name → branch_created event.
8. **PR created**: PR number goes from 0 to non-zero → pr_created event.
9. **Multiple changes**: Several fields changed → multiple events emitted.
10. **First snapshot (nil old)**: No events generated.

### Mocking Strategy
- Mock `GetCommitsBetween` to avoid real git commands in unit tests.
- Construct `ProjectSnapshot` structs with known field values for comparison.

## Verification

- `go test ./internal/pm -run 'TestDiffSnapshots'` passes.
- Diff logic verified for all required event types and efficient commit-log lookup behavior.

## Files Modified

- `internal/pm/diff.go` (new)
- `internal/pm/diff_test.go` (new)
