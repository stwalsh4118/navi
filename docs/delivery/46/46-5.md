# [46-5] PM Engine and TUI Integration

[Back to task list](./tasks.md)

## Description

Build the PM engine orchestrator that ties together project discovery, snapshot capture, diffing, and event emission into a single pipeline. Integrate the engine into the TUI's existing polling cycle so it runs periodically without adding perceptible latency.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 14:24:46 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-17 07:31:20 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-17 08:35:35 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-17 09:44:23 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Create `internal/pm/engine.go`.
2. Implement `Engine` struct with:
   - `prevSnapshots map[string]ProjectSnapshot` — cached previous snapshots keyed by project directory.
   - `Run(sessions []session.Info, taskResults map[string]*task.ProviderResult) (*PMOutput, error)` — main pipeline method.
3. `Engine.Run` pipeline:
   a. Discover projects from sessions (group by CWD).
   b. For each project: capture snapshot (using task results if available for that directory).
   c. Diff new snapshot against cached previous snapshot.
   d. Collect all events across all projects.
   e. Append events to JSONL log.
   f. Update snapshot cache with new snapshots.
   g. Return `PMOutput` with all current snapshots and new events.
4. Implement `NewEngine() *Engine` constructor.
5. TUI integration:
   a. Add `pmEngine *pm.Engine` field to TUI `Model`.
   b. Add `pmTickCmd()` tea.Cmd that fires every 30 seconds.
   c. Add `pmTickMsg` message type.
   d. On `pmTickMsg`: run `pmEngine.Run()` asynchronously via a tea.Cmd.
   e. Add `pmOutputMsg` to deliver results back to the model.
   f. Store latest `PMOutput` on the model for consumption by future PBI-47 (TUI view).
6. The PM pipeline must run asynchronously (in a tea.Cmd goroutine) to avoid blocking the TUI.
7. Must not add perceptible latency to the TUI's existing cycles.

## Implementation Plan

1. Create `internal/pm/engine.go` with `Engine` struct and `Run` method.
2. `Run` calls `DiscoverProjects` → `CaptureSnapshot` per project → `DiffSnapshots` per project → `AppendEvents`.
3. Pass existing TUI session list and task results to `Run` — no additional polling needed.
4. In `internal/tui/model.go`: add `pmEngine` field, initialize in constructor.
5. In `internal/tui/sessions.go` (or new `pm.go` TUI file): add tick command, message types, and Update handler.
6. Start `pmTickCmd` alongside existing tick commands in the TUI's `Init()`.
7. Handle `pmTickMsg` by launching async `pmRunCmd` that calls `engine.Run()`.
8. Handle `pmOutputMsg` by storing the output on the model.

## Test Plan

### Objectives
Verify the engine pipeline produces correct snapshots and events, and that TUI integration wires up correctly.

### Key Scenarios
1. **First run**: No previous snapshots → snapshots captured, no events emitted.
2. **Subsequent run with changes**: HEAD SHA changed → commit events generated and logged.
3. **Multiple projects**: Three sessions across two projects → two snapshots, events per project.
4. **No sessions**: Empty session list → empty output, no errors.
5. **Engine state persistence**: Previous snapshots cached correctly between runs.
6. **Event log written**: After run, events.jsonl contains appended events.

### Environment & Setup
- Use temp directories for event log path.
- Provide mock session lists and task results.

### Mocking Strategy
- Mock git operations to avoid real git commands.
- Use test session.Info structs with known CWDs.

## Verification

- `go test ./internal/pm ./internal/tui ./test/integration/pm` passes.
- `go test -race ./internal/pm ./internal/tui` passes.
- Internal AI review subagent verdict: **pass** (one low-severity non-blocking note on idle prune I/O).

## Files Modified

- `internal/pm/engine.go` (new)
- `internal/pm/engine_test.go` (new)
- `internal/tui/model.go` (modified — add pmEngine field)
- `internal/tui/tasks.go` (modified — retain provider results for PM engine)
- `internal/tui/pm.go` (new — PM tick and async run command)
