# [46-4] JSONL Event Log and Pruning

[Back to task list](./tasks.md)

## Description

Implement the event persistence layer: append events to a rolling JSONL log file at `~/.config/navi/pm/events.jsonl`, read events back, and prune entries older than 24 hours on each write cycle.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 14:24:46 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Create `internal/pm/eventlog.go`.
2. Implement `AppendEvents(events []Event) error`:
   - Ensure `~/.config/navi/pm/` directory exists (create with `os.MkdirAll`).
   - Open `events.jsonl` in append mode.
   - Marshal each event as a single JSON line and write with newline separator.
3. Implement `ReadEvents() ([]Event, error)`:
   - Read `events.jsonl` line by line.
   - Unmarshal each line to `Event`. Skip malformed lines.
   - Return all valid events.
4. Implement `PruneEvents() error`:
   - Read all events, filter to those within 24 hours of now.
   - Rewrite the file with only the retained events.
   - Run on each `AppendEvents` call (prune then append).
5. Use `pathutil.ExpandPath` to resolve `~/.config/navi/pm/events.jsonl`.
6. Handle missing file gracefully (return empty slice, not error).

## Implementation Plan

1. Create `internal/pm/eventlog.go`.
2. Define `const EventLogPath = "~/.config/navi/pm/events.jsonl"`.
3. Implement `resolveEventLogPath() string` using `pathutil.ExpandPath`.
4. `AppendEvents`: call `PruneEvents` first, then open file in append mode and write new events.
5. `ReadEvents`: use `bufio.Scanner` for line-by-line reading.
6. `PruneEvents`: read all, filter by `time.Now().Add(-24 * time.Hour)`, rewrite atomically (write to temp file, rename).

## Test Plan

### Key Scenarios
1. **Append to new file**: No existing file â†’ creates directory and file, writes events.
2. **Append to existing file**: Existing events preserved, new events appended.
3. **Read events**: Written events can be read back with correct types and payloads.
4. **Malformed line**: Invalid JSON line skipped, other events returned.
5. **Pruning**: Events older than 24h removed; recent events retained.
6. **Empty file**: Returns empty slice, no error.
7. **Missing file**: Returns empty slice, no error.

### Mocking Strategy
- Use `os.MkdirTemp` for isolated test directories.
- Override the event log path via a parameter or test helper.

## Verification

_To be completed during implementation._

## Files Modified

- `internal/pm/eventlog.go` (new)
- `test/unit/pm/eventlog_test.go` (new)
