# [46-6] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification of all PBI-46 acceptance criteria. Tests the full PM pipeline from project discovery through event emission and log persistence.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 14:24:46 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

Verify all 7 acceptance criteria:

1. **AC1 — Project Discovery**: Projects are automatically discovered from active session CWDs with deduplication when multiple sessions share the same project root.
2. **AC2 — Snapshot Content**: Snapshots capture HEAD SHA, branch name, commits ahead, dirty state, current PBI (ID + title + task counts), session status, last activity time.
3. **AC3 — Event Generation**: Snapshot diffing detects and emits typed events: `task_completed`, `task_started`, `commit`, `session_status_change`, `pbi_completed`, `branch_created`, `pr_created`.
4. **AC4 — Event Persistence**: Events appended to `~/.config/navi/pm/events.jsonl` with timestamps and project names.
5. **AC5 — Event Pruning**: Events older than 24 hours are pruned on each write cycle.
6. **AC6 — Performance**: The engine runs on the existing polling cycle without adding perceptible latency.
7. **AC7 — Efficient Git**: HEAD SHA uses `git rev-parse HEAD`; `git log --oneline <old>..<new>` only runs when SHA changes.

## Implementation Plan

1. Create `test/integration/pm/` directory for integration tests.
2. Write integration tests using real git repositories (created in temp dirs with `git init`).
3. Simulate multi-session scenarios with shared CWDs.
4. Run full engine pipeline across multiple cycles and verify events.
5. Performance: benchmark the pipeline and assert < 100ms per cycle.

## Test Plan

### Objectives
Full end-to-end verification of the PM engine pipeline.

### Test Scope
Integration tests that exercise the full pipeline with real git repos.

### Environment & Setup
- Create temp directories with `git init` for real git operations.
- Create mock session status files to simulate active sessions.
- Create mock task provider results.
- Use temp directory for event log output.

### Key Scenarios

**Scenario 1 — Project Discovery and Deduplication (AC1)**
- Create 3 session.Info entries: 2 with same CWD, 1 with different CWD.
- Run discovery → verify 2 projects, one with session count 2.

**Scenario 2 — Snapshot Content (AC2)**
- Create a git repo with commits, a branch ahead of remote, and dirty files.
- Provide a task result with known statuses.
- Capture snapshot → verify all fields populated correctly.

**Scenario 3 — Event Generation (AC3)**
- Run engine twice: first time with initial state, second time with changes (new commit, task completed, status change).
- Verify each expected event type is emitted with correct payload.

**Scenario 4 — Event Persistence (AC4)**
- After engine run with events, read events.jsonl.
- Verify events have timestamps, project names, and correct types.

**Scenario 5 — Event Pruning (AC5)**
- Pre-populate events.jsonl with events timestamped 25 hours ago.
- Run engine → verify old events are pruned, new events retained.

**Scenario 6 — Performance (AC6)**
- Benchmark single engine run with 5 projects.
- Assert total duration < 100ms (excluding actual git commands, which are mocked).

**Scenario 7 — Efficient Git (AC7)**
- Run engine twice with same HEAD SHA → verify `git log` is NOT called.
- Run engine twice with different HEAD SHA → verify `git log` IS called.

### Success Criteria
- All 7 acceptance criteria verified with passing tests.
- `go test -race ./test/integration/pm/...` passes cleanly.
- `go vet ./internal/pm/...` reports no issues.

## Verification

_To be completed during implementation._

## Files Modified

- `test/integration/pm/engine_test.go` (new)
