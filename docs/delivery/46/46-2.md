# [46-2] Project Discovery and Snapshot Capture

[Back to task list](./tasks.md)

## Description

Implement project discovery from active session working directories and snapshot capture. Sessions sharing the same expanded CWD are grouped into a single project. Each project's snapshot captures git state, task counts, session status, and activity metadata.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-16 14:24:46 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-17 07:28:01 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-17 07:29:16 | Status Change | InProgress | Review | Implementation complete, internal checks passed | AI_Agent |
| 2026-02-17 09:44:23 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Create `internal/pm/snapshot.go`.
2. Implement `DiscoverProjects(sessions []session.Info) map[string][]session.Info` — groups sessions by expanded CWD, using `pathutil.ExpandPath()` for deduplication.
3. Implement `CaptureSnapshot(projectDir string, sessions []session.Info, taskResult *task.ProviderResult) ProjectSnapshot`:
   - Project name = `filepath.Base(projectDir)`.
   - Git state: reuse `git.GetInfo(projectDir)` for HEAD SHA, branch, ahead count, dirty state. Extract HEAD SHA via the existing `LastCommit` field (short hash) or add a direct `git rev-parse HEAD` call for full SHA.
   - Task counts: parse `taskResult` to count total, done, in-progress tasks using `NormalizeStatus`.
   - Session status: compute highest-priority status across all grouped sessions using `session.CompositeStatus`.
   - Last activity: max `Timestamp` across grouped sessions.
   - Session count: `len(sessions)`.
4. HEAD SHA must use `git rev-parse HEAD` for full SHA (acceptance criteria #7). If `git.GetInfo` only provides short hash, add a helper to get the full SHA.
5. Handle edge cases: sessions with empty CWD, non-existent directories, git failures (return partial snapshot with zero values).

## Implementation Plan

1. Create `internal/pm/snapshot.go` with `DiscoverProjects` and `CaptureSnapshot` functions.
2. Add `GetHeadSHA(dir string) string` helper that runs `git rev-parse HEAD` for full SHA.
3. Task count aggregation: iterate `taskResult.AllTasks()`, count by normalized status.
4. Session status aggregation: iterate sessions, call `session.CompositeStatus`, keep highest-priority.
5. Follow existing patterns from `internal/git/` for command execution (exec.Command with dir).

## Test Plan

### Objectives
Verify project discovery deduplication and snapshot field population.

### Key Scenarios
1. **Multiple sessions same CWD**: Two sessions with same expanded CWD → one project with session count 2.
2. **Different CWDs**: Three sessions with two unique CWDs → two projects.
3. **Path expansion**: Session CWD with `~/` prefix → correctly expanded and deduplicated.
4. **Empty CWD**: Sessions with empty CWD are excluded from discovery.
5. **Snapshot fields**: Verify all fields populated from git info, task result, and session data.
6. **Git failure**: Non-existent directory → partial snapshot with empty git fields.

### Mocking Strategy
- Mock `git.GetInfo` via interface or test helper to avoid real git commands in unit tests.
- Provide test `session.Info` structs with known CWD values.
- Provide test `task.ProviderResult` with known task statuses.

## Verification

- `go test ./internal/pm -run 'TestDiscoverProjects|TestCaptureSnapshot'` passes.
- Snapshot and discovery behavior verified for grouped CWDs, path expansion, and git-failure partial snapshots.

## Files Modified

- `internal/pm/snapshot.go` (new)
- `internal/pm/snapshot_test.go` (new)
