# [57-3] Resource Polling Integration in TUI

[Back to task list](./tasks.md)

## Description

Add a 30-second independent resource polling tick to the TUI that calls the `/proc` tree walker from task 57-2 for each local session, then merges the resulting `ResourceMetrics` onto the session data. Follows the existing pattern used by git polling (5s) and PM polling (5m).

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:35:20 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 08:49:26 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 08:53:12 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-20 05:48:29 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Define `resourcePollInterval = 30 * time.Second` constant in `internal/tui/sessions.go`
2. Define `resourceTickMsg` message type
3. Define `resourcePollMsg` message type carrying a map of session name → RSS bytes
4. Implement `resourceTickCmd()` that returns a 30s tick (same pattern as `gitTickCmd`)
5. Implement a poll function that iterates local sessions, calls `resource.SessionRSS()` for each, and returns a `resourcePollMsg`
6. Handle `resourceTickMsg` in `Update()` — trigger the resource poll and reschedule the tick
7. Handle `resourcePollMsg` in `Update()` — merge RSS data onto `m.sessions` by matching session name
8. Start the resource tick on app init (alongside the main tick and git tick)
9. Only poll local sessions (skip sessions where `Remote != ""`)

## Implementation Plan

**File**: `internal/tui/sessions.go`

1. Add constants and message types:
   ```go
   const resourcePollInterval = 30 * time.Second
   type resourceTickMsg time.Time
   type resourcePollMsg map[string]int64 // session name → RSS bytes
   ```

2. Add `resourceTickCmd()`:
   ```go
   func resourceTickCmd() tea.Cmd {
       return tea.Tick(resourcePollInterval, func(t time.Time) tea.Msg {
           return resourceTickMsg(t)
       })
   }
   ```

3. Add `pollResourceMetrics(sessions []session.Info) tea.Msg`:
   - Filter to local sessions only (`s.Remote == ""`)
   - Call `resource.SessionRSS(s.TmuxSession)` for each
   - Return `resourcePollMsg` map

**File**: `internal/tui/model.go`

4. Handle `resourceTickMsg` in `Update()`:
   - Copy current sessions list for the poll function
   - Return `tea.Batch(pollResourceCmd, resourceTickCmd())`

5. Handle `resourcePollMsg` in `Update()`:
   - For each session in `m.sessions`, if the map contains its name:
     - Initialize `Metrics` if nil
     - Set `Metrics.Resource = &metrics.ResourceMetrics{RSSBytes: value}`

6. Start `resourceTickCmd()` in `Init()` or the initial tick batch

## Test Plan

- **Unit tests**: Test `pollResourceMetrics` with mock session data (empty sessions, remote-only sessions, mixed local/remote)
- **Integration**: Verify resource tick fires and updates session data by running the TUI briefly and checking that local sessions get non-zero RSS values
- **Compilation**: `go build ./...` and `go vet ./...` pass

## Verification

- [ ] Resource poll runs every 30 seconds independently of main 500ms poll
- [ ] Only local sessions are polled (remote sessions skipped)
- [ ] RSS values are correctly merged onto session `Metrics.Resource`
- [ ] Resource tick starts on app init
- [ ] No crashes when sessions list is empty or changes between polls
- [ ] `go test -race ./...` passes

## Files Modified

- `internal/tui/sessions.go` — resource tick/poll types and functions
- `internal/tui/model.go` — Update() handlers for resource messages, Init() tick start
