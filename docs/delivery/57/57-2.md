# [57-2] /proc Process Tree RSS Calculator

[Back to task list](./tasks.md)

## Description

Create a new `internal/resource` package that calculates total RSS memory for a tmux session by walking the Linux `/proc` filesystem. Given a tmux session name, retrieve pane PIDs via `tmux list-panes`, recursively discover all descendant processes via `/proc/<pid>/children`, and sum RSS from `/proc/<pid>/statm` for the full process tree.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 08:35:20 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-19 08:46:25 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-19 08:49:14 | Status Change | InProgress | Review | Implementation complete, internal AI review passed (fixed -s flag) | AI_Agent |
| 2026-02-20 05:48:29 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Create `internal/resource/resource.go` with a `SessionRSS(sessionName string) int64` function
2. Get root pane PIDs using `tmux list-panes -s -t <session> -F '#{pane_pid}'`
3. For each pane PID, recursively walk `/proc/<pid>/task/<tid>/children` to build the full descendant tree
4. Read RSS from `/proc/<pid>/statm` (second field = RSS in pages) for each PID in the tree
5. Multiply RSS pages by system page size (`os.Getpagesize()`) to get bytes
6. Return total RSS bytes for the entire session's process tree
7. Gracefully handle vanished PIDs (ENOENT) — processes may exit between discovery and read
8. Return 0 if session has no panes or all PIDs are gone

## Implementation Plan

**File**: `internal/resource/resource.go`

1. `SessionRSS(sessionName string) int64` — top-level function:
   - Run `tmux list-panes -t <session> -F '#{pane_pid}'` to get root PIDs
   - For each root PID, call `processTreeRSS()` and accumulate
   - Return total bytes

2. `processTreeRSS(pid int) int64` — recursive tree walker:
   - Read `/proc/<pid>/statm`, parse second field (RSS pages)
   - Convert pages to bytes via `os.Getpagesize()`
   - Read `/proc/<pid>/task/<tid>/children` for all threads to find child PIDs
   - Recurse into each child PID
   - Return sum of this PID's RSS + all descendants' RSS

3. `readRSSBytes(pid int) int64` — reads a single PID's RSS:
   - Open `/proc/<pid>/statm`
   - Parse second space-delimited field
   - Return pages × page size
   - Return 0 on any error (process vanished)

4. `getChildPIDs(pid int) []int` — reads children for all threads:
   - Glob `/proc/<pid>/task/*/children`
   - Parse space-separated PIDs from each file
   - Return deduplicated list
   - Return empty slice on any error

**File**: `internal/resource/resource_test.go`

5. Unit tests:
   - Test `readRSSBytes` with the test process's own PID (known to exist)
   - Test `getChildPIDs` with PID 1 (init, known to have children)
   - Test `readRSSBytes` with a nonexistent PID (returns 0)
   - Test `processTreeRSS` with current process PID (returns > 0)

## Test Plan

- **Unit tests**: Verify /proc reading functions work against real /proc entries (current process PID, PID 1)
- **Edge cases**: Nonexistent PIDs return 0 without error; empty session returns 0
- **Compilation**: `go build ./...` and `go vet ./...` pass

## Verification

- [ ] `SessionRSS()` returns correct RSS for a real tmux session
- [ ] Process tree is fully walked (parent + all descendants)
- [ ] RSS is read from `/proc/<pid>/statm` and converted to bytes
- [ ] Vanished PIDs handled gracefully (no panics, returns 0)
- [ ] No subprocess spawning for tree walking or RSS reading (only tmux command for pane PIDs)
- [ ] Unit tests pass
- [ ] `go vet ./...` clean

## Files Modified

- `internal/resource/resource.go` — new package with process tree walker
- `internal/resource/resource_test.go` — unit tests
