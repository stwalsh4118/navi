# [11-7] Handle ANSI escape codes

[Back to task list](./tasks.md)

## Description

Process ANSI escape codes in captured tmux output. The implementation should either strip them for clean text display or render them as styled output.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-05 09:48:56 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-05 10:00:34 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-05 10:01:35 | Status Change | InProgress | Review | Implementation complete | AI_Agent |

## Requirements

- Handle ANSI escape sequences in captured pane output
- Option 1 (simpler): Strip all ANSI codes for plain text
- Option 2 (richer): Parse and render basic ANSI colors
- Ensure output displays correctly without garbled escape sequences
- Handle common sequences: colors, bold, reset, cursor movement

## Implementation Plan

**Recommended approach: Strip ANSI codes (simpler, more reliable)**

1. Create `stripANSI(input string) string` function in preview.go
2. Use regex to remove ANSI escape sequences:
   ```go
   var ansiRegex = regexp.MustCompile(`\x1b\[[0-9;]*[a-zA-Z]`)

   func stripANSI(input string) string {
       return ansiRegex.ReplaceAllString(input, "")
   }
   ```
3. Apply `stripANSI` to captured content before storing
4. Consider also stripping:
   - OSC sequences (title setting, etc.)
   - Other control characters

**Alternative approach (if colors desired):**

1. Research `muesli/termenv` or similar for ANSI parsing
2. Convert ANSI to lipgloss styles
3. This would require external package research

**External Packages**: If rendering ANSI colors, this task may require research and a guide document for: `muesli/termenv` or `charmbracelet/x/ansi`

## Test Plan

**Medium task - verify ANSI handling:**

- ANSI sequences are properly stripped
- Output displays without escape characters
- Colors and formatting codes removed
- Plain text content preserved
- Edge cases (malformed sequences) handled

## Verification

- [ ] `stripANSI` function implemented
- [ ] Captured output displays cleanly
- [ ] No escape characters visible in preview
- [ ] Plain text content intact
- [ ] Code quality checks pass
- [ ] Tests pass

## Files Modified

- `preview.go` - Added stripANSI function with regex patterns
- `sessions.go` - Updated capturePane to strip ANSI from output
- `preview_test.go` - Created with comprehensive TestStripANSI tests
