# [11-10] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification that all acceptance criteria for PBI-11 are met. This task validates the complete preview pane feature works as specified in the PRD.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-05 09:48:56 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-05 10:05:48 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-05 10:15:00 | Status Change | InProgress | Review | E2E tests complete, all passing | AI_Agent |

## Requirements

Verify all acceptance criteria from the PRD:

1. Press `p` or `Tab` toggles preview panel visibility
2. Preview shows last N lines of selected session's tmux output
3. Preview updates when cursor moves to different session
4. Preview updates periodically while visible
5. ANSI escape codes are handled (stripped or rendered)
6. Preview panel can be resized
7. Layout adapts to terminal size
8. Preview is disabled when terminal too narrow

## Implementation Plan

1. Create integration test file `e2e_preview_test.go`
2. Test each acceptance criterion:

**AC1: Toggle visibility**
- Send `p` key, verify `previewVisible` becomes true
- Send `p` again, verify `previewVisible` becomes false
- Verify `Tab` also toggles (when not in dialog)

**AC2: Shows last N lines**
- Mock/stub `capturePane` to return known content
- Verify preview content matches captured output
- Verify line count is configurable/correct

**AC3: Updates on cursor move**
- Move cursor down, verify capture triggered
- Verify new session's content shown

**AC4: Periodic updates**
- Advance time past poll interval
- Verify capture triggered

**AC5: ANSI handling**
- Provide input with ANSI codes
- Verify output has codes stripped

**AC6: Resizing**
- Send `]` key, verify width increased
- Send `[` key, verify width decreased
- Verify min/max constraints

**AC7: Terminal size adaptation**
- Set width below minimum
- Verify preview hidden
- Set width above minimum
- Verify preview shown (if user enabled)

**AC8: Narrow terminal handling**
- Set very narrow terminal
- Verify preview disabled
- Verify no crashes

## Test Plan

**Complex task - comprehensive E2E testing:**

All tests should run with `go test` and verify the integrated behavior of the preview pane feature against the PRD acceptance criteria.

## Verification

- [x] All acceptance criteria have corresponding tests
- [x] All tests pass
- [ ] Manual verification with real tmux sessions
- [x] Edge cases covered
- [x] Code quality checks pass

## Files Modified

- `e2e_preview_test.go` - Created comprehensive E2E tests for all 8 acceptance criteria

