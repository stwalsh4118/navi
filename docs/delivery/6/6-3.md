# [6-3] Implement settings.json merge

[Back to task list](./tasks.md)

## Description

Implement the portion of install.sh that reads Claude Code's settings.json, merges the hook configuration, and writes it back without destroying existing settings.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-05 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Read `~/.config/claude/settings.json` if it exists
2. Merge hook configuration (preserve existing hooks)
3. Write updated settings.json back
4. Create file if it doesn't exist
5. Use `jq` for JSON manipulation (safer than sed)

## Implementation Plan

Add to `install.sh`:
```bash
# Claude Code settings
CLAUDE_CONFIG_DIR="$HOME/.config/claude"
SETTINGS_FILE="$CLAUDE_CONFIG_DIR/settings.json"

mkdir -p "$CLAUDE_CONFIG_DIR"

# Hook configuration to merge
HOOK_CONFIG='{
  "hooks": {
    "Notification": [
      {"matcher": "", "hooks": [{"type": "command", "command": "~/.claude-sessions/hooks/notify.sh waiting"}]}
    ],
    "Stop": [
      {"hooks": [{"type": "command", "command": "~/.claude-sessions/hooks/notify.sh done"}]}
    ],
    "PreToolUse": [
      {"hooks": [{"type": "command", "command": "~/.claude-sessions/hooks/notify.sh permission"}]}
    ],
    "SubagentStop": [
      {"hooks": [{"type": "command", "command": "~/.claude-sessions/hooks/notify.sh working"}]}
    ]
  }
}'

if command -v jq &> /dev/null; then
    if [ -f "$SETTINGS_FILE" ]; then
        # Merge with existing settings
        jq -s '.[0] * .[1]' "$SETTINGS_FILE" <(echo "$HOOK_CONFIG") > "$SETTINGS_FILE.tmp"
        mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"
        echo "✓ Merged hooks into existing settings.json"
    else
        # Create new settings file
        echo "$HOOK_CONFIG" | jq '.' > "$SETTINGS_FILE"
        echo "✓ Created settings.json with hooks"
    fi
else
    echo "⚠ jq not found. Please install jq or manually add hooks to $SETTINGS_FILE"
    echo "Hook configuration saved to $SCRIPT_DIR/hooks/config.json"
fi
```

## Test Plan

- **Objective**: Verify settings merge works correctly
- **Test Scenarios**:
  1. No existing settings - creates new file
  2. Existing settings - merges without data loss
  3. jq not available - warning message
- **Success Criteria**: Hooks configured in Claude Code

## Verification

- [ ] Reads existing settings.json
- [ ] Merges hook configuration
- [ ] Preserves existing settings
- [ ] Handles missing file
- [ ] Handles missing jq

## Files Modified

- `install.sh`
