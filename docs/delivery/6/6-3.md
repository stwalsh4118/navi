# [6-3] Implement settings.json merge

[Back to task list](./tasks.md)

## Description

Implement the portion of install.sh that reads Claude Code's settings.json, merges the hook configuration, and writes it back without destroying existing settings.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-05 00:00:00 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. Read `~/.claude/settings.json` if it exists
2. Detect conflicts with existing hook configurations for: `Notification`, `Stop`, `PreToolUse`, `SubagentStop`
3. If no conflicts: merge automatically
4. If conflicts detected:
   - Display which hook types have existing configurations
   - Show the user's existing config for those hooks
   - Prompt with options:
     - **Override**: Replace conflicting hooks (backup to settings.json.bak first)
     - **Manual**: Save navi config to `~/.claude-sessions/hooks/config.json` with instructions
     - **Abort**: Exit without changes
5. Create file if it doesn't exist
6. Use `jq` for JSON manipulation (safer than sed)

## Implementation Plan

Add to `install.sh`:
```bash
# Claude Code settings
CLAUDE_CONFIG_DIR="$HOME/.claude"
SETTINGS_FILE="$CLAUDE_CONFIG_DIR/settings.json"
NAVI_CONFIG_FILE="$HOME/.claude-sessions/hooks/config.json"

mkdir -p "$CLAUDE_CONFIG_DIR"

# Hook types navi uses
HOOK_TYPES=("Notification" "Stop" "PreToolUse" "SubagentStop")

# Hook configuration to merge
HOOK_CONFIG='{
  "hooks": {
    "Notification": [
      {"matcher": "", "hooks": [{"type": "command", "command": "~/.claude-sessions/hooks/notify.sh waiting"}]}
    ],
    "Stop": [
      {"hooks": [{"type": "command", "command": "~/.claude-sessions/hooks/notify.sh done"}]}
    ],
    "PreToolUse": [
      {"hooks": [{"type": "command", "command": "~/.claude-sessions/hooks/notify.sh permission"}]}
    ],
    "SubagentStop": [
      {"hooks": [{"type": "command", "command": "~/.claude-sessions/hooks/notify.sh working"}]}
    ]
  }
}'

merge_hooks() {
    if ! command -v jq &> /dev/null; then
        echo "⚠ jq not found. Please install jq or use manual setup."
        save_for_manual
        return 1
    fi

    # If no settings file, create new one
    if [ ! -f "$SETTINGS_FILE" ]; then
        echo "$HOOK_CONFIG" | jq '.' > "$SETTINGS_FILE"
        echo "✓ Created settings.json with navi hooks"
        return 0
    fi

    # Check for conflicts
    local conflicts=()
    for hook_type in "${HOOK_TYPES[@]}"; do
        if jq -e ".hooks.$hook_type // empty | length > 0" "$SETTINGS_FILE" > /dev/null 2>&1; then
            conflicts+=("$hook_type")
        fi
    done

    # No conflicts - merge automatically
    if [ ${#conflicts[@]} -eq 0 ]; then
        jq -s '.[0] * .[1]' "$SETTINGS_FILE" <(echo "$HOOK_CONFIG") > "$SETTINGS_FILE.tmp"
        mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"
        echo "✓ Merged navi hooks into settings.json"
        return 0
    fi

    # Conflicts detected - prompt user
    echo ""
    echo "⚠ Existing hooks detected for: ${conflicts[*]}"
    echo ""
    echo "Your current hook configurations:"
    for hook_type in "${conflicts[@]}"; do
        echo "  $hook_type:"
        jq -r ".hooks.$hook_type | @json" "$SETTINGS_FILE" 2>/dev/null | sed 's/^/    /'
    done
    echo ""
    echo "Options:"
    echo "  1) Override - Replace with navi hooks (backup saved to settings.json.bak)"
    echo "  2) Manual   - Save navi config for manual merging"
    echo "  3) Abort    - Exit without changes"
    echo ""
    read -p "Choose [1/2/3]: " choice

    case $choice in
        1)
            cp "$SETTINGS_FILE" "$SETTINGS_FILE.bak"
            echo "✓ Backup saved to $SETTINGS_FILE.bak"
            jq -s '.[0] * .[1]' "$SETTINGS_FILE" <(echo "$HOOK_CONFIG") > "$SETTINGS_FILE.tmp"
            mv "$SETTINGS_FILE.tmp" "$SETTINGS_FILE"
            echo "✓ Replaced hooks with navi configuration"
            ;;
        2)
            save_for_manual
            ;;
        3)
            echo "Aborted. No changes made."
            return 1
            ;;
        *)
            echo "Invalid choice. No changes made."
            return 1
            ;;
    esac
}

save_for_manual() {
    echo "$HOOK_CONFIG" | jq '.' > "$NAVI_CONFIG_FILE"
    echo ""
    echo "✓ Navi hook config saved to: $NAVI_CONFIG_FILE"
    echo ""
    echo "To manually add navi hooks, merge the contents of that file into:"
    echo "  $SETTINGS_FILE"
    echo ""
    echo "You can append navi hooks to your existing hook arrays, or replace them."
}

merge_hooks
```

## Test Plan

- **Objective**: Verify settings merge with conflict detection works correctly
- **Test Scenarios**:
  1. No existing settings - creates new file automatically
  2. Existing settings, no hook conflicts - merges automatically
  3. Existing settings with conflicting hooks - prompts user
  4. User chooses override - backs up and replaces
  5. User chooses manual - saves config file with instructions
  6. User chooses abort - no changes made
  7. jq not available - falls back to manual setup
- **Success Criteria**: User-friendly conflict resolution, no data loss

## Verification

- [ ] Reads existing settings.json
- [ ] Detects conflicts with existing Notification, Stop, PreToolUse, SubagentStop hooks
- [ ] Shows existing config when conflicts detected
- [ ] Prompts user with 3 options on conflict
- [ ] Creates backup before override
- [ ] Saves config file for manual merging
- [ ] Handles missing settings file (creates new)
- [ ] Handles missing jq (manual fallback)

## Files Modified

- `install.sh`
