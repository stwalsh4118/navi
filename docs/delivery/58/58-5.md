# [58-5] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end tests verifying all PBI-58 acceptance criteria. Tests exercise the full flow from keybind to dialog rendering, pack selection, persistence, and edge cases.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-19 06:54:06 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

Verify all 8 acceptance criteria from the PBI:

1. **AC1**: Pressing `S` in session view opens a scrollable pack picker overlay listing all installed packs
2. **AC2**: Each pack shows name, event count, and file count
3. **AC3**: The currently active pack is visually marked
4. **AC4**: Selecting a pack with `Enter` hot-swaps it on the running Notifier (immediate effect)
5. **AC5**: The selection is persisted to `sounds.yaml` (survives restart)
6. **AC6**: Pressing `Esc` closes the picker without changing the pack
7. **AC7**: When no packs are installed, the picker shows a helpful message
8. **AC8**: Existing keybinds and audio functionality are unaffected

## Implementation Plan

**Files to create:**
- `internal/tui/e2e_soundpackpicker_test.go` — E2E test suite

**Test Scenarios:**

1. **Open/Close cycle**: Press `S` → verify dialog mode, press `Esc` → verify closed
2. **Pack list display**: Open picker with mock packs → verify View() contains all pack names, event counts, file counts
3. **Active marker**: Set activeSoundPack → verify checkmark in View() output for correct pack
4. **Navigation**: Open picker → press down/up → verify cursor movement and scroll
5. **Selection and hot-swap**: Press Enter on a pack → verify SetPack called, activeSoundPack updated, dialog closed
6. **Config persistence**: After Enter selection → verify SavePackSelection wrote correct YAML
7. **Esc preserves state**: Open picker, navigate, press Esc → verify activeSoundPack unchanged
8. **Empty state**: Open picker with no packs → verify empty message in View()
9. **S keybind blocked during dialog**: Open any other dialog → press S → verify no picker opens
10. **Existing keybinds unaffected**: Verify m, n, x, etc. still work in session view

**Test Setup:**
- Create temp soundpacks directory with 2-3 mock packs
- Create mock audio config
- Initialize Model with test notifier
- Use `tea.KeyMsg` simulation pattern from existing E2E tests

## Test Plan

This IS the test plan — comprehensive E2E coverage of all acceptance criteria.

## Verification

- [ ] `go test ./internal/tui/ -run TestSoundPackPicker -race -v` passes
- [ ] `go test ./internal/audio/ -race` passes (no regressions)
- [ ] `go vet ./...` clean
- [ ] All 8 acceptance criteria verified by named test functions

## Files Modified

_(to be filled during implementation)_
