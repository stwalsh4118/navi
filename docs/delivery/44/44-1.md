# 44-1: Extract session reading into shared package-level function

[Back to task list](./tasks.md)

## Description

The `readSessions()` function in `internal/tui/sessions.go` is unexported and coupled to the TUI package. Both the background monitor (task 44-2) and the CLI status command (task 44-4) need to read session status files. Extract this logic into an exported function in the `internal/session` package so it can be reused without importing the TUI.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-15 17:05:29 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-15 17:13:25 | Status Change | Proposed | Agreed | User requested implementation of PBI 44 | AI_Agent |
| 2026-02-15 17:13:25 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-15 17:15:57 | Status Change | InProgress | Review | Implementation complete | AI_Agent |
| 2026-02-15 17:29:50 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. Add `func ReadStatusFiles(dir string) ([]Info, error)` to `internal/session/` package
2. The function must read all `.json` files from the given directory and parse them into `session.Info` structs
3. Skip non-existent directories (return empty slice, nil error), unreadable files, and malformed JSON â€” same behavior as the current `readSessions()`
4. Update `internal/tui/sessions.go` to call `session.ReadStatusFiles()` instead of the local implementation
5. Remove the old unexported `readSessions()` from `internal/tui/sessions.go`
6. All existing tests must continue to pass

## Implementation Plan

1. Create `internal/session/status.go` with `func ReadStatusFiles(dir string) ([]Info, error)`
   - Move the logic from `tui.readSessions()` verbatim
   - Keep the same error handling semantics (skip on `os.IsNotExist`, skip malformed JSON)
2. Update `internal/tui/sessions.go`:
   - Replace the `readSessions(dir)` call in `pollSessions()` with `session.ReadStatusFiles(dir)`
   - Remove the old `readSessions()` function
3. Update any test files that reference `readSessions` directly
4. Run `go vet ./...` and `go test ./... -race`

## Test Plan

- Unit test `session.ReadStatusFiles()` with a temp directory containing valid, invalid, and mixed JSON files
- Unit test with non-existent directory returns empty slice, nil error
- Unit test with empty directory returns empty slice
- Verify existing TUI tests pass unchanged (they exercise `pollSessions` which now delegates)

## Verification

- `go vet ./...`
- `go test ./... -race`
- `coderabbit review --base main --plain`

## Files Modified

- `internal/session/status.go`
- `internal/session/status_test.go`
- `internal/tui/sessions.go`
- `docs/api-specs/session/session-api.md`
- `docs/delivery/44/44-1.md`
- `docs/delivery/44/tasks.md`
