# 44-4: Add navi status CLI command

[Back to task list](./tasks.md)

## Description

Add CLI argument detection to `cmd/navi/main.go` so that `navi status` runs a one-shot status summary instead of launching the TUI. The command reads session status files, counts sessions by status, and prints a summary line. Supports `--verbose` for full counts and `--format=tmux` for tmux-compatible output.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-15 17:05:29 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-15 17:21:33 | Status Change | Proposed | Agreed | User requested implementation of PBI 44 | AI_Agent |
| 2026-02-15 17:21:33 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-15 17:23:15 | Status Change | InProgress | Review | Implementation complete | AI_Agent |
| 2026-02-15 17:29:50 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. When `os.Args` contains `status` as the first argument, run the CLI command instead of the TUI
2. Create `internal/cli/status.go` with the status command logic:
   - `func RunStatus(args []string) int` â€” returns exit code
   - Parse flags: `--verbose`, `--format=tmux`
   - Read sessions from `session.StatusDir` via `session.ReadStatusFiles()`
   - Count sessions by status
3. **Default output** (priority alerts only):
   - Print sessions with `waiting` or `permission` status: `"1 waiting, 2 permission"`
   - Print empty string and exit 0 if no priority sessions
4. **`--verbose` output** (full counts):
   - Print all statuses with non-zero counts: `"3 working, 1 waiting, 2 permission, 1 idle"`
   - Print empty string and exit 0 if no sessions exist
5. **`--format=tmux` output**:
   - Same content as default/verbose but plain text (no special formatting)
   - This is functionally identical for now but the flag exists for forward compatibility
6. Update `cmd/navi/main.go` to dispatch: if `len(os.Args) > 1 && os.Args[1] == "status"`, call `cli.RunStatus(os.Args[2:])` and exit
7. Exit code 0 on success

## Implementation Plan

1. Create `internal/cli/status.go`:
   - Parse `--verbose` and `--format` flags from args using `flag.NewFlagSet`
   - Call `session.ReadStatusFiles(pathutil.ExpandPath(session.StatusDir))`
   - Build status counts map: `map[string]int`
   - Format output based on flags
   - Print to stdout and return 0
2. Create `internal/cli/status_test.go` with tests for formatting logic
3. Update `cmd/navi/main.go`:
   - Before `tea.NewProgram`, check `os.Args` for subcommands
   - Dispatch `status` to `cli.RunStatus()`
   - Use `os.Exit()` with returned code

## Test Plan

**Objective**: Verify CLI output formatting for all flag combinations.

- Unit test: Default mode with mixed sessions outputs only priority counts
- Unit test: Default mode with no priority sessions outputs empty string
- Unit test: Default mode with no sessions outputs empty string
- Unit test: `--verbose` mode outputs all status counts
- Unit test: `--verbose` mode with no sessions outputs empty string
- Unit test: `--format=tmux` produces same output as default (plain text)
- Unit test: Status count ordering is consistent (waiting before permission)
- Integration test: `RunStatus()` reads from a temp directory with real JSON files

## Verification

- `go vet ./...`
- `go test ./... -race`
- `coderabbit review --base main --plain` (failed: rate limit exceeded)

## Files Modified

- `cmd/navi/main.go`
- `internal/cli/status.go`
- `internal/cli/status_test.go`
- `docs/api-specs/cli/cli-api.md`
- `docs/api-specs/README.md`
- `docs/delivery/44/44-4.md`
- `docs/delivery/44/tasks.md`
