# 44-5: E2E CoS verification tests

[Back to task list](./tasks.md)

## Description

Comprehensive end-to-end tests verifying all PBI-44 acceptance criteria. These tests exercise the full lifecycle: monitor start on attach, audio notification during attach, clean stop on detach, state handoff, CLI output formatting, and the no-duplicate-notification guarantee.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-15 17:05:29 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-15 17:23:36 | Status Change | Proposed | Agreed | User requested implementation of PBI 44 | AI_Agent |
| 2026-02-15 17:23:36 | Status Change | Agreed | InProgress | Started implementation | AI_Agent |
| 2026-02-15 17:26:09 | Status Change | InProgress | Review | Implementation complete | AI_Agent |
| 2026-02-15 17:29:50 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

Verify ALL acceptance criteria from the PBI:

1. **AC1**: Background goroutine starts on attach and polls session files, triggering audio notifications
2. **AC2**: Background goroutine stops cleanly on detach with no resource leaks
3. **AC3**: No duplicate notifications — state handoff prevents re-firing transitions
4. **AC4**: `navi status` prints priority session summary and exits 0
5. **AC5**: `navi status --verbose` prints full counts
6. **AC6**: `navi status --format=tmux` outputs plain text
7. **AC7**: Empty output when no sessions need attention / no sessions exist
8. **AC8**: Background monitor handles both local and remote session status files
9. **AC9**: All existing tests pass, new tests cover monitor lifecycle and CLI formatting

## Implementation Plan

1. Create `internal/monitor/monitor_e2e_test.go`:
   - `TestAttachMonitorNotifiesOnStatusChange` — write session files to temp dir, start monitor, change a status, verify notification fires (AC1)
   - `TestAttachMonitorStopsCleanly` — start monitor, cancel context, verify goroutine exits and States() returns final state (AC2)
   - `TestAttachMonitorStateHandoff` — simulate TUI → monitor → TUI state handoff, verify no duplicate notification on the same transition (AC3)
   - `TestAttachMonitorWithRemoteSessions` — include session files with `remote` field set, verify they're tracked (AC8)
2. Create `internal/tui/e2e_monitor_test.go`:
   - `TestAttachStartsMonitor` — press Enter, verify `m.attachMonitor` is set
   - `TestDetachStopsMonitorAndHandsOffState` — simulate `attachDoneMsg`, verify monitor nil and states transferred
   - `TestNoDuplicateNotificationsAcrossAttachCycle` — full cycle: detect change in TUI, attach, same session changes in monitor, detach, verify TUI doesn't re-fire
3. Create `internal/cli/status_e2e_test.go`:
   - `TestStatusDefaultOutput` — verify priority-only output (AC4)
   - `TestStatusVerboseOutput` — verify full counts (AC5)
   - `TestStatusTmuxFormat` — verify plain text output (AC6)
   - `TestStatusEmptyOutput` — verify empty when no priority / no sessions (AC7)
4. Run `go test ./... -race` to verify no race conditions
5. Run `go vet ./...` for clean static analysis
6. Verify all pre-existing tests still pass

## Test Plan

### Objectives
Validate all 9 acceptance criteria through automated tests.

### Test Scope
- E2E tests for the monitor start/stop/handoff lifecycle
- Integration tests for TUI attach flow with monitor
- Integration tests for CLI status command output
- Regression tests ensuring no breakage of existing functionality

### Environment & Setup
- Temp directories with mock session JSON files
- Mock `audio.Notifier` with callback to track notifications
- Use `Model` with test audio hook (`audioNotifyFn`) for TUI tests

### Key Scenarios

1. **Happy path**: Attach → monitor runs → session changes → audio fires → detach → state handed back
2. **No-duplicate guarantee**: Session changes during attach → monitor fires → detach → TUI polls → no re-fire
3. **CLI default**: Priority sessions present → correct output. No priority → empty.
4. **CLI verbose**: All sessions → full counts. No sessions → empty.
5. **Remote sessions**: Status files with `remote` field included in monitor polling and CLI counts
6. **Clean shutdown**: Context cancelled → goroutine exits → States() returns valid data

### Success Criteria
- All new tests pass
- All existing tests pass (`go test ./... -race`)
- `go vet ./...` clean
- No race conditions detected

## Verification

- `go vet ./...`
- `go test ./... -race`
- `coderabbit review --base main --plain` (failed: rate limit exceeded)

## Files Modified

- `internal/monitor/monitor_e2e_test.go`
- `internal/tui/e2e_monitor_test.go`
- `internal/cli/status_e2e_test.go`
- `docs/delivery/44/44-5.md`
- `docs/delivery/44/tasks.md`
