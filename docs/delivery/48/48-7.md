# [48-7] Trigger System and TUI Integration

[Back to task list](./tasks.md)

## Description

Wire the PM invoker into the TUI message loop. Implement trigger evaluation that decides when to invoke the PM (on `task_completed`, `commit`, or `on_demand`), event accumulation between invocations, and async goroutine execution so the TUI never blocks. This connects all the pieces from tasks 48-1 through 48-6 into the running application.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 08:53:42 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 09:50:46 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 09:57:14 | Status Change | InProgress | Review | Implementation complete, internal AI review passed (0 critical, 0 high, 1 medium resolved, 4 low deferred) | AI_Agent |
| 2026-02-18 13:05:37 | Status Change | Review | Done | Task completed and verified. Added streaming status display, cached briefing on startup, content-aware briefing layout, scroll fixes, 60s poll interval. | AI_Agent |

## Requirements

1. **Trigger evaluation**: After each `Engine.Run()`, scan new events. If any event is `task_completed` or `commit`, trigger PM invocation.
2. **On-demand trigger**: User presses a key in PM view (extend existing `r` refresh or add dedicated key) to trigger immediate PM invocation.
3. **Event accumulation**: Events that don't trigger invocation (e.g., `session_status_change`, `branch_created`) accumulate in the event log and are included in the next triggered invocation's inbox.
4. **Async execution**: PM invocation runs in a goroutine via a Bubble Tea command. Returns result via message channel. TUI is never blocked.
5. **In-flight guard**: Only one PM invocation at a time. If already running, skip new triggers (events will be picked up next time).
6. **TUI messages**: Define `pmInvokeMsg` carrying `*PMBriefing`, `isStale bool`, and `error`.
7. **Model integration**: Store `pmBriefing *PMBriefing`, `pmBriefingStale bool`, `pmInvoker *Invoker` in the TUI model. Update on `pmInvokeMsg`.
8. **Startup**: Initialize `Invoker` in TUI `New()`. Do NOT invoke on startup — wait for first trigger or user demand.
9. **Staleness display**: When `pmBriefingStale` is true, the PM view should indicate the output is from cache (visual indicator handled by PBI-49, but the flag must be available).
10. PM invocation does not replace the existing `Engine.Run()` cycle — it runs alongside it, triggered by engine output.

## Implementation Plan

1. Add `pmInvoker *pm.Invoker`, `pmBriefing *pm.PMBriefing`, `pmBriefingStale bool`, `pmInvokeInFlight bool` to TUI `Model`.
2. Create `pmInvokeCmd()` — Bubble Tea command that runs `InvokeWithRecovery()` in a goroutine.
3. Define `pmInvokeMsg` struct.
4. In `Update()`, handle `pmOutputMsg` (from engine): scan events for trigger types, launch `pmInvokeCmd` if triggered and not in-flight.
5. In `Update()`, handle `pmInvokeMsg`: store briefing, set stale flag, clear in-flight.
6. Wire on-demand trigger to key press in PM view.
7. Initialize invoker in `New()` — call `NewInvoker()`.
8. Pass current snapshots and events to `BuildInbox()` before invocation.

## Test Plan

- **Objectives**: Verify trigger evaluation, async execution, and in-flight guard.
- **Key Scenarios**:
  1. `task_completed` event in engine output → PM invocation triggered.
  2. `commit` event → PM invocation triggered.
  3. `session_status_change` event only → no PM invocation (events accumulate).
  4. On-demand key press → PM invocation triggered.
  5. In-flight guard: second trigger while first running → skipped.
  6. Async: TUI remains responsive during invocation (goroutine-based).
  7. Result delivery: `pmInvokeMsg` updates model fields correctly.
  8. Staleness: failed invocation sets `pmBriefingStale = true`.
- **Success Criteria**: Triggers fire correctly; TUI never blocks; in-flight guard prevents concurrent invocations; briefing and stale flag update correctly.

## Verification

- All 17 new tests pass + all existing TUI tests pass
- `go test -race ./internal/tui/` passes
- `go vet ./...` clean
- AI review: 0 critical, 0 high, 1 medium (resolved — pmLastError not cleared on success), 4 low (deferred: silent invoker init failure, first-match trigger semantics, stub invoker in tests, shared error field)

## Files Modified

- `internal/tui/model.go` (modified) — Added pmInvoker, pmBriefing, pmBriefingStale, pmInvokeInFlight fields; pmInvokeMsg type; trigger scanning in pmOutputMsg handler; pmInvokeMsg handler; initPMInvoker()
- `internal/tui/pm.go` (modified) — Added pmTriggerEvents map, pmInvokeCmd(), pmCheckTrigger()
- `internal/tui/pmview.go` (modified) — Added `i` key handler for on-demand invoke; updated renderPMBriefing to show actual briefing, stale indicator, attention items
- `internal/tui/pm_invoke_test.go` (new) — 17 tests covering triggers, invocation, in-flight guard, rendering
