# [48-4] Claude CLI Invoker Core

[Back to task list](./tasks.md)

## Description

Implement the core invoker that shells out to `claude -p` via `exec.Command`. This handles the full invocation lifecycle: assembling CLI flags, piping the inbox JSON to stdin, capturing stdout, and managing the first-run vs resume flow (first invocation creates a new session; subsequent invocations resume it).

This is the central piece of PBI-48 — the bridge between Navi's event pipeline and the Claude LLM.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 08:53:42 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. `Invoker` struct holds config: storage paths, system prompt path, output schema path.
2. `NewInvoker()` creates an Invoker, calls `EnsureStorageLayout()`.
3. `Invoke(inbox *InboxPayload) (*InvokeResult, error)` — the main entry point.
4. CLI flag assembly:
   - `claude -p` (print/pipe mode)
   - `--output-format json` (structured output)
   - `--json-schema <path>` (output schema file path)
   - `--allowedTools Read,Edit,Write` (memory file management)
   - `--system-prompt <path>` (system prompt file path, first run only, or appropriate flag for resume)
   - `--resume <session-id>` (subsequent invocations only)
5. First-run flow: no `--resume`, capture session ID from Claude's JSON output, write via `WriteSessionID()`.
6. Resume flow: include `--resume <id>` flag.
7. Inbox JSON is piped via stdin.
8. `InvokeResult` struct: `Output *PMBriefing`, `SessionID string`, `Raw []byte`, `ExitCode int`, `IsFirstRun bool`.
9. The invoker must NOT block — callers are responsible for goroutine wrapping (handled in 48-7).
10. Timeout: configurable, default 60 seconds via `context.Context`.

## Implementation Plan

1. Create `internal/pm/invoker.go` with `Invoker` struct and `NewInvoker()`.
2. Implement `buildArgs()` — assembles CLI arguments based on first-run vs resume state.
3. Implement `Invoke()`:
   a. Serialize inbox to JSON.
   b. Build command with `exec.CommandContext()`.
   c. Set stdin to inbox JSON bytes.
   d. Capture stdout and stderr.
   e. Run command.
   f. On success: extract session ID if first run, return raw output.
   g. On failure: return error with exit code and stderr.
4. Session ID extraction: parse Claude's JSON output for the `session_id` field (present in first-run response).
5. Keep this task focused on the happy path — error recovery is in 48-6.

**External Packages**: This task requires research and a guide document for: Claude CLI (`claude -p` flags and JSON output format).

## Test Plan

- **Objectives**: Verify CLI flag assembly, stdin piping, and session ID extraction.
- **Mocking Strategy**: Mock `exec.Command` via a test helper that returns canned JSON responses. Use a wrapper interface or function variable for command creation to enable testing without real CLI calls.
- **Key Scenarios**:
  1. First-run invocation: no session ID → builds args without `--resume`, extracts session ID from response.
  2. Resume invocation: session ID exists → builds args with `--resume <id>`.
  3. Flag assembly: verify all flags present and correctly ordered.
  4. Stdin piping: verify inbox JSON is written to command's stdin.
  5. Timeout: context cancellation terminates the command.
- **Success Criteria**: All flag combinations are correct; session ID is captured on first run; resume flow uses stored ID.

## Verification

_To be filled during implementation._

## Files Modified

_To be filled during implementation._
