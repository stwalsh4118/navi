# [48-5] Output Parsing and Caching

[Back to task list](./tasks.md)

## Description

Parse Claude's JSON response into the `PMBriefing` struct and manage the output cache (`last-output.json`). The cache serves as the fallback when the invoker fails, providing the last known good output with a staleness indicator.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 08:53:42 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 09:10:03 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 09:12:21 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 13:05:37 | Status Change | Review | Done | Task completed and verified. Added direct JSON briefing parsing, markdown-with-embedded-JSON extraction, and Breadcrumb.Timestamp as string for flexible parsing. | AI_Agent |

## Requirements

1. `ParseOutput(raw []byte) (*PMBriefing, error)` — extracts `structured_output` (or `result`) from Claude's JSON response envelope and unmarshals into `PMBriefing`.
2. Claude's JSON response has an outer envelope with metadata; the actual structured output is nested. Parser must handle this.
3. `CacheOutput(briefing *PMBriefing) error` — writes to `~/.config/navi/pm/last-output.json` atomically (temp + rename).
4. `LoadCachedOutput() (*CachedOutput, error)` — reads last-output.json, returns the briefing plus the cache timestamp.
5. `CachedOutput` struct: `Briefing *PMBriefing`, `CachedAt time.Time`, `IsStale bool`.
6. Staleness is determined by the caller (48-6/48-7) based on whether the current invocation failed — this task just provides the plumbing.
7. Missing cache file returns nil with no error (first run has no cache).

## Implementation Plan

1. Create `internal/pm/output.go` with parsing and caching functions.
2. `ParseOutput()`: unmarshal outer JSON, extract structured output field, unmarshal into PMBriefing.
3. `CacheOutput()`: wrap briefing in `CachedOutput` with timestamp, marshal to JSON, atomic write.
4. `LoadCachedOutput()`: read file, unmarshal, return. Handle missing file gracefully.
5. The `last-output.json` format: `{"briefing": {...}, "cached_at": "2026-02-18T..."}`.

## Test Plan

- **ParseOutput**: Valid Claude JSON response → correct PMBriefing fields populated.
- **ParseOutput malformed**: Invalid JSON → returns descriptive error.
- **ParseOutput missing fields**: Partial structured output → populates available fields, zeros for missing.
- **Cache round-trip**: CacheOutput → LoadCachedOutput returns same briefing data with valid timestamp.
- **Missing cache**: LoadCachedOutput on empty directory returns nil, nil.
- **Atomic write**: Verify no partial files on concurrent access (write to temp, rename).

## Verification

- `go test ./internal/pm` passed.
- Verified `ParseOutput` supports `structured_output` and `result` envelopes, including nested/string payloads.
- Verified malformed JSON returns errors and partial output maps into `PMBriefing` with zero-value defaults.
- Verified cache round-trip and missing-cache behavior (`nil, nil`).
- Verified atomic write path via temp file + rename and no leftover temp files in concurrent writes.
- Internal AI review gate verdict: `pass` (no critical/high findings).

## Files Modified

- `internal/pm/output.go`
- `internal/pm/output_test.go`
