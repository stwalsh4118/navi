# [48-5] Output Parsing and Caching

[Back to task list](./tasks.md)

## Description

Parse Claude's JSON response into the `PMBriefing` struct and manage the output cache (`last-output.json`). The cache serves as the fallback when the invoker fails, providing the last known good output with a staleness indicator.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 08:53:42 | Created | N/A | Proposed | Task file created | AI_Agent |

## Requirements

1. `ParseOutput(raw []byte) (*PMBriefing, error)` — extracts `structured_output` (or `result`) from Claude's JSON response envelope and unmarshals into `PMBriefing`.
2. Claude's JSON response has an outer envelope with metadata; the actual structured output is nested. Parser must handle this.
3. `CacheOutput(briefing *PMBriefing) error` — writes to `~/.config/navi/pm/last-output.json` atomically (temp + rename).
4. `LoadCachedOutput() (*CachedOutput, error)` — reads last-output.json, returns the briefing plus the cache timestamp.
5. `CachedOutput` struct: `Briefing *PMBriefing`, `CachedAt time.Time`, `IsStale bool`.
6. Staleness is determined by the caller (48-6/48-7) based on whether the current invocation failed — this task just provides the plumbing.
7. Missing cache file returns nil with no error (first run has no cache).

## Implementation Plan

1. Create `internal/pm/output.go` with parsing and caching functions.
2. `ParseOutput()`: unmarshal outer JSON, extract structured output field, unmarshal into PMBriefing.
3. `CacheOutput()`: wrap briefing in `CachedOutput` with timestamp, marshal to JSON, atomic write.
4. `LoadCachedOutput()`: read file, unmarshal, return. Handle missing file gracefully.
5. The `last-output.json` format: `{"briefing": {...}, "cached_at": "2026-02-18T..."}`.

## Test Plan

- **ParseOutput**: Valid Claude JSON response → correct PMBriefing fields populated.
- **ParseOutput malformed**: Invalid JSON → returns descriptive error.
- **ParseOutput missing fields**: Partial structured output → populates available fields, zeros for missing.
- **Cache round-trip**: CacheOutput → LoadCachedOutput returns same briefing data with valid timestamp.
- **Missing cache**: LoadCachedOutput on empty directory returns nil, nil.
- **Atomic write**: Verify no partial files on concurrent access (write to temp, rename).

## Verification

_To be filled during implementation._

## Files Modified

_To be filled during implementation._
