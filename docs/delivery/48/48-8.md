# [48-8] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification of all 10 acceptance criteria for PBI-48. Tests the full PM agent pipeline from initialization through invocation, output parsing, caching, error recovery, and TUI integration.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 08:53:42 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 09:57:42 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 10:05:01 | Status Change | InProgress | Review | Implementation complete, AI review finding resolved (renamed export file), all 10 ACs verified | AI_Agent |
| 2026-02-18 13:05:37 | Status Change | Review | Done | Task completed and verified. Updated integration tests for fresh-session design (removed AC2 session capture, AC3 resume, AC9 session re-init tests; replaced with fresh-session tests). | AI_Agent |

## Requirements

Verify each acceptance criterion from the PBI PRD:

1. **AC1 — Initialization**: First-run creates `~/.config/navi/pm/` directory structure, seeds `short-term.md` and `long-term.md` with empty templates, writes `system-prompt.md` and `output-schema.json`.
2. **AC2 — First invocation**: Runs `claude -p` without `--resume`, captures session ID, writes to `session_id` file.
3. **AC3 — Resume**: Subsequent invocations use `--resume` with stored session ID.
4. **AC4 — Inbox**: Inbox JSON includes timestamp, trigger type, events since last invocation, and current project state snapshot.
5. **AC5 — Output parsing**: Output parsed into PMBriefing struct (briefing, projects, attention_items, breadcrumbs) and cached to `last-output.json`.
6. **AC6 — Trigger events**: PM invoked on `task_completed` and `commit` triggers; other events accumulate.
7. **AC7 — On-demand**: On-demand trigger works when user requests refresh.
8. **AC8 — Failure fallback**: Non-zero exit or parse failure falls back to last successful output with staleness indicator.
9. **AC9 — Session re-init**: Corrupted `--resume` session triggers re-initialization; memory files persist.
10. **AC10 — Async**: PM invocation runs in a goroutine — TUI responsiveness is unaffected.

## Implementation Plan

1. Create `test/integration/pm_invoker_test.go` for integration tests.
2. Use a mock Claude CLI (shell script or test binary) that returns canned responses to avoid real Claude API calls.
3. Test initialization flow end-to-end with real filesystem (temp directory).
4. Test invocation flow with mock CLI: first run → resume → failure → recovery.
5. Test trigger evaluation with synthetic events.
6. Test async behavior with goroutine and channel timing.

## Test Plan

### Objectives
Verify all 10 acceptance criteria hold in an integrated context.

### Environment & Setup
- Temp directory as `~/.config/navi/pm/` root (override via test config).
- Mock Claude CLI binary that simulates various response scenarios.
- Pre-seeded event log with test events.

### Mocking Strategy
- Mock Claude CLI via a test script that reads stdin, validates it contains expected inbox JSON, and returns canned structured output.
- Use environment variable or config to point invoker at mock binary instead of real `claude`.

### Key Scenarios

| # | Scenario | Acceptance Criteria | Expected Outcome |
|---|----------|-------------------|------------------|
| 1 | Fresh start, no prior state | AC1 | All dirs and seed files created |
| 2 | First invocation with mock CLI | AC2 | Session ID captured and written |
| 3 | Second invocation | AC3 | `--resume` flag included with correct session ID |
| 4 | Inbox payload validation | AC4 | JSON contains timestamp, trigger, events, snapshots |
| 5 | Successful output parsing | AC5 | PMBriefing populated, last-output.json written |
| 6 | Trigger evaluation | AC6 | task_completed/commit trigger invocation; status_change does not |
| 7 | On-demand invocation | AC7 | Invocation fires without trigger events |
| 8 | CLI returns non-zero | AC8 | Cached output returned, stale=true |
| 9 | Resume corruption | AC9 | Session ID deleted, retried as first run, memory files intact |
| 10 | Concurrent TUI interaction | AC10 | Invocation runs in goroutine, model updates via message |

### Success Criteria
- All 10 scenarios pass.
- No race conditions detected under `-race`.
- `go vet` clean.

## Verification

- 9 integration E2E tests covering AC1-AC6, AC8-AC9, plus full pipeline lifecycle
- AC7 (on-demand) and AC10 (async) verified via TUI unit tests in `internal/tui/pm_invoke_test.go`
- `go test -race ./test/integration/pm/` passes
- `go test -race ./internal/tui/` passes
- `go test -race ./internal/pm/` passes
- `go vet ./...` clean
- `go build ./...` clean (no test exports leak into production binary)
- AI review: resolved 1 high (renamed export file to avoid leaking test helpers to binary), 5 low deferred

## Files Modified

- `test/integration/pm/invoker_test.go` (new) — 9 E2E tests covering ACs 1-6, 8-9, full pipeline
- `internal/tui/pm_invoke_test.go` (previously added in 48-7) — covers AC7, AC10
