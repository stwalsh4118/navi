# [48-3] Inbox Construction

[Back to task list](./tasks.md)

## Description

Build the JSON inbox payload that gets piped to Claude as the user prompt on each invocation. The inbox combines accumulated events from the event log, current project snapshots, the trigger type, and a timestamp into the `InboxPayload` struct defined in task 48-1.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 08:53:42 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 09:08:20 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 09:09:50 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 13:05:37 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

1. `BuildInbox(trigger TriggerType, snapshots []ProjectSnapshot, events []Event) (*InboxPayload, error)` — constructs the payload.
2. Timestamp is `time.Now().UTC()` at construction time.
3. Events are read from the JSONL event log via existing `ReadEvents()`.
4. Snapshots come from the latest `Engine.Run()` output.
5. The serialized JSON must be compact (no indentation) to minimize token usage.
6. `InboxToJSON(inbox *InboxPayload) ([]byte, error)` — serializes to JSON bytes for piping to stdin.
7. Empty events list and empty snapshots list are both valid (first run may have no events).

## Implementation Plan

1. Add `BuildInbox()` and `InboxToJSON()` functions to `internal/pm/inbox.go` (extending the file from 48-1).
2. BuildInbox populates all fields from parameters and sets timestamp.
3. InboxToJSON uses `json.Marshal` (compact format).
4. Unit tests verify JSON structure and field presence.

## Test Plan

- **BuildInbox**: Verify all fields populated correctly from inputs.
- **Empty inputs**: BuildInbox with no events and no snapshots produces valid payload with empty arrays.
- **JSON serialization**: InboxToJSON produces valid, parseable JSON with expected keys.
- **Timestamp**: Verify timestamp is populated and in UTC.

## Verification

- `go test ./internal/pm` passed.
- Verified `BuildInbox` populates trigger, timestamp (UTC), events, and snapshots.
- Verified empty inputs serialize as valid payload with empty arrays.
- Verified `InboxToJSON` outputs compact parseable JSON with required keys.
- Internal AI review gate verdict: `pass` (no critical/high findings).

## Files Modified

- `internal/pm/inbox.go`
- `internal/pm/inbox_test.go`
