# [48-2] PM Storage Initialization and Session Management

[Back to task list](./tasks.md)

## Description

Implement the storage layer that manages the PM's file-based state under `~/.config/navi/pm/`. This includes creating the directory structure on first run, seeding empty memory files, writing embedded templates to disk, and providing read/write accessors for the session ID file.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-18 08:53:42 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-18 09:05:18 | Status Change | Proposed | InProgress | Started implementation | AI_Agent |
| 2026-02-18 09:08:08 | Status Change | InProgress | Review | Implementation complete, internal AI review passed | AI_Agent |
| 2026-02-18 13:05:37 | Status Change | Review | Done | Task completed and verified. Session ID infrastructure removed — memory files provide continuity without session state. | AI_Agent |

## Requirements

1. `EnsureStorageLayout()` creates `~/.config/navi/pm/`, `~/.config/navi/pm/memory/`, `~/.config/navi/pm/memory/projects/`, and `~/.config/navi/pm/snapshots/` directories if missing.
2. On first run (no `session_id` file), seed `memory/short-term.md` and `memory/long-term.md` with empty templates.
3. Write `system-prompt.md` and `output-schema.json` from embedded templates (always overwrite — these are code-controlled).
4. `IsFirstRun()` returns true when `~/.config/navi/pm/session_id` does not exist.
5. `ReadSessionID()` returns the stored session ID string (trimmed) or empty string if missing.
6. `WriteSessionID(id string)` writes the session ID atomically (temp file + rename).
7. `DeleteSessionID()` removes the session ID file (used for re-initialization on corruption).
8. All paths use `pathutil.ExpandPath()` for tilde expansion.
9. Memory files persist across re-initialization (only `session_id` is deleted on corruption).

## Implementation Plan

1. Create `internal/pm/storage.go` with all storage functions.
2. Define package-level path constants: `pmDir`, `memoryDir`, `projectsMemoryDir`, `snapshotsDir`, `sessionIDFile`, `systemPromptFile`, `outputSchemaFile`, `lastOutputFile`, `shortTermMemFile`, `longTermMemFile`.
3. Implement `EnsureStorageLayout()` — `os.MkdirAll` for directories, seed memory files only if they don't exist, always write template files.
4. Implement `IsFirstRun()` — check `os.Stat` on session ID file.
5. Implement `ReadSessionID()` / `WriteSessionID()` / `DeleteSessionID()`.
6. Use atomic write pattern (write to `.tmp`, rename) for session ID to avoid partial reads.

## Test Plan

- **EnsureStorageLayout**: Call on empty temp directory; verify all subdirectories, memory files, and template files are created.
- **Idempotency**: Call EnsureStorageLayout twice; verify no errors and no file corruption.
- **Memory persistence**: Call EnsureStorageLayout, write content to memory files, call again — verify content is preserved.
- **Session ID round-trip**: WriteSessionID → ReadSessionID verifies same value.
- **IsFirstRun**: True before WriteSessionID, false after.
- **DeleteSessionID**: After deletion, IsFirstRun returns true, ReadSessionID returns empty.

## Verification

- `go test ./internal/pm` passed.
- Verified storage layout directory/file creation and idempotency.
- Verified memory file persistence and first-run-only seeding behavior.
- Verified session ID round-trip, delete behavior, and atomic temp-file cleanup.
- Internal AI review gate verdict: `pass` (no critical/high findings).

## Files Modified

- `internal/pm/storage.go`
- `internal/pm/storage_test.go`
