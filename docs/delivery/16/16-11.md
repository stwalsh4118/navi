# [16-11] E2E CoS Test

[Back to task list](./tasks.md)

## Description

End-to-end verification of all PBI-16 acceptance criteria. Create comprehensive tests that verify git integration works correctly across all features: display, caching, detail view, diff preview, and PR links.

## Status History

| Timestamp | Event Type | From Status | To Status | Details | User |
|-----------|------------|-------------|-----------|---------|------|
| 2026-02-05 11:30:11 | Created | N/A | Proposed | Task file created | AI_Agent |
| 2026-02-05 12:30:00 | Status Change | Proposed | InProgress | Started E2E test implementation | AI_Agent |
| 2026-02-05 12:35:00 | Status Change | InProgress | Review | E2E tests complete, all passing | AI_Agent |
| 2026-02-05 12:45:00 | Status Change | Review | Done | Task completed and verified | AI_Agent |

## Requirements

Verify all acceptance criteria from PBI-16:

1. Branch name displayed for sessions in git repos
2. Dirty/clean status indicator shown
3. Ahead/behind remote count displayed
4. GitHub PR detected from branch name (when applicable)
5. `G` opens git detail view with full info
6. Diff preview available for uncommitted changes
7. PR number links to GitHub (can open in browser)
8. Git info cached and updated periodically (not every poll)
9. Non-git directories handled gracefully

## Implementation Plan

1. Create `e2e_git_test.go` test file
2. Test git info display in session rows:
   - Session with git info shows branch line
   - Session without git info has no branch line
   - Dirty indicator appears correctly
   - Ahead/behind counts displayed
3. Test git detail view:
   - G key opens view for git session
   - G key shows message for non-git session
   - All info displayed correctly
   - Esc closes view
4. Test diff preview:
   - d key shows diff in git detail view
   - Diff content rendered correctly
5. Test PR link:
   - PR detected from branch pattern
   - Link displayed in detail view
6. Test caching:
   - Git info not fetched on every main poll
   - Git info refreshed on git poll interval
7. Test edge cases:
   - Non-git directory
   - Detached HEAD
   - No remote configured
   - Clean repository

## Test Plan

This task IS the test plan for PBI-16. All tests must pass to verify acceptance criteria are met.

**Test Categories:**

1. **Display Tests**
   - Git info line renders correctly
   - Styling applied appropriately
   - Truncation works for long branch names

2. **Collection Tests**
   - Git commands return expected data
   - Non-git directories handled
   - Error cases handled gracefully

3. **Caching Tests**
   - Cache populated on git poll
   - Cache merged with session data
   - Stale cache entries removed

4. **Detail View Tests**
   - View opens and closes correctly
   - All information displayed
   - Keybindings work

5. **Diff Tests**
   - Diff stat retrieved correctly
   - Diff rendered in view
   - Large diffs handled

6. **PR Link Tests**
   - GitHub remote detected
   - Branch pattern extracts number
   - URL constructed correctly

## Verification

- [x] All acceptance criteria tested
- [x] Branch display test passes
- [x] Dirty indicator test passes
- [x] Ahead/behind test passes
- [x] PR detection test passes
- [x] Git detail view test passes
- [x] Diff preview test passes
- [x] PR link test passes
- [x] Caching test passes
- [x] Non-git handling test passes
- [x] All tests pass
- [x] Code quality checks pass

## Files Modified

- `e2e_git_test.go` - Created comprehensive E2E tests for all PBI-16 acceptance criteria
